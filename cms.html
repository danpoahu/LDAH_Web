<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LDAH CMS - Content Management</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary-blue: #004E7C;
      --light-blue: #0066a1;
      --accent-teal: #4DD0E1;
      --bg-light: #f8f9fa;
      --text-dark: #1a1a1a;
      --text-light: #666;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --danger: #dc3545;
      --success: #28a745;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      line-height: 1.5;
      margin: 0;
      padding: 0;
    }
    
    button, input, select, textarea {
      font-family: inherit;
    }
    
    #loginScreen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #004E7C 0%, #0066a1 100%);
    }
    
    .login-box {
      background: white;
      padding: 3rem;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
    }
    
    .login-box h1 {
      color: var(--primary-blue);
      margin-bottom: 0.5rem;
      font-size: 2rem;
    }
    
    .login-box p {
      color: var(--text-light);
      margin-bottom: 2rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-dark);
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
      font-family: inherit;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-blue);
    }
    
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .btn {
      width: 100%;
      padding: 1rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #004E7C, #0066a1);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,78,124,0.3);
    }
    
    .error-message {
      background: #fee;
      color: #c00;
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: none;
    }
    
    #cmsPanel {
      display: none;
    }
    
    .cms-header {
      background: white;
      padding: 1.5rem 2rem;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .cms-header h1 {
      color: var(--primary-blue);
      font-size: 1.5rem;
    }
    
    .cms-header .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .btn-logout {
      padding: 0.5rem 1rem;
      background: var(--text-light);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .cms-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 2rem;
    }
    
    .cms-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid #ddd;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 1rem 1.5rem;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-light);
      transition: all 0.3s;
    }
    
    .tab.active {
      color: var(--primary-blue);
      border-bottom-color: var(--primary-blue);
    }
    
    .tab:hover {
      color: var(--primary-blue);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .content-section {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }
    
    .content-section h2 {
      color: var(--primary-blue);
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
    }
    
    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: none;
    }
    
    .preview-button {
      padding: 0.75rem 1.5rem;
      background: white;
      color: var(--primary-blue);
      border: 2px solid var(--primary-blue);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
    }
    
    .preview-button:hover {
      background: var(--primary-blue);
      color: white;
    }
    
    /* Team/Board Grid */
    .people-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .person-card {
      background: #f8f9fa;
      border: 2px solid #ddd;
      border-radius: 12px;
      padding: 1.5rem;
      position: relative;
      transition: all 0.3s;
      cursor: grab;
    }
    
    .person-card:hover {
      border-color: var(--primary-blue);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .person-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .person-card.drag-over {
      border-color: var(--accent-teal);
      background: #e8f4f8;
    }
    
    .person-card-header {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .person-photo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary-blue);
      flex-shrink: 0;
    }
    
    .person-photo-placeholder {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      flex-shrink: 0;
      border: 3px solid var(--primary-blue);
    }
    
    .person-info h4 {
      color: var(--primary-blue);
      margin-bottom: 0.25rem;
    }
    
    .person-info .role {
      color: var(--text-light);
      font-size: 0.9rem;
    }
    
    .person-info .contact {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 0.5rem;
    }
    
    .person-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #ddd;
    }
    
    .btn-edit, .btn-delete {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      font-family: inherit;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      transition: all 0.2s;
    }
    
    .btn-edit {
      background: var(--primary-blue);
      color: white;
    }
    
    .btn-edit:hover {
      background: var(--light-blue);
    }
    
    .btn-delete {
      background: var(--danger);
      color: white;
    }
    
    .btn-delete:hover {
      background: #c82333;
    }
    
    .btn-add-person {
      padding: 1rem 2rem;
      background: var(--accent-teal);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .btn-add-person:hover {
      background: #3dbfd0;
    }
    
    .drag-handle {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      color: #aaa;
      cursor: grab;
      font-size: 1.2rem;
    }
    
    .order-badge {
      position: absolute;
      top: 0.75rem;
      left: 0.75rem;
      background: var(--primary-blue);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
      display: none;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal-box {
      background: white;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      color: var(--primary-blue);
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-light);
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid #ddd;
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }
    
    .btn-cancel {
      padding: 0.75rem 1.5rem;
      background: #ddd;
      color: var(--text-dark);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .btn-save {
      padding: 0.75rem 1.5rem;
      background: var(--primary-blue);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .btn-save:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    
    /* Photo Upload in Modal */
    .photo-upload-area {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    
    .photo-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary-blue);
      margin-bottom: 1rem;
    }
    
    .photo-preview-placeholder {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      margin: 0 auto 1rem;
      border: 3px dashed #ccc;
    }
    
    .btn-upload-photo {
      padding: 0.5rem 1rem;
      background: var(--light-blue);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .photo-hint {
      font-size: 0.8rem;
      color: var(--text-light);
      margin-top: 0.5rem;
    }
    
    .upload-progress {
      width: 100%;
      height: 6px;
      background: #eee;
      border-radius: 3px;
      margin-top: 0.5rem;
      overflow: hidden;
      display: none;
    }
    
    .upload-progress-bar {
      height: 100%;
      background: var(--primary-blue);
      width: 0%;
      transition: width 0.3s;
    }
    
    /* Loading State */
    .loading-spinner {
      text-align: center;
      padding: 3rem;
      color: var(--text-light);
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-light);
    }
    
    .empty-state p {
      margin-bottom: 1rem;
    }
    
    /* Gallery CMS Grid */
    .gallery-cms-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1.5rem;
    }
    
    .gallery-card {
      background: #f8f9fa;
      border: 2px solid #ddd;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s;
      cursor: grab;
      position: relative;
    }
    
    .gallery-card:hover {
      border-color: var(--primary-blue);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .gallery-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .gallery-card.drag-over {
      border-color: var(--accent-teal);
      background: #e8f4f8;
    }
    
    .gallery-card-image {
      width: 100%;
      height: 150px;
      object-fit: cover;
      display: block;
    }
    
    .gallery-card-placeholder {
      width: 100%;
      height: 150px;
      background: linear-gradient(135deg, #e0e0e0, #f5f5f5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: #999;
    }
    
    .gallery-card-info {
      padding: 1rem;
    }
    
    .gallery-card-info h4 {
      color: var(--primary-blue);
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .gallery-card-info .caption {
      color: var(--text-light);
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .gallery-card-actions {
      display: flex;
      gap: 0.5rem;
      padding: 0 1rem 1rem;
    }
    
    .gallery-card-actions button {
      flex: 1;
      padding: 0.4rem;
      font-size: 0.8rem;
    }
    
    .gallery-order-badge {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      background: var(--primary-blue);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      z-index: 1;
    }
    
    .gallery-drag-handle {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      color: white;
      background: rgba(0,0,0,0.4);
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      cursor: grab;
      font-size: 1rem;
      z-index: 1;
    }
    
    /* Resources Grid */
    .resources-grid {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .resource-card {
      background: #f8f9fa;
      border: 2px solid #ddd;
      border-radius: 12px;
      padding: 1.25rem;
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      transition: all 0.3s;
    }
    
    .resource-card:hover {
      border-color: var(--primary-blue);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .resource-logo {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: contain;
      background: white;
      padding: 4px;
      border: 1px solid #e2e8f0;
      flex-shrink: 0;
    }
    
    .resource-logo-placeholder {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    
    .resource-info {
      flex: 1;
      min-width: 0;
    }
    
    .resource-info h4 {
      color: var(--primary-blue);
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
    }
    
    .resource-type-badge {
      display: inline-block;
      padding: 2px 8px;
      background: #e0f2fe;
      color: #0369a1;
      border-radius: 50px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .resource-meta {
      font-size: 0.85rem;
      color: var(--text-light);
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    
    .resource-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .resource-actions {
      display: flex;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .cms-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .cms-tabs {
        overflow-x: auto;
        flex-wrap: nowrap;
        padding-bottom: 0.5rem;
      }
      
      .tab {
        padding: 0.75rem 1rem;
        white-space: nowrap;
      }
      
      .people-grid {
        grid-template-columns: 1fr;
      }
      
      .resource-card {
        flex-direction: column;
      }
      
      .resource-actions {
        width: 100%;
        justify-content: flex-end;
      }
    }
    
    /* Sub-tabs */
    .sub-tabs {
      border-bottom: 2px solid #eee;
      padding-bottom: 0.5rem;
    }
    
    .sub-tab {
      padding: 0.5rem 1rem;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-light);
      transition: all 0.3s;
      position: relative;
    }
    
    .sub-tab.active {
      color: var(--primary-blue);
      border-bottom-color: var(--primary-blue);
    }
    
    .sub-tab:hover {
      color: var(--primary-blue);
    }
    
    .badge {
      background: #ef4444;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 0.7rem;
      margin-left: 4px;
    }
    
    /* Data Lists */
    .data-list, .events-list, .applications-list, .opportunities-list, .faqs-list, .categories-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .data-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s;
    }
    
    .data-card:hover {
      border-color: var(--primary-blue);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .data-card.pending, .data-card.new {
      border-left: 4px solid #f59e0b;
    }
    
    .data-card.approved, .data-card.completed, .data-card.accepted {
      border-left: 4px solid #10b981;
    }
    
    .data-card.declined {
      border-left: 4px solid #ef4444;
    }
    
    .data-card-header {
      padding: 1rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .data-card-header:hover {
      background: #f9fafb;
    }
    
    .data-card-body {
      padding: 1rem;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
    }
    
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: capitalize;
    }
    
    .status-new, .status-pending { background: #fef3c7; color: #92400e; }
    .status-contacted, .status-reviewed { background: #dbeafe; color: #1e40af; }
    .status-in-progress, .status-interviewing, .status-scheduled { background: #e0e7ff; color: #3730a3; }
    .status-completed, .status-accepted, .status-approved { background: #d1fae5; color: #065f46; }
    .status-archived, .status-declined { background: #fee2e2; color: #991b1b; }
    .status-read, .status-replied, .status-viewed { background: #f3f4f6; color: #374151; }
    .status-acknowledged { background: #ddd6fe; color: #5b21b6; }
    
    .btn-export {
      padding: 0.5rem 1rem;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-family: inherit;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    
    .btn-export:hover {
      background: #059669;
    }
    
    .status-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 1rem 0;
    }
    
    .status-btn {
      padding: 0.4rem 0.8rem;
      border: 2px solid #ddd;
      border-radius: 20px;
      background: white;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      font-family: inherit;
      transition: all 0.2s;
      text-transform: capitalize;
    }
    
    .status-btn:hover {
      border-color: var(--primary-blue);
    }
    
    .status-btn.active {
      background: var(--primary-blue);
      color: white;
      border-color: var(--primary-blue);
    }
    
    /* Analytics */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    /* New Dashboard Styles */
    .action-items-banner {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 2px solid #f59e0b;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    
    .action-items-header {
      background: #f59e0b;
      color: white;
      padding: 0.75rem 1rem;
      font-weight: 600;
    }
    
    .action-items-list {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .action-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .action-item:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .action-item-badge {
      background: #ef4444;
      color: white;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      min-width: 24px;
      text-align: center;
    }
    
    .btn-refresh-dashboard {
      padding: 0.5rem 1rem;
      background: white;
      border: 2px solid var(--primary-blue);
      color: var(--primary-blue);
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-refresh-dashboard:hover {
      background: var(--primary-blue);
      color: white;
    }
    
    .dashboard-kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .kpi-card {
      background: white;
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border-left: 4px solid;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    
    .kpi-primary { border-left-color: #3b82f6; }
    .kpi-success { border-left-color: #10b981; }
    .kpi-info { border-left-color: #8b5cf6; }
    .kpi-warning { border-left-color: #f59e0b; }
    
    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .kpi-icon {
      font-size: 1.5rem;
    }
    
    .kpi-attention {
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: #fee2e2;
      color: #dc2626;
      display: none;
    }
    
    .kpi-attention.has-items {
      display: inline-block;
      animation: pulse-attention 2s infinite;
    }
    
    @keyframes pulse-attention {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .kpi-trend {
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
    }
    
    .kpi-trend.up { background: #d1fae5; color: #059669; }
    .kpi-trend.down { background: #fee2e2; color: #dc2626; }
    .kpi-trend.neutral { background: #f3f4f6; color: #6b7280; }
    
    .kpi-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary-blue);
      line-height: 1.1;
    }
    
    .kpi-label {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-top: 0.25rem;
    }
    
    .kpi-subtext {
      font-size: 0.8rem;
      color: var(--text-light);
      margin-top: 0.25rem;
    }
    
    .dashboard-two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    @media (max-width: 900px) {
      .dashboard-two-col {
        grid-template-columns: 1fr;
      }
    }
    
    .dashboard-col {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .dashboard-card {
      background: white;
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .dashboard-card-title {
      color: var(--primary-blue);
      font-size: 1.1rem;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .content-stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }
    
    .content-stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem 0.5rem;
      background: #f9fafb;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .content-stat-item:hover {
      background: #eff6ff;
      transform: scale(1.02);
    }
    
    .content-stat-icon {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }
    
    .content-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-blue);
    }
    
    .content-stat-label {
      font-size: 0.7rem;
      color: var(--text-light);
      text-align: center;
    }
    
    .quick-actions-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    
    .quick-action-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 2px solid #bae6fd;
      border-radius: 10px;
      font-weight: 600;
      color: var(--primary-blue);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
    }
    
    .quick-action-btn:hover {
      background: linear-gradient(135deg, #e0f2fe, #bae6fd);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,78,124,0.15);
    }
    
    .activity-feed {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .activity-item {
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem;
      border-bottom: 1px solid #f0f0f0;
      border-radius: 8px;
      margin-bottom: 0.25rem;
      transition: background 0.2s;
    }
    
    .activity-item:hover {
      background: #f9fafb;
    }
    
    .activity-item.activity-new {
      background: #fefce8;
      border-left: 3px solid #eab308;
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }
    
    .activity-icon.event { background: #dbeafe; }
    .activity-icon.volunteer { background: #d1fae5; }
    .activity-icon.contact { background: #ede9fe; }
    .activity-icon.provider { background: #fef3c7; }
    .activity-icon.pledge { background: #fce7f3; }
    
    .activity-content {
      flex: 1;
      min-width: 0;
    }
    
    .activity-text {
      font-size: 0.85rem;
      color: var(--text-dark);
      line-height: 1.3;
    }
    
    .activity-text strong {
      color: var(--primary-blue);
    }
    
    .activity-new-badge {
      display: inline-block;
      background: #dc2626;
      color: white;
      font-size: 0.6rem;
      font-weight: 700;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      margin-left: 0.5rem;
      vertical-align: middle;
    }
    
    .activity-detail {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-top: 0.2rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .activity-time {
      font-size: 0.7rem;
      color: var(--text-light);
      margin-top: 0.2rem;
    }
    
    .pledge-stats {
      text-align: center;
    }
    
    .pledge-stat-big {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      background: linear-gradient(135deg, #fdf4ff, #f5d0fe);
      border-radius: 12px;
      margin-bottom: 1rem;
    }
    
    .pledge-stat-big span:first-child {
      font-size: 3rem;
      font-weight: 800;
      color: #a855f7;
    }
    
    .pledge-stat-label {
      font-size: 0.9rem;
      color: var(--text-light);
    }
    
    .pledge-stat-small {
      font-size: 0.85rem;
      color: var(--text-light);
    }
    
    .dashboard-export-section {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      padding: 1.5rem;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .btn-export-full {
      padding: 0.75rem 1.5rem;
      background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-export-full:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,78,124,0.3);
    }
    
    .btn-firebase-link {
      padding: 0.75rem 1.5rem;
      background: white;
      color: var(--primary-blue);
      border: 2px solid var(--primary-blue);
      border-radius: 8px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .btn-firebase-link:hover {
      background: #f0f9ff;
    }
    
    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 16px;
      text-align: center;
      box-shadow: var(--shadow);
      border: 2px solid #e5e7eb;
    }
    
    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary-blue);
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--text-light);
      font-weight: 500;
    }
    
    .analytics-section {
      background: white;
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: var(--shadow);
    }
    
    .breakdown-list, .trends-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .breakdown-item, .trend-item {
      background: #f9fafb;
      padding: 1rem;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Event Card */
    .event-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .event-card-header {
      display: flex;
      gap: 1rem;
      padding: 1rem;
    }
    
    .event-poster {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      flex-shrink: 0;
    }
    
    .event-poster-placeholder {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      flex-shrink: 0;
    }
    
    /* Category Card */
    .category-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .category-card:hover {
      border-color: var(--primary-blue);
    }
    
    /* FAQ Card */
    .faq-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .faq-card-header {
      padding: 1rem;
      cursor: pointer;
    }
    
    .faq-card-header:hover {
      background: #f9fafb;
    }
    
    .faq-category-badge {
      display: inline-block;
      padding: 2px 8px;
      background: #e0f2fe;
      color: #0369a1;
      border-radius: 50px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    /* Opportunity Card */
    .opportunity-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .opportunity-status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 50px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    
    .opportunity-status.active { background: #d1fae5; color: #065f46; }
    .opportunity-status.scheduled { background: #fef3c7; color: #92400e; }
    .opportunity-status.expired { background: #fee2e2; color: #991b1b; }
    .opportunity-status.always { background: #dbeafe; color: #1e40af; }
    
    /* Page Editor */
    .sub-tab.small {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
    }
    
    .editable-field {
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafafa;
    }
    
    .editable-field:hover {
      border-color: var(--primary-blue);
      background: #f0f9ff;
    }
    
    .editable-field:focus-within {
      border-color: var(--primary-blue);
      border-style: solid;
      background: white;
      box-shadow: 0 0 0 3px rgba(0, 78, 124, 0.1);
    }
    
    .editable-field label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--primary-blue);
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }
    
    .editable-field .field-content {
      width: 100%;
      border: none;
      background: transparent;
      font-family: inherit;
      font-size: 1rem;
      color: var(--text-dark);
      resize: vertical;
      min-height: 1.5em;
      outline: none;
    }
    
    .editable-field textarea.field-content {
      min-height: 80px;
    }
    
    .page-section {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .page-section:last-child {
      border-bottom: none;
    }
    
    .page-section-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary-blue);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .field-saved {
      animation: savedPulse 0.5s ease;
    }
    
    @keyframes savedPulse {
      0% { background: #d1fae5; }
      100% { background: #fafafa; }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen">
    <div class="login-box">
      <h1>LDAH CMS</h1>
      <p>Content Management System</p>
      
      <div class="error-message" id="loginError"></div>
      
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required placeholder="Enter CMS password">
        </div>
        
        <button type="submit" class="btn btn-primary">Sign In</button>
      </form>
    </div>
  </div>

  <!-- CMS Panel -->
  <div id="cmsPanel">
    <div class="cms-header">
      <h1>üìù LDAH Content Management</h1>
      <div class="user-info">
        <a href="index.html" class="preview-button" target="_blank">Preview Site</a>
        <button class="btn-logout" onclick="handleLogout()">Logout</button>
      </div>
    </div>
    
    <div class="cms-container">
      <!-- Tabs -->
      <div class="cms-tabs">
        <button class="tab" data-tab="analytics">üìà Dashboard</button>
        <button class="tab" data-tab="team">üë• Team</button>
        <button class="tab" data-tab="board">üèÜ Board</button>
        <button class="tab" data-tab="gallery">üì∏ Gallery</button>
        <button class="tab" data-tab="gallery2">üì∏ Gallery 2</button>
        <button class="tab" data-tab="resources">üìö Resources</button>
        <button class="tab" data-tab="faq">‚ùì FAQ</button>
        <button class="tab" data-tab="events">üìÖ Events <span id="eventsTabBadge" class="badge" style="display: none;"></span></button>
        <button class="tab" data-tab="volunteers">ü§ù Volunteers <span id="volunteersTabBadge" class="badge" style="display: none;"></span></button>
        <button class="tab" data-tab="data">üìä Data <span id="dataTabBadge" class="badge" style="display: none;"></span></button>
        <button class="tab" data-tab="pages">üìÑ Pages</button>
      </div>
      
      <!-- Team Tab -->
      <div class="tab-content" id="team-tab">
        <div class="content-section">
          <h2>üë• Manage Our Team</h2>
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">
            Add, edit, or remove team members. Drag cards to reorder. Changes appear on the Who We Are page.
          </p>
          
          <div class="success-message" id="teamSuccess">Changes saved successfully!</div>
          
          <button class="btn-add-person" onclick="openPersonModal('team')">+ Add Team Member</button>
          
          <div id="teamLoading" class="loading-spinner">Loading team members...</div>
          <div id="teamEmpty" class="empty-state" style="display:none;">
            <p>No team members yet.</p>
            <button class="btn-add-person" onclick="openPersonModal('team')">+ Add Your First Team Member</button>
          </div>
          <div class="people-grid" id="teamGrid"></div>
        </div>
      </div>
      
      <!-- Board Tab -->
      <div class="tab-content" id="board-tab">
        <div class="content-section">
          <h2>üèÜ Manage Board of Directors</h2>
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">
            Add, edit, or remove board members. Drag cards to reorder. Changes appear on the Who We Are page.
          </p>
          
          <div class="success-message" id="boardSuccess">Changes saved successfully!</div>
          
          <button class="btn-add-person" onclick="openPersonModal('board')">+ Add Board Member</button>
          
          <div id="boardLoading" class="loading-spinner">Loading board members...</div>
          <div id="boardEmpty" class="empty-state" style="display:none;">
            <p>No board members yet.</p>
            <button class="btn-add-person" onclick="openPersonModal('board')">+ Add Your First Board Member</button>
          </div>
          <div class="people-grid" id="boardGrid"></div>
        </div>
      </div>
      
      <!-- Gallery Tab -->
      <div class="tab-content" id="gallery-tab">
        <div class="content-section">
          <h2>üì∏ Manage Photo Gallery</h2>
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">
            Add, edit, or remove photos from the gallery. Drag cards to reorder. Changes appear on the Who We Are page.
          </p>
          
          <div class="success-message" id="gallerySuccess">Changes saved successfully!</div>
          
          <button class="btn-add-person" onclick="openGalleryModal()" style="background: linear-gradient(135deg, #10b981, #059669);">+ Add Photo</button>
          
          <div id="galleryLoading" class="loading-spinner">Loading gallery...</div>
          <div id="galleryEmpty" class="empty-state" style="display:none;">
            <p>No photos in gallery yet.</p>
            <button class="btn-add-person" onclick="openGalleryModal()" style="background: linear-gradient(135deg, #10b981, #059669);">+ Add Your First Photo</button>
          </div>
          <div id="galleryCount" style="color: var(--text-light); margin-bottom: 1rem;"></div>
          <div class="gallery-cms-grid" id="galleryGrid"></div>
        </div>
      </div>
      
      <!-- Gallery 2 Tab -->
      <div class="tab-content" id="gallery2-tab">
        <div class="content-section">
          <h2>üì∏ Manage Photo Gallery 2</h2>
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">
            Add, edit, or remove photos from gallery 2. Drag cards to reorder. Changes appear on the Volunteer page.
          </p>
          
          <div class="success-message" id="gallery2Success">Changes saved successfully!</div>
          
          <button class="btn-add-person" onclick="openGallery2Modal()" style="background: linear-gradient(135deg, #10b981, #059669);">+ Add Photo</button>
          
          <div id="gallery2Loading" class="loading-spinner">Loading gallery...</div>
          <div id="gallery2Empty" class="empty-state" style="display:none;">
            <p>No photos in gallery 2 yet.</p>
            <button class="btn-add-person" onclick="openGallery2Modal()" style="background: linear-gradient(135deg, #10b981, #059669);">+ Add Your First Photo</button>
          </div>
          <div id="gallery2Count" style="color: var(--text-light); margin-bottom: 1rem;"></div>
          <div class="gallery-cms-grid" id="gallery2Grid"></div>
        </div>
      </div>
      
      <!-- Resources Tab -->
      <div class="tab-content" id="resources-tab">
        <div class="content-section">
          <h2>üìö Manage Resources</h2>
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">
            Add, edit, or remove community resources. These appear on the Resources page for families to find support services.
          </p>
          
          <div class="success-message" id="resourcesSuccess">Changes saved successfully!</div>
          
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
            <button class="btn-add-person" onclick="openResourceModal()">+ Add Resource</button>
            <input type="text" id="resourceSearch" placeholder="üîç Search resources..." 
                   style="padding: 0.75rem 1rem; border: 2px solid #ddd; border-radius: 8px; flex: 1; min-width: 200px;"
                   oninput="filterResourcesList()">
          </div>
          
          <div id="resourcesLoading" class="loading-spinner">Loading resources...</div>
          <div id="resourcesEmpty" class="empty-state" style="display:none;">
            <p>No resources yet.</p>
            <button class="btn-add-person" onclick="openResourceModal()">+ Add Your First Resource</button>
          </div>
          <div id="resourcesCount" style="color: var(--text-light); margin-bottom: 1rem;"></div>
          <div class="resources-grid" id="resourcesGrid"></div>
        </div>
      </div>
      
      <!-- FAQ Tab -->
      <div class="tab-content" id="faq-tab">
        <div class="content-section">
          <h2>‚ùì Manage FAQ</h2>
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">
            Manage FAQ categories and questions. These appear on the Special Education page.
          </p>
          
          <div class="success-message" id="faqSuccess">Changes saved successfully!</div>
          
          <!-- Sub-tabs for Categories/FAQs -->
          <div class="sub-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
            <button class="sub-tab active" data-subtab="categories" onclick="switchFaqSubTab('categories')">üìÅ Categories</button>
            <button class="sub-tab" data-subtab="faqs" onclick="switchFaqSubTab('faqs')">‚ùì FAQ Items</button>
          </div>
          
          <!-- Categories Sub-tab -->
          <div id="categories-subtab" class="subtab-content">
            <button class="btn-add-person" onclick="openCategoryModal()">+ Add Category</button>
            <div id="categoriesLoading" class="loading-spinner">Loading categories...</div>
            <div id="categoriesEmpty" class="empty-state" style="display:none;">
              <p>No categories yet. Create categories first, then add FAQs.</p>
            </div>
            <div class="categories-list" id="categoriesList"></div>
          </div>
          
          <!-- FAQs Sub-tab -->
          <div id="faqs-subtab" class="subtab-content" style="display: none;">
            <button class="btn-add-person" onclick="openFaqModal()">+ Add FAQ</button>
            <div style="margin: 1rem 0;">
              <select id="faqCategoryFilter" onchange="filterFaqsByCategory()" style="padding: 0.5rem; border-radius: 8px; border: 2px solid #ddd;">
                <option value="all">All Categories</option>
              </select>
            </div>
            <div id="faqsLoading" class="loading-spinner">Loading FAQs...</div>
            <div id="faqsEmpty" class="empty-state" style="display:none;">
              <p>No FAQs yet.</p>
            </div>
            <div class="faqs-list" id="faqsList"></div>
          </div>
        </div>
      </div>
      
      <!-- Events Tab -->
      <div class="tab-content" id="events-tab">
        <div class="content-section">
          <h2>üìÖ Manage Events</h2>
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">
            Create and manage events. View signups for each event.
          </p>
          
          <div class="success-message" id="eventsSuccess">Changes saved successfully!</div>
          
          <button class="btn-add-person" onclick="openEventModal()">+ Add Event</button>
          
          <div id="eventsLoading" class="loading-spinner">Loading events...</div>
          <div id="eventsEmpty" class="empty-state" style="display:none;">
            <p>No events yet.</p>
          </div>
          <div id="eventsCount" style="color: var(--text-light); margin-bottom: 1rem;"></div>
          <div class="events-list" id="eventsList"></div>
        </div>
      </div>
      
      <!-- Volunteers Tab -->
      <div class="tab-content" id="volunteers-tab">
        <div class="content-section">
          <h2>ü§ù Manage Volunteers</h2>
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">
            Manage volunteer opportunities and view applications.
          </p>
          
          <div class="success-message" id="volunteersSuccess">Changes saved successfully!</div>
          
          <!-- Sub-tabs -->
          <div class="sub-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
            <button class="sub-tab active" data-subtab="opportunities" onclick="switchVolunteerSubTab('opportunities')">üìã Opportunities</button>
            <button class="sub-tab" data-subtab="applications" onclick="switchVolunteerSubTab('applications')">
              üì® Applications
              <span id="newApplicationsBadge" class="badge" style="display: none;"></span>
            </button>
          </div>
          
          <!-- Opportunities Sub-tab -->
          <div id="opportunities-subtab" class="subtab-content">
            <button class="btn-add-person" onclick="openOpportunityModal()">+ Add Opportunity</button>
            <div id="opportunitiesLoading" class="loading-spinner">Loading opportunities...</div>
            <div id="opportunitiesEmpty" class="empty-state" style="display:none;">
              <p>No volunteer opportunities yet.</p>
            </div>
            <div class="opportunities-list" id="opportunitiesList"></div>
          </div>
          
          <!-- Applications Sub-tab -->
          <div id="applications-subtab" class="subtab-content" style="display: none;">
            <div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
              <select id="applicationStatusFilter" onchange="filterApplications()" style="padding: 0.5rem; border-radius: 8px; border: 2px solid #ddd;">
                <option value="all">All Statuses</option>
                <option value="new">New</option>
                <option value="contacted">Contacted</option>
                <option value="interviewing">Interviewing</option>
                <option value="accepted">Accepted</option>
                <option value="declined">Declined</option>
              </select>
              <button onclick="exportApplicationsToCSV()" class="btn-export">üì• Export CSV</button>
            </div>
            <div id="applicationsLoading" class="loading-spinner">Loading applications...</div>
            <div id="applicationsEmpty" class="empty-state" style="display:none;">
              <p>No applications yet.</p>
            </div>
            <div id="applicationsCount" style="color: var(--text-light); margin-bottom: 1rem;"></div>
            <div class="applications-list" id="applicationsList"></div>
          </div>
        </div>
      </div>
      
      <!-- Data Tab (Providers, Pledges, Event Requests) -->
      <div class="tab-content" id="data-tab">
        <div class="content-section">
          <h2>üìä Form Submissions & Data</h2>
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">
            View and manage form submissions from the website.
          </p>
          
          <div class="success-message" id="dataSuccess">Changes saved successfully!</div>
          
          <!-- Sub-tabs -->
          <div class="sub-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
            <button class="sub-tab active" data-subtab="providers" onclick="switchDataSubTab('providers')">
              üè¢ Provider Requests
              <span id="newProvidersBadge" class="badge" style="display: none;"></span>
            </button>
            <button class="sub-tab" data-subtab="pledges" onclick="switchDataSubTab('pledges')">
              ‚úä Anti-Bullying Pledges
              <span id="newPledgesBadge" class="badge" style="display: none;"></span>
            </button>
            <button class="sub-tab" data-subtab="eventRequests" onclick="switchDataSubTab('eventRequests')">
              üìÖ Event Requests
              <span id="newEventRequestsBadge" class="badge" style="display: none;"></span>
            </button>
            <button class="sub-tab" data-subtab="contacts" onclick="switchDataSubTab('contacts')">
              ‚úâÔ∏è Contact Messages
              <span id="newContactsBadge" class="badge" style="display: none;"></span>
            </button>
          </div>
          
          <!-- Provider Requests Sub-tab -->
          <div id="providers-subtab" class="subtab-content">
            <div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
              <select id="providerStatusFilter" onchange="filterProviders()" style="padding: 0.5rem; border-radius: 8px; border: 2px solid #ddd;">
                <option value="all">All Statuses</option>
                <option value="new">New</option>
                <option value="contacted">Contacted</option>
                <option value="in-progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="archived">Archived</option>
              </select>
              <button onclick="exportProvidersToCSV()" class="btn-export">üì• Export CSV</button>
            </div>
            <div id="providersLoading" class="loading-spinner">Loading provider requests...</div>
            <div id="providersEmpty" class="empty-state" style="display:none;">
              <p>No provider requests yet.</p>
            </div>
            <div id="providersCount" style="color: var(--text-light); margin-bottom: 1rem;"></div>
            <div class="data-list" id="providersList"></div>
          </div>
          
          <!-- Pledges Sub-tab -->
          <div id="pledges-subtab" class="subtab-content" style="display: none;">
            <div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
              <select id="pledgeStatusFilter" onchange="filterPledges()" style="padding: 0.5rem; border-radius: 8px; border: 2px solid #ddd;">
                <option value="all">All Statuses</option>
                <option value="new">New</option>
                <option value="viewed">Viewed</option>
                <option value="acknowledged">Acknowledged</option>
              </select>
              <button onclick="markAllPledgesViewed()" class="btn-add-person" style="padding: 0.5rem 1rem; background: #10b981;">‚úì Mark All Viewed</button>
              <button onclick="exportPledgesToCSV()" class="btn-export">üì• Export CSV</button>
            </div>
            <div id="pledgesLoading" class="loading-spinner">Loading pledges...</div>
            <div id="pledgesEmpty" class="empty-state" style="display:none;">
              <p>No pledges yet.</p>
            </div>
            <div id="pledgesCount" style="color: var(--text-light); margin-bottom: 1rem;"></div>
            <div class="data-list" id="pledgesList"></div>
          </div>
          
          <!-- Event Requests Sub-tab -->
          <div id="eventRequests-subtab" class="subtab-content" style="display: none;">
            <div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
              <select id="eventRequestStatusFilter" onchange="filterEventRequests()" style="padding: 0.5rem; border-radius: 8px; border: 2px solid #ddd;">
                <option value="all">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="reviewed">Reviewed</option>
                <option value="approved">Approved</option>
                <option value="scheduled">Scheduled</option>
                <option value="declined">Declined</option>
                <option value="completed">Completed</option>
              </select>
              <button onclick="exportEventRequestsToCSV()" class="btn-export">üì• Export CSV</button>
            </div>
            <div id="eventRequestsLoading" class="loading-spinner">Loading event requests...</div>
            <div id="eventRequestsEmpty" class="empty-state" style="display:none;">
              <p>No event requests yet.</p>
            </div>
            <div id="eventRequestsCount" style="color: var(--text-light); margin-bottom: 1rem;"></div>
            <div class="data-list" id="eventRequestsList"></div>
          </div>
          
          <!-- Contact Messages Sub-tab -->
          <div id="contacts-subtab" class="subtab-content" style="display: none;">
            <div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
              <select id="contactStatusFilter" onchange="filterContacts()" style="padding: 0.5rem; border-radius: 8px; border: 2px solid #ddd;">
                <option value="all">All</option>
                <option value="new">New</option>
                <option value="read">Read</option>
                <option value="replied">Replied</option>
              </select>
              <button onclick="exportContactsToCSV()" class="btn-export">üì• Export CSV</button>
            </div>
            <div id="contactsLoading" class="loading-spinner">Loading messages...</div>
            <div id="contactsEmpty" class="empty-state" style="display:none;">
              <p>No contact messages yet.</p>
            </div>
            <div id="contactsCount" style="color: var(--text-light); margin-bottom: 1rem;"></div>
            <div class="data-list" id="contactsList"></div>
          </div>
        </div>
      </div>
      
      <!-- Pages Tab -->
      <div class="tab-content" id="pages-tab">
        <div class="content-section">
          <h2>üìÑ Edit Page Content</h2>
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">
            Edit website page content using our visual page editor.
          </p>
          
          <div style="background: linear-gradient(135deg, var(--primary-blue), #1A8FC4); border-radius: 16px; padding: 2.5rem; color: white; text-align: center; margin-bottom: 2rem;">
            <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">‚ú® Visual Page Editor</h3>
            <p style="opacity: 0.9; margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto;">
              Edit pages visually - see exactly how they look while you edit. Click any text to change it instantly.
            </p>
            <a href="page-admin.html" class="btn-add-person" style="display: inline-block; background: white; color: var(--primary-blue); padding: 1rem 2rem; font-size: 1.1rem; text-decoration: none; border-radius: 12px; font-weight: 600;">
              üñ•Ô∏è Open Page Editor
            </a>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <span style="font-size: 2rem;">üè†</span>
              <h4 style="color: var(--primary-blue); margin: 0.5rem 0;">Home</h4>
              <p style="font-size: 0.85rem; color: var(--text-light);">Hero, stats, services</p>
            </div>
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <span style="font-size: 2rem;">üë•</span>
              <h4 style="color: var(--primary-blue); margin: 0.5rem 0;">Who We Are</h4>
              <p style="font-size: 0.85rem; color: var(--text-light);">Mission, vision, history</p>
            </div>
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <span style="font-size: 2rem;">üìÖ</span>
              <h4 style="color: var(--primary-blue); margin: 0.5rem 0;">Events</h4>
              <p style="font-size: 0.85rem; color: var(--text-light);">Event page content</p>
            </div>
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <span style="font-size: 2rem;">ü§ù</span>
              <h4 style="color: var(--primary-blue); margin: 0.5rem 0;">Volunteer</h4>
              <p style="font-size: 0.85rem; color: var(--text-light);">Volunteer page content</p>
            </div>
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <span style="font-size: 2rem;">üìö</span>
              <h4 style="color: var(--primary-blue); margin: 0.5rem 0;">Resources</h4>
              <p style="font-size: 0.85rem; color: var(--text-light);">Resource directory</p>
            </div>
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <span style="font-size: 2rem;">üìû</span>
              <h4 style="color: var(--primary-blue); margin: 0.5rem 0;">Contact</h4>
              <p style="font-size: 0.85rem; color: var(--text-light);">Contact info & form</p>
            </div>
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <span style="font-size: 2rem;">üéì</span>
              <h4 style="color: var(--primary-blue); margin: 0.5rem 0;">Readiness</h4>
              <p style="font-size: 0.85rem; color: var(--text-light);">School readiness info</p>
            </div>
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <span style="font-size: 2rem;">‚öñÔ∏è</span>
              <h4 style="color: var(--primary-blue); margin: 0.5rem 0;">Special Ed</h4>
              <p style="font-size: 0.85rem; color: var(--text-light);">IEP & advocacy content</p>
            </div>
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <span style="font-size: 2rem;">üá∫üá∏</span>
              <h4 style="color: var(--primary-blue); margin: 0.5rem 0;">Military</h4>
              <p style="font-size: 0.85rem; color: var(--text-light);">Military family support</p>
            </div>
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <span style="font-size: 2rem;">üèùÔ∏è</span>
              <h4 style="color: var(--primary-blue); margin: 0.5rem 0;">Pacific</h4>
              <p style="font-size: 0.85rem; color: var(--text-light);">Pacific Islands outreach</p>
            </div>
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center;">
              <span style="font-size: 2rem;">‚úä</span>
              <h4 style="color: var(--primary-blue); margin: 0.5rem 0;">Community</h4>
              <p style="font-size: 0.85rem; color: var(--text-light);">Anti-bullying resources</p>
            </div>
          </div>
          
          <div style="margin-top: 2rem; padding: 1rem; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <p style="font-size: 0.9rem; color: #92400e;">
              <strong>üí° How it works:</strong> The Page Editor shows a preview of each page. Click any text with a dashed border to edit it. 
              Changes save to Firebase and will appear on your live website (once your pages are connected to Firebase).
            </p>
          </div>
        </div>
      </div>
      
      <!-- Analytics Tab -->
      <div class="tab-content active" id="analytics-tab">
        <div class="content-section" style="background: transparent; box-shadow: none; padding: 0;">
          <h2 style="margin-bottom: 0.5rem;">üìà Dashboard</h2>
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">
            Welcome back! Here's what's happening with LDAH.
          </p>
          
          <!-- Action Items Banner -->
          <div id="actionItemsBanner" class="action-items-banner" style="display: none;">
            <div class="action-items-header">
              <span>‚ö° Needs Your Attention</span>
            </div>
            <div id="actionItemsList" class="action-items-list"></div>
          </div>
          
          <!-- Date Range & Controls -->
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; margin-bottom: 1.5rem; justify-content: flex-end;">
            <span style="color: var(--text-light); font-size: 0.85rem;">Data updates automatically</span>
            <button onclick="refreshDashboard()" class="btn-refresh-dashboard">üîÑ Refresh</button>
          </div>
          
          <div id="analyticsLoading" class="loading-spinner" style="display: none;">Loading dashboard...</div>
          
          <!-- Hidden date range elements for compatibility -->
          <select id="analyticsDateRange" style="display: none;">
            <option value="all" selected>All Time</option>
          </select>
          <div id="customDateRange" style="display: none;"></div>
          <input type="hidden" id="analyticsStartDate">
          <input type="hidden" id="analyticsEndDate">
          
          <!-- Main KPI Cards -->
          <div class="dashboard-kpi-grid">
            <div class="kpi-card kpi-primary" onclick="document.querySelector('[data-tab=events]').click()" style="cursor: pointer;">
              <div class="kpi-header">
                <span class="kpi-icon">üìÖ</span>
                <span class="kpi-attention" id="eventSignupsAttention"></span>
              </div>
              <div class="kpi-value" id="statEventSignups">-</div>
              <div class="kpi-label">Event Signups</div>
              <div class="kpi-subtext" id="eventSignupsSubtext">Total signups this period</div>
            </div>
            
            <div class="kpi-card kpi-success" onclick="document.querySelector('[data-tab=volunteers]').click()" style="cursor: pointer;">
              <div class="kpi-header">
                <span class="kpi-icon">ü§ù</span>
                <span class="kpi-attention" id="volunteerAppsAttention"></span>
              </div>
              <div class="kpi-value" id="statVolunteerApps">-</div>
              <div class="kpi-label">Volunteer Applications</div>
              <div class="kpi-subtext" id="volunteerAppsSubtext">New applications</div>
            </div>
            
            <div class="kpi-card kpi-info" onclick="document.querySelector('[data-tab=data]').click(); setTimeout(() => switchDataSubTab('contacts'), 100);" style="cursor: pointer;">
              <div class="kpi-header">
                <span class="kpi-icon">‚úâÔ∏è</span>
                <span class="kpi-attention" id="contactsAttention"></span>
              </div>
              <div class="kpi-value" id="statContacts">-</div>
              <div class="kpi-label">Contact Messages</div>
              <div class="kpi-subtext" id="contactsSubtext">People reaching out</div>
            </div>
            
            <div class="kpi-card kpi-warning" onclick="document.querySelector('[data-tab=data]').click(); setTimeout(() => switchDataSubTab('providers'), 100);" style="cursor: pointer;">
              <div class="kpi-header">
                <span class="kpi-icon">üìã</span>
                <span class="kpi-attention" id="providersAttention"></span>
              </div>
              <div class="kpi-value" id="statProviders">-</div>
              <div class="kpi-label">Provider Requests</div>
              <div class="kpi-subtext" id="providersSubtext">Service listings</div>
            </div>
          </div>
          
          <!-- Two Column Layout -->
          <div class="dashboard-two-col">
            <!-- Left Column -->
            <div class="dashboard-col">
              <!-- Content Overview -->
              <div class="dashboard-card">
                <h3 class="dashboard-card-title">üìä Content Overview</h3>
                <div class="content-stats-grid">
                  <div class="content-stat-item" onclick="document.querySelector('[data-tab=team]').click()">
                    <span class="content-stat-icon">üë•</span>
                    <span class="content-stat-value" id="contentTeamCount">-</span>
                    <span class="content-stat-label">Team Members</span>
                  </div>
                  <div class="content-stat-item" onclick="document.querySelector('[data-tab=board]').click()">
                    <span class="content-stat-icon">üèÜ</span>
                    <span class="content-stat-value" id="contentBoardCount">-</span>
                    <span class="content-stat-label">Board Members</span>
                  </div>
                  <div class="content-stat-item" onclick="document.querySelector('[data-tab=resources]').click()">
                    <span class="content-stat-icon">üìö</span>
                    <span class="content-stat-value" id="contentResourcesCount">-</span>
                    <span class="content-stat-label">Resources</span>
                  </div>
                  <div class="content-stat-item" onclick="document.querySelector('[data-tab=events]').click()">
                    <span class="content-stat-icon">üìÖ</span>
                    <span class="content-stat-value" id="contentEventsCount">-</span>
                    <span class="content-stat-label">Active Events</span>
                  </div>
                  <div class="content-stat-item" onclick="document.querySelector('[data-tab=volunteers]').click()">
                    <span class="content-stat-icon">üíº</span>
                    <span class="content-stat-value" id="contentOpportunitiesCount">-</span>
                    <span class="content-stat-label">Volunteer Roles</span>
                  </div>
                  <div class="content-stat-item" onclick="document.querySelector('[data-tab=faq]').click()">
                    <span class="content-stat-icon">‚ùì</span>
                    <span class="content-stat-value" id="contentFaqCount">-</span>
                    <span class="content-stat-label">FAQs</span>
                  </div>
                </div>
              </div>
              
              <!-- Event Breakdown -->
              <div class="dashboard-card">
                <h3 class="dashboard-card-title">üìÖ Event Performance</h3>
                <div id="eventBreakdown" class="breakdown-list">
                  <p style="color: var(--text-light); text-align: center; padding: 1rem;">Loading...</p>
                </div>
              </div>
              
              <!-- Volunteer Performance -->
              <div class="dashboard-card">
                <h3 class="dashboard-card-title">ü§ù Volunteer Opportunities</h3>
                <div id="volunteerBreakdown" class="breakdown-list">
                  <p style="color: var(--text-light); text-align: center; padding: 1rem;">Loading...</p>
                </div>
              </div>
            </div>
            
            <!-- Right Column -->
            <div class="dashboard-col">
              <!-- Quick Actions -->
              <div class="dashboard-card">
                <h3 class="dashboard-card-title">üöÄ Quick Actions</h3>
                <div class="quick-actions-grid">
                  <button class="quick-action-btn" onclick="document.querySelector('[data-tab=events]').click(); setTimeout(() => openEventModal(), 100);">
                    <span>üìÖ</span> Add Event
                  </button>
                  <button class="quick-action-btn" onclick="document.querySelector('[data-tab=volunteers]').click(); setTimeout(() => openOpportunityModal(), 100);">
                    <span>üíº</span> Add Volunteer Role
                  </button>
                  <button class="quick-action-btn" onclick="document.querySelector('[data-tab=team]').click(); setTimeout(() => openPersonModal('team'), 100);">
                    <span>üë§</span> Add Team Member
                  </button>
                  <button class="quick-action-btn" onclick="document.querySelector('[data-tab=resources]').click(); setTimeout(() => openResourceModal(), 100);">
                    <span>üìö</span> Add Resource
                  </button>
                </div>
              </div>
              
              <!-- Recent Activity -->
              <div class="dashboard-card">
                <h3 class="dashboard-card-title">üïê Recent Activity</h3>
                <div id="recentActivityFeed" class="activity-feed">
                  <p style="color: var(--text-light); text-align: center; padding: 1rem;">Loading...</p>
                </div>
              </div>
              
              <!-- Anti-Bullying Pledges -->
              <div class="dashboard-card">
                <h3 class="dashboard-card-title">‚úä Anti-Bullying Pledges</h3>
                <div class="pledge-stats">
                  <div class="pledge-stat-big">
                    <span id="totalPledgesCount">-</span>
                    <span class="pledge-stat-label">Total Pledges</span>
                  </div>
                  <div class="pledge-stat-small" id="pledgesByMonth">
                    <p style="color: var(--text-light);">Loading pledge data...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Export Section -->
          <div class="dashboard-export-section">
            <button onclick="exportAnalyticsReport()" class="btn-export-full">
              üìÑ Export Full Report
            </button>
            <a href="https://console.firebase.google.com/project/ldah-932d5/analytics/app/web/overview" target="_blank" class="btn-firebase-link">
              üìä View Detailed Analytics in Firebase ‚Üí
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Person Modal -->
  <div class="modal-overlay" id="personModal">
    <div class="modal-box">
      <div class="modal-header">
        <h3 id="modalTitle">Add Team Member</h3>
        <button class="modal-close" onclick="closePersonModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="personId">
        <input type="hidden" id="personType">
        <input type="hidden" id="personPhotoUrl">
        
        <div class="photo-upload-area">
          <div id="photoPreviewContainer">
            <div class="photo-preview-placeholder" id="photoPlaceholder">üë§</div>
          </div>
          <input type="file" id="photoInput" accept="image/jpeg,image/png,image/webp" style="display:none;" onchange="handlePhotoSelect(event)">
          <button type="button" class="btn-upload-photo" onclick="document.getElementById('photoInput').click()">
            üì∑ Choose Photo
          </button>
          <p class="photo-hint">Max 2MB. JPG, PNG, or WebP.</p>
          <div class="upload-progress" id="uploadProgress">
            <div class="upload-progress-bar" id="uploadProgressBar"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Full Name *</label>
          <input type="text" id="personName" placeholder="e.g., John Smith" required>
        </div>
        
        <div class="form-group">
          <label>Title / Role *</label>
          <input type="text" id="personRole" placeholder="e.g., Executive Director">
        </div>
        
        <div class="form-group" id="phoneGroup">
          <label>Phone Number</label>
          <input type="tel" id="personPhone" placeholder="e.g., (808) 555-1234">
        </div>
        
        <div class="form-group" id="emailGroup">
          <label>Email Address</label>
          <input type="email" id="personEmail" placeholder="e.g., john@ldah.org">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closePersonModal()">Cancel</button>
        <button class="btn-save" id="savePersonBtn" onclick="savePerson()">Save</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal-box" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Confirm Delete</h3>
        <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to remove <strong id="deletePersonName"></strong>?</p>
        <p style="color: var(--text-light); margin-top: 0.5rem; font-size: 0.9rem;">This will also delete their photo. This action cannot be undone.</p>
        <input type="hidden" id="deletePersonId">
        <input type="hidden" id="deletePersonType">
        <input type="hidden" id="deletePhotoUrl">
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn-delete" onclick="confirmDelete()" style="flex: none; padding: 0.75rem 1.5rem;">Delete</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Gallery Photo Modal -->
  <div class="modal-overlay" id="galleryModal">
    <div class="modal-box" style="max-width: 500px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669);">
        <h3 id="galleryModalTitle" style="color: white;">Add Photo</h3>
        <button class="modal-close" onclick="closeGalleryModal()" style="color: white;">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="galleryPhotoId">
        <input type="hidden" id="galleryPhotoUrl">
        
        <div class="photo-upload-area">
          <div id="galleryPreviewContainer">
            <div class="photo-preview-placeholder" id="galleryPlaceholder" style="width: 200px; height: 150px; border-radius: 8px; font-size: 3rem;">üì∑</div>
          </div>
          <input type="file" id="galleryPhotoInput" accept="image/jpeg,image/png,image/webp" style="display:none;" onchange="handleGalleryPhotoSelect(event)">
          <button type="button" class="btn-upload-photo" onclick="document.getElementById('galleryPhotoInput').click()" style="background: linear-gradient(135deg, #10b981, #059669);">
            üì∑ Choose Photo
          </button>
          <p class="photo-hint">Max 5MB. JPG, PNG, or WebP.</p>
          <div class="upload-progress" id="galleryUploadProgress">
            <div class="upload-progress-bar" id="galleryUploadProgressBar"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Photo Caption / Alt Text *</label>
          <input type="text" id="galleryCaption" placeholder="e.g., LDAH Community Event 2024" required>
        </div>
        
        <div class="form-group">
          <label>Or Enter Image URL</label>
          <input type="url" id="galleryImageUrl" placeholder="https://example.com/photo.jpg" oninput="previewGalleryUrl()">
          <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem;">
            Tip: You can paste a URL from Firebase Storage, Instagram, or any public image.
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeGalleryModal()">Cancel</button>
        <button class="btn-save" id="saveGalleryBtn" onclick="saveGalleryPhoto()" style="background: linear-gradient(135deg, #10b981, #059669);">Save Photo</button>
      </div>
    </div>
  </div>

  <!-- Delete Gallery Photo Modal -->
  <div class="modal-overlay" id="deleteGalleryModal">
    <div class="modal-box" style="max-width: 400px;">
      <div class="modal-header" style="background: var(--danger);">
        <h3 style="color: white;">Delete Photo</h3>
        <button class="modal-close" onclick="closeDeleteGalleryModal()" style="color: white;">&times;</button>
      </div>
      <div class="modal-body">
        <div style="text-align: center; margin-bottom: 1rem;">
          <img id="deleteGalleryPreview" src="" alt="" style="max-width: 200px; max-height: 150px; border-radius: 8px; object-fit: cover;">
        </div>
        <p>Are you sure you want to remove this photo?</p>
        <p style="color: var(--text-light); margin-top: 0.5rem; font-size: 0.9rem;">This action cannot be undone.</p>
        <input type="hidden" id="deleteGalleryId">
        <input type="hidden" id="deleteGalleryPhotoUrl">
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeDeleteGalleryModal()">Cancel</button>
        <button class="btn-delete" onclick="confirmDeleteGallery()" style="flex: none; padding: 0.75rem 1.5rem;">Delete</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Gallery 2 Photo Modal -->
  <div class="modal-overlay" id="gallery2Modal">
    <div class="modal-box" style="max-width: 500px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669);">
        <h3 id="gallery2ModalTitle" style="color: white;">Add Photo</h3>
        <button class="modal-close" onclick="closeGallery2Modal()" style="color: white;">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="gallery2PhotoId">
        <input type="hidden" id="gallery2PhotoUrl">
        
        <div class="photo-upload-area">
          <div id="gallery2PreviewContainer">
            <div class="photo-preview-placeholder" id="gallery2Placeholder" style="width: 200px; height: 150px; border-radius: 8px; font-size: 3rem;">üì∑</div>
          </div>
          <input type="file" id="gallery2PhotoInput" accept="image/jpeg,image/png,image/webp" style="display:none;" onchange="handleGallery2PhotoSelect(event)">
          <button type="button" class="btn-upload-photo" onclick="document.getElementById('gallery2PhotoInput').click()" style="background: linear-gradient(135deg, #10b981, #059669);">
            üì∑ Choose Photo
          </button>
          <p class="photo-hint">Max 5MB. JPG, PNG, or WebP.</p>
          <div class="upload-progress" id="gallery2UploadProgress">
            <div class="upload-progress-bar" id="gallery2UploadProgressBar"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Photo Caption / Alt Text *</label>
          <input type="text" id="gallery2Caption" placeholder="e.g., Volunteer Event 2024" required>
        </div>
        
        <div class="form-group">
          <label>Or Enter Image URL</label>
          <input type="url" id="gallery2ImageUrl" placeholder="https://example.com/photo.jpg" oninput="previewGallery2Url()">
          <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem;">
            Tip: You can paste a URL from Firebase Storage, Instagram, or any public image.
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeGallery2Modal()">Cancel</button>
        <button class="btn-save" id="saveGallery2Btn" onclick="saveGallery2Photo()" style="background: linear-gradient(135deg, #10b981, #059669);">Save Photo</button>
      </div>
    </div>
  </div>

  <!-- Delete Gallery 2 Photo Modal -->
  <div class="modal-overlay" id="deleteGallery2Modal">
    <div class="modal-box" style="max-width: 400px;">
      <div class="modal-header" style="background: var(--danger);">
        <h3 style="color: white;">Delete Photo</h3>
        <button class="modal-close" onclick="closeDeleteGallery2Modal()" style="color: white;">&times;</button>
      </div>
      <div class="modal-body">
        <div style="text-align: center; margin-bottom: 1rem;">
          <img id="deleteGallery2Preview" src="" alt="" style="max-width: 200px; max-height: 150px; border-radius: 8px; object-fit: cover;">
        </div>
        <p>Are you sure you want to remove this photo?</p>
        <p style="color: var(--text-light); margin-top: 0.5rem; font-size: 0.9rem;">This action cannot be undone.</p>
        <input type="hidden" id="deleteGallery2Id">
        <input type="hidden" id="deleteGallery2PhotoUrl">
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeDeleteGallery2Modal()">Cancel</button>
        <button class="btn-delete" onclick="confirmDeleteGallery2()" style="flex: none; padding: 0.75rem 1.5rem;">Delete</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Resource Modal -->
  <div class="modal-overlay" id="resourceModal">
    <div class="modal-box" style="max-width: 600px;">
      <div class="modal-header">
        <h3 id="resourceModalTitle">Add Resource</h3>
        <button class="modal-close" onclick="closeResourceModal()">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <input type="hidden" id="resourceId">
        <input type="hidden" id="resourceLogoUrl">
        
        <div class="form-group">
          <label>Organization Name *</label>
          <input type="text" id="resourceName" placeholder="e.g., Hawaii Centers for Independent Living" required>
        </div>
        
        <div class="form-group">
          <label>Resource Type *</label>
          <select id="resourceType" style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px;">
            <option value="Specialized Resources">Specialized Resources</option>
            <option value="Educational Testing Resources">Educational Testing Resources</option>
            <option value="Private School Resources">Private School Resources</option>
            <option value="Special Education Tutoring Resources">Special Education Tutoring Resources</option>
            <option value="Transition Resources">Transition Resources</option>
            <option value="Mental Health Therapist">Mental Health Therapist</option>
            <option value="Medical Doctor">Medical Doctor</option>
            <option value="Support Services">Support Services</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Contact Person</label>
          <input type="text" id="resourcePerson" placeholder="e.g., Dr. Jane Smith">
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="resourcePhone" placeholder="(808) 555-1234">
          </div>
          <div class="form-group">
            <label>Fax</label>
            <input type="tel" id="resourceFax" placeholder="(808) 555-1235">
          </div>
        </div>
        
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="resourceEmail" placeholder="info@example.org">
        </div>
        
        <div class="form-group">
          <label>Website</label>
          <input type="url" id="resourceWebsite" placeholder="https://www.example.org">
        </div>
        
        <div class="form-group">
          <label>Street Address</label>
          <input type="text" id="resourceAddress" placeholder="123 Main Street, Suite 100">
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>City</label>
            <input type="text" id="resourceCity" placeholder="Honolulu">
          </div>
          <div class="form-group">
            <label>State</label>
            <input type="text" id="resourceState" placeholder="HI" value="HI" maxlength="2">
          </div>
          <div class="form-group">
            <label>Zip</label>
            <input type="text" id="resourceZip" placeholder="96813" maxlength="10">
          </div>
        </div>
        
        <div class="form-group">
          <label>Island</label>
          <select id="resourceIsland" style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px;">
            <option value="">-- Select Island --</option>
            <option value="Oahu">Oahu</option>
            <option value="Hawaii">Hawaii (Big Island)</option>
            <option value="Maui">Maui</option>
            <option value="Kauai">Kauai</option>
            <option value="Molokai">Molokai</option>
            <option value="Lanai">Lanai</option>
            <option value="Statewide">Statewide</option>
            <option value="Off Island">Off Island</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Services Offered</label>
          <textarea id="resourceServices" rows="4" placeholder="Describe the services this organization provides..."></textarea>
        </div>
        
        <div class="form-group">
          <label>Notes (internal)</label>
          <input type="text" id="resourceNotes" placeholder="e.g., Rev. 8/25, Contact updated">
        </div>
        
        <div class="form-group">
          <label>Logo / Image (optional)</label>
          <div class="resource-logo-upload-area" style="margin-bottom: 1rem;">
            <div id="resourceLogoPreviewContainer" style="margin-bottom: 0.75rem;">
              <div id="resourceLogoPlaceholder" style="width: 100px; height: 100px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #999;">üè¢</div>
              <img id="resourceLogoPreview" src="" alt="Logo preview" style="display: none; max-width: 150px; max-height: 100px; border-radius: 8px; object-fit: contain; border: 2px solid #ddd;">
            </div>
            <input type="file" id="resourceLogoFileInput" accept="image/jpeg,image/png,image/webp,image/gif" style="display:none;" onchange="handleResourceLogoSelect(event)">
            <button type="button" class="btn-upload-photo" onclick="document.getElementById('resourceLogoFileInput').click()" style="background: linear-gradient(135deg, var(--primary-blue), var(--light-blue)); padding: 0.5rem 1rem; font-size: 0.9rem;">
              üì∑ Upload Logo
            </button>
            <p class="photo-hint" style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem;">Max 2MB. JPG, PNG, WebP, or GIF.</p>
            <div class="upload-progress" id="resourceLogoUploadProgress" style="display: none; margin-top: 0.5rem;">
              <div class="upload-progress-bar" id="resourceLogoUploadProgressBar"></div>
            </div>
          </div>
          <div style="text-align: center; color: var(--text-light); margin: 0.5rem 0; font-size: 0.85rem;">‚Äî OR ‚Äî</div>
          <input type="url" id="resourceLogoInput" placeholder="https://example.com/logo.png" oninput="previewResourceLogoUrl()">
          <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem;">
            Paste a direct link to the organization's logo image
          </p>
          <input type="hidden" id="resourceLogoUrl">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeResourceModal()">Cancel</button>
        <button class="btn-save" id="saveResourceBtn" onclick="saveResource()">Save Resource</button>
      </div>
    </div>
  </div>

  <!-- Delete Resource Confirmation Modal -->
  <div class="modal-overlay" id="deleteResourceModal">
    <div class="modal-box" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Confirm Delete</h3>
        <button class="modal-close" onclick="closeDeleteResourceModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to remove <strong id="deleteResourceName"></strong>?</p>
        <p style="color: var(--text-light); margin-top: 0.5rem; font-size: 0.9rem;">This action cannot be undone.</p>
        <input type="hidden" id="deleteResourceId">
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeDeleteResourceModal()">Cancel</button>
        <button class="btn-delete" onclick="confirmDeleteResource()" style="flex: none; padding: 0.75rem 1.5rem;">Delete</button>
      </div>
    </div>
  </div>

  <!-- Event Editor Modal -->
  <div class="modal-overlay" id="eventModal">
    <div class="modal-box" style="max-width: 600px;">
      <div class="modal-header">
        <h3 id="eventModalTitle">Add Event</h3>
        <button class="modal-close" onclick="closeEventModal()">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <input type="hidden" id="eventId">
        
        <div class="form-group">
          <label>Event Title *</label>
          <input type="text" id="eventTitle" placeholder="e.g., Short Film Contest" required>
        </div>
        
        <div class="form-group">
          <label>Description *</label>
          <textarea id="eventDescription" rows="4" placeholder="Event details..." required></textarea>
        </div>
        
        <div class="form-group">
          <label>Event Poster/Image</label>
          <input type="hidden" id="eventImageUrl">
          <div id="eventImagePreview" style="margin-bottom: 0.5rem;"></div>
          <input type="file" id="eventImageInput" accept="image/*" onchange="handleEventImageUpload(event)">
          <div class="upload-progress" id="eventUploadProgress" style="display: none;">
            <div class="upload-progress-bar" id="eventUploadProgressBar"></div>
          </div>
          <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem;">Max 10MB. PNG, JPG, or WebP.</p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Event Date (Display)</label>
            <input type="text" id="eventEventDate" placeholder="e.g., October 15, 2025">
          </div>
          <div class="form-group">
            <label>Time</label>
            <input type="text" id="eventTime" placeholder="e.g., 2:00 PM">
          </div>
        </div>
        
        <div class="form-group">
          <label>Location</label>
          <input type="text" id="eventLocation" placeholder="e.g., Hawaii Convention Center">
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Start Showing *</label>
            <input type="date" id="eventStartDate" required>
          </div>
          <div class="form-group">
            <label>Move to Past *</label>
            <input type="date" id="eventMoveToPastDate" required>
          </div>
          <div class="form-group">
            <label>Remove Date *</label>
            <input type="date" id="eventRemoveDate" required>
          </div>
        </div>
        
        <div class="form-group">
          <label>Signup Date/Time Options</label>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
            <input type="text" id="newSignupDate" placeholder="e.g., October 11, 2025 - 2:00 p.m." style="flex: 1;">
            <button type="button" class="btn-edit" onclick="addEventSignupDate()">Add</button>
          </div>
          <div id="signupDatesList" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
        </div>
        
        <div class="form-group">
          <label>Custom Questions</label>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
            <input type="text" id="newCustomQuestion" placeholder="e.g., Do you have experience?" style="flex: 1;">
            <button type="button" class="btn-edit" style="background: #10b981;" onclick="addEventCustomQuestion()">Add</button>
          </div>
          <div id="customQuestionsList" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeEventModal()">Cancel</button>
        <button class="btn-save" onclick="saveEvent()">Save Event</button>
      </div>
    </div>
  </div>

  <!-- Event Signups Modal -->
  <div class="modal-overlay" id="signupsModal">
    <div class="modal-box" style="max-width: 700px;">
      <div class="modal-header" style="background: #10b981;">
        <h3 id="signupsModalTitle" style="color: white;">Event Signups</h3>
        <button class="modal-close" onclick="closeSignupsModal()" style="color: white;">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <span id="signupsCount" style="color: var(--text-light);"></span>
          <button class="btn-export" onclick="exportEventSignupsToCSV()">üì• Export CSV</button>
        </div>
        <input type="hidden" id="signupsEventId">
        <div id="signupsList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeSignupsModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Opportunity Editor Modal -->
  <div class="modal-overlay" id="opportunityModal">
    <div class="modal-box" style="max-width: 600px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669);">
        <h3 id="opportunityModalTitle" style="color: white;">Add Volunteer Opportunity</h3>
        <button class="modal-close" onclick="closeOpportunityModal()" style="color: white;">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <input type="hidden" id="opportunityId">
        
        <div class="form-group">
          <label>Title *</label>
          <input type="text" id="opportunityTitle" placeholder="e.g., Event Assistant Needed" required>
        </div>
        
        <div class="form-group">
          <label>Description *</label>
          <textarea id="opportunityDescription" rows="4" placeholder="Describe the volunteer opportunity..." required></textarea>
        </div>
        
        <div class="form-group">
          <label>Requirements</label>
          <textarea id="opportunityRequirements" rows="2" placeholder="Any specific requirements (age, skills, etc.)"></textarea>
        </div>
        
        <div class="form-group">
          <label>Image</label>
          <input type="hidden" id="opportunityImageUrl">
          <div id="opportunityImagePreview" style="margin-bottom: 0.5rem;"></div>
          <input type="file" id="opportunityImageInput" accept="image/*" onchange="handleOpportunityImageUpload(event)">
          <div class="upload-progress" id="opportunityUploadProgress" style="display: none;">
            <div class="upload-progress-bar" id="opportunityUploadProgressBar"></div>
          </div>
          <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem;">Max 5MB</p>
        </div>
        
        <div class="form-group" style="background: #eff6ff; padding: 1rem; border-radius: 8px;">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="opportunityAlwaysPost" onchange="toggleOpportunityDates()">
            <strong>Always Post (Ongoing Opportunity)</strong>
          </label>
          <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem; margin-left: 1.5rem;">
            Check if this opportunity is always available
          </p>
        </div>
        
        <div id="opportunityDatesSection" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Start Date</label>
            <input type="date" id="opportunityStartDate">
          </div>
          <div class="form-group">
            <label>End Date</label>
            <input type="date" id="opportunityEndDate">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeOpportunityModal()">Cancel</button>
        <button class="btn-save" onclick="saveOpportunity()" style="background: linear-gradient(135deg, #10b981, #059669);">Save Opportunity</button>
      </div>
    </div>
  </div>

  <!-- Applications for Opportunity Modal -->
  <div class="modal-overlay" id="opportunityAppsModal">
    <div class="modal-box" style="max-width: 700px;">
      <div class="modal-header" style="background: #10b981;">
        <h3 id="opportunityAppsModalTitle" style="color: white;">Applications</h3>
        <button class="modal-close" onclick="closeOpportunityAppsModal()" style="color: white;">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <span id="opportunityAppsCount" style="color: var(--text-light);"></span>
        </div>
        <input type="hidden" id="opportunityAppsId">
        <div id="opportunityAppsList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeOpportunityAppsModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Category Editor Modal -->
  <div class="modal-overlay" id="categoryModal">
    <div class="modal-box" style="max-width: 450px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
        <h3 id="categoryModalTitle" style="color: white;">Add Category</h3>
        <button class="modal-close" onclick="closeCategoryModal()" style="color: white;">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="categoryId">
        <div class="form-group">
          <label>Category Name *</label>
          <input type="text" id="categoryName" placeholder="e.g., Getting Started" required>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeCategoryModal()">Cancel</button>
        <button class="btn-save" onclick="saveCategory()" style="background: linear-gradient(135deg, #f59e0b, #d97706);">Save Category</button>
      </div>
    </div>
  </div>

  <!-- FAQ Editor Modal -->
  <div class="modal-overlay" id="faqModal">
    <div class="modal-box" style="max-width: 600px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
        <h3 id="faqModalTitle" style="color: white;">Add FAQ</h3>
        <button class="modal-close" onclick="closeFaqModal()" style="color: white;">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <input type="hidden" id="faqId">
        
        <div class="form-group">
          <label>Category *</label>
          <select id="faqCategoryId" required>
            <!-- Populated dynamically -->
          </select>
        </div>
        
        <div class="form-group">
          <label>Question *</label>
          <input type="text" id="faqQuestion" placeholder="Enter the question" required>
        </div>
        
        <div class="form-group">
          <label>Summary</label>
          <textarea id="faqSummary" rows="3" placeholder="Brief summary or preview"></textarea>
        </div>
        
        <div class="form-group">
          <label>Action Steps</label>
          <div id="faqStepsList" style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.5rem;"></div>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" id="newFaqStep" placeholder="Add a new step" style="flex: 1;">
            <button type="button" class="btn-edit" onclick="addFaqStep()">Add</button>
          </div>
        </div>
        
        <div class="form-group">
          <label>Contact Info</label>
          <input type="text" id="faqContact" placeholder="Phone, email, or contact info" value="(808) 532-5364">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeFaqModal()">Cancel</button>
        <button class="btn-save" onclick="saveFaq()" style="background: linear-gradient(135deg, #f59e0b, #d97706);">Save FAQ</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAU3CQ07bCVKlJ1qGak-150kaJEyPKldLk",
      authDomain: "ldah-932d5.firebaseapp.com",
      projectId: "ldah-932d5",
      storageBucket: "ldah-932d5.firebasestorage.app",
      messagingSenderId: "662130454003",
      appId: "1:662130454003:web:437576d5a5811ecd8df686"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const storage = firebase.storage();
    const auth = firebase.auth();

    // Password
    const CMS_PASSWORD = 'ldah2024';
    const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2MB for team/board photos
    const MAX_GALLERY_FILE_SIZE = 5 * 1024 * 1024; // 5MB for gallery photos

    // State
    let teamMembers = [];
    let boardMembers = [];
    let galleryPhotos = [];
    let selectedPhotoFile = null;
    let selectedGalleryFile = null;
    let draggedItem = null;
    let draggedGalleryItem = null;

    // ===== Authentication =====
    function handleLogin(event) {
      event.preventDefault();
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('loginError');
      
      if (password === CMS_PASSWORD) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('cmsPanel').style.display = 'block';
        sessionStorage.setItem('cmsLoggedIn', 'true');
        initializeCMS();
      } else {
        errorDiv.textContent = 'Incorrect password. Please try again.';
        errorDiv.style.display = 'block';
        document.getElementById('password').value = '';
      }
    }
    
    function handleLogout() {
      sessionStorage.removeItem('cmsLoggedIn');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('cmsPanel').style.display = 'none';
      document.getElementById('password').value = '';
      document.getElementById('loginError').style.display = 'none';
    }

    // ===== Initialize CMS =====
    // Dashboard refresh debounce
    let dashboardRefreshTimeout = null;
    
    function scheduleDashboardRefresh() {
      // Debounce: wait for data loads to settle, then refresh dashboard
      if (dashboardRefreshTimeout) clearTimeout(dashboardRefreshTimeout);
      dashboardRefreshTimeout = setTimeout(() => {
        refreshDashboard();
      }, 500);
    }
    
    async function initializeCMS() {
      try {
        await auth.signInAnonymously();
        
        // Load all data - dashboard will auto-refresh after loads complete
        loadTeamMembers();
        loadBoardMembers();
        loadGallery();
        loadGallery2();
        loadResources();
        loadCategories();
        loadFaqs();
        loadEvents(); // This loads eventSignups too
        loadOpportunities();
        loadApplications();
        loadProviders();
        loadPledges();
        loadEventRequests();
        loadContacts();
        
        // Schedule dashboard refresh after data loads settle
        scheduleDashboardRefresh();
      } catch (error) {
        console.error('Firebase auth error:', error);
      }
    }

    // ===== Tab Navigation =====
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
      });
    });
    
    // Set analytics tab as active on load
    document.querySelector('.tab[data-tab="analytics"]').classList.add('active');

    // ===== Load Data =====
    async function loadTeamMembers() {
      const loading = document.getElementById('teamLoading');
      const empty = document.getElementById('teamEmpty');
      const grid = document.getElementById('teamGrid');
      
      loading.style.display = 'block';
      empty.style.display = 'none';
      grid.innerHTML = '';
      
      try {
        let snapshot;
        try {
          snapshot = await db.collection('teamMembers').orderBy('order').get();
        } catch (indexError) {
          console.log('Index not available, falling back to client-side sort');
          snapshot = await db.collection('teamMembers').get();
        }
        
        teamMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        teamMembers.sort((a, b) => (a.order || 0) - (b.order || 0));
        
        loading.style.display = 'none';
        
        if (teamMembers.length === 0) {
          empty.style.display = 'block';
        } else {
          renderPeopleGrid(teamMembers, 'team', grid);
        }
      } catch (error) {
        console.error('Error loading team:', error);
        loading.style.display = 'none';
        empty.style.display = 'block';
        empty.innerHTML = '<p>No team members yet. Click "Add Team Member" to get started!</p>';
      }
    }

    async function loadBoardMembers() {
      const loading = document.getElementById('boardLoading');
      const empty = document.getElementById('boardEmpty');
      const grid = document.getElementById('boardGrid');
      
      loading.style.display = 'block';
      empty.style.display = 'none';
      grid.innerHTML = '';
      
      try {
        let snapshot;
        try {
          snapshot = await db.collection('boardMembers').orderBy('order').get();
        } catch (indexError) {
          console.log('Index not available, falling back to client-side sort');
          snapshot = await db.collection('boardMembers').get();
        }
        
        boardMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        boardMembers.sort((a, b) => (a.order || 0) - (b.order || 0));
        
        loading.style.display = 'none';
        
        if (boardMembers.length === 0) {
          empty.style.display = 'block';
        } else {
          renderPeopleGrid(boardMembers, 'board', grid);
        }
      } catch (error) {
        console.error('Error loading board:', error);
        loading.style.display = 'none';
        empty.style.display = 'block';
        empty.innerHTML = '<p>No board members yet. Click "Add Board Member" to get started!</p>';
      }
    }

    // ===== Render Grid =====
    function renderPeopleGrid(people, type, container) {
      container.innerHTML = '';
      
      people.forEach((person, index) => {
        const card = document.createElement('div');
        card.className = 'person-card';
        card.draggable = true;
        card.dataset.id = person.id;
        card.dataset.type = type;
        
        const photoHtml = person.photoUrl 
          ? `<img src="${person.photoUrl}" alt="${person.name}" class="person-photo">`
          : `<div class="person-photo-placeholder">üë§</div>`;
        
        const contactHtml = type === 'team' ? `
          <div class="contact">
            ${person.phone ? `üìû ${person.phone}` : ''}
            ${person.phone && person.email ? ' ‚Ä¢ ' : ''}
            ${person.email ? `‚úâÔ∏è ${person.email}` : ''}
          </div>
        ` : '';
        
        card.innerHTML = `
          <div class="order-badge">${index + 1}</div>
          <div class="drag-handle">‚ãÆ‚ãÆ</div>
          <div class="person-card-header">
            ${photoHtml}
            <div class="person-info">
              <h4>${person.name}</h4>
              <div class="role">${person.role}</div>
              ${contactHtml}
            </div>
          </div>
          <div class="person-actions">
            <button class="btn-edit" onclick="editPerson('${type}', '${person.id}')">‚úèÔ∏è Edit</button>
            <button class="btn-delete" onclick="deletePerson('${type}', '${person.id}', '${person.name}', '${person.photoUrl || ''}')">üóëÔ∏è Delete</button>
          </div>
        `;
        
        // Drag events
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragleave', handleDragLeave);
        
        container.appendChild(card);
      });
    }

    // ===== Drag and Drop =====
    function handleDragStart(e) {
      draggedItem = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('.person-card').forEach(card => {
        card.classList.remove('drag-over');
      });
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      if (this !== draggedItem && this.dataset.type === draggedItem.dataset.type) {
        this.classList.add('drag-over');
      }
    }

    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }

    async function handleDrop(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
      
      if (this === draggedItem || this.dataset.type !== draggedItem.dataset.type) return;
      
      const type = this.dataset.type;
      const collection = type === 'team' ? 'teamMembers' : 'boardMembers';
      const members = type === 'team' ? teamMembers : boardMembers;
      const grid = document.getElementById(type + 'Grid');
      
      const draggedId = draggedItem.dataset.id;
      const targetId = this.dataset.id;
      
      const draggedIndex = members.findIndex(m => m.id === draggedId);
      const targetIndex = members.findIndex(m => m.id === targetId);
      
      // Reorder array
      const [removed] = members.splice(draggedIndex, 1);
      members.splice(targetIndex, 0, removed);
      
      // Update order in Firestore
      const batch = db.batch();
      members.forEach((member, index) => {
        const ref = db.collection(collection).doc(member.id);
        batch.update(ref, { order: index });
        member.order = index;
      });
      
      try {
        await batch.commit();
        renderPeopleGrid(members, type, grid);
        showSuccess(type);
      } catch (error) {
        console.error('Error updating order:', error);
        alert('Failed to update order. Please try again.');
      }
    }

    // ===== Modal Functions =====
    function openPersonModal(type, person = null) {
      document.getElementById('personModal').classList.add('active');
      document.getElementById('personType').value = type;
      
      const isTeam = type === 'team';
      document.getElementById('phoneGroup').style.display = isTeam ? 'block' : 'none';
      document.getElementById('emailGroup').style.display = isTeam ? 'block' : 'none';
      
      if (person) {
        document.getElementById('modalTitle').textContent = isTeam ? 'Edit Team Member' : 'Edit Board Member';
        document.getElementById('personId').value = person.id;
        document.getElementById('personName').value = person.name || '';
        document.getElementById('personRole').value = person.role || '';
        document.getElementById('personPhone').value = person.phone || '';
        document.getElementById('personEmail').value = person.email || '';
        document.getElementById('personPhotoUrl').value = person.photoUrl || '';
        
        if (person.photoUrl) {
          document.getElementById('photoPreviewContainer').innerHTML = 
            `<img src="${person.photoUrl}" class="photo-preview" id="photoPreview">`;
        } else {
          document.getElementById('photoPreviewContainer').innerHTML = 
            `<div class="photo-preview-placeholder" id="photoPlaceholder">üë§</div>`;
        }
      } else {
        document.getElementById('modalTitle').textContent = isTeam ? 'Add Team Member' : 'Add Board Member';
        document.getElementById('personId').value = '';
        document.getElementById('personName').value = '';
        document.getElementById('personRole').value = '';
        document.getElementById('personPhone').value = '';
        document.getElementById('personEmail').value = '';
        document.getElementById('personPhotoUrl').value = '';
        document.getElementById('photoPreviewContainer').innerHTML = 
          `<div class="photo-preview-placeholder" id="photoPlaceholder">üë§</div>`;
      }
      
      selectedPhotoFile = null;
      document.getElementById('photoInput').value = '';
    }

    function closePersonModal() {
      document.getElementById('personModal').classList.remove('active');
      selectedPhotoFile = null;
    }

    function editPerson(type, id) {
      const members = type === 'team' ? teamMembers : boardMembers;
      const person = members.find(m => m.id === id);
      if (person) {
        openPersonModal(type, person);
      }
    }

    // ===== Photo Handling =====
    function handlePhotoSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > MAX_FILE_SIZE) {
        alert('Photo must be under 2MB. Please choose a smaller image.');
        event.target.value = '';
        return;
      }
      
      if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
        alert('Please select a JPG, PNG, or WebP image.');
        event.target.value = '';
        return;
      }
      
      selectedPhotoFile = file;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('photoPreviewContainer').innerHTML = 
          `<img src="${e.target.result}" class="photo-preview" id="photoPreview">`;
      };
      reader.readAsDataURL(file);
    }

    async function uploadPhoto(file, personId, type) {
      const extension = file.name.split('.').pop();
      const filename = `${type}/${personId}_${Date.now()}.${extension}`;
      const storageRef = storage.ref(filename);
      
      const progressBar = document.getElementById('uploadProgress');
      const progressFill = document.getElementById('uploadProgressBar');
      progressBar.style.display = 'block';
      
      return new Promise((resolve, reject) => {
        const uploadTask = storageRef.put(file);
        
        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressFill.style.width = progress + '%';
          },
          (error) => {
            progressBar.style.display = 'none';
            reject(error);
          },
          async () => {
            progressBar.style.display = 'none';
            const downloadUrl = await uploadTask.snapshot.ref.getDownloadURL();
            resolve(downloadUrl);
          }
        );
      });
    }

    async function deletePhotoFromStorage(photoUrl) {
      if (!photoUrl || !photoUrl.includes('firebase')) return;
      
      try {
        const photoRef = storage.refFromURL(photoUrl);
        await photoRef.delete();
      } catch (error) {
        console.error('Error deleting photo:', error);
        // Don't throw - photo deletion failure shouldn't block other operations
      }
    }

    // ===== Save Person =====
    async function savePerson() {
      const name = document.getElementById('personName').value.trim();
      const role = document.getElementById('personRole').value.trim();
      const type = document.getElementById('personType').value;
      const existingId = document.getElementById('personId').value;
      const existingPhotoUrl = document.getElementById('personPhotoUrl').value;
      
      if (!name || !role) {
        alert('Please fill in Name and Role.');
        return;
      }
      
      const saveBtn = document.getElementById('savePersonBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      
      try {
        const collection = type === 'team' ? 'teamMembers' : 'boardMembers';
        const members = type === 'team' ? teamMembers : boardMembers;
        
        let photoUrl = existingPhotoUrl;
        
        // Upload new photo if selected
        if (selectedPhotoFile) {
          const tempId = existingId || db.collection(collection).doc().id;
          
          // Delete old photo if replacing
          if (existingPhotoUrl) {
            await deletePhotoFromStorage(existingPhotoUrl);
          }
          
          photoUrl = await uploadPhoto(selectedPhotoFile, tempId, type);
        }
        
        const personData = {
          name,
          role,
          photoUrl: photoUrl || '',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (type === 'team') {
          personData.phone = document.getElementById('personPhone').value.trim();
          personData.email = document.getElementById('personEmail').value.trim();
        }
        
        if (existingId) {
          // Update existing
          await db.collection(collection).doc(existingId).update(personData);
        } else {
          // Add new
          personData.order = members.length;
          personData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection(collection).add(personData);
        }
        
        closePersonModal();
        
        if (type === 'team') {
          await loadTeamMembers();
        } else {
          await loadBoardMembers();
        }
        
        showSuccess(type);
        
      } catch (error) {
        console.error('Error saving person:', error);
        alert('Failed to save. Please try again.');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
      }
    }

    // ===== Delete Person =====
    function deletePerson(type, id, name, photoUrl) {
      document.getElementById('deletePersonId').value = id;
      document.getElementById('deletePersonType').value = type;
      document.getElementById('deletePersonName').textContent = name;
      document.getElementById('deletePhotoUrl').value = photoUrl;
      document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
    }

    async function confirmDelete() {
      const id = document.getElementById('deletePersonId').value;
      const type = document.getElementById('deletePersonType').value;
      const photoUrl = document.getElementById('deletePhotoUrl').value;
      
      try {
        const collection = type === 'team' ? 'teamMembers' : 'boardMembers';
        
        // Delete from Firestore
        await db.collection(collection).doc(id).delete();
        
        // Delete photo from storage
        if (photoUrl) {
          await deletePhotoFromStorage(photoUrl);
        }
        
        closeDeleteModal();
        
        if (type === 'team') {
          await loadTeamMembers();
        } else {
          await loadBoardMembers();
        }
        
        showSuccess(type);
        
      } catch (error) {
        console.error('Error deleting person:', error);
        alert('Failed to delete. Please try again.');
      }
    }

    // ===== RESOURCES MANAGEMENT =====
    let resources = [];
    let filteredResources = [];

    // Load resources from Firebase
    async function loadResources() {
      const loading = document.getElementById('resourcesLoading');
      const empty = document.getElementById('resourcesEmpty');
      const grid = document.getElementById('resourcesGrid');
      const countEl = document.getElementById('resourcesCount');
      
      loading.style.display = 'block';
      empty.style.display = 'none';
      grid.innerHTML = '';
      
      try {
        let snapshot;
        try {
          snapshot = await db.collection('resources').orderBy('name').get();
        } catch (indexError) {
          console.log('Index not available, using unordered query');
          snapshot = await db.collection('resources').get();
        }
        
        resources = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        resources.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        
        loading.style.display = 'none';
        
        if (resources.length === 0) {
          empty.style.display = 'block';
          countEl.textContent = '';
        } else {
          countEl.textContent = `Showing ${resources.length} resources`;
          filteredResources = [...resources];
          renderResourcesGrid();
        }
      } catch (error) {
        console.error('Error loading resources:', error);
        loading.style.display = 'none';
        empty.style.display = 'block';
        empty.innerHTML = '<p>Error loading resources. Please refresh.</p>';
      }
    }

    // Filter resources list
    function filterResourcesList() {
      const searchTerm = document.getElementById('resourceSearch').value.toLowerCase();
      const countEl = document.getElementById('resourcesCount');
      
      if (!searchTerm) {
        filteredResources = [...resources];
      } else {
        filteredResources = resources.filter(r => 
          (r.name || '').toLowerCase().includes(searchTerm) ||
          (r.services || '').toLowerCase().includes(searchTerm) ||
          (r.city || '').toLowerCase().includes(searchTerm) ||
          (r.type || '').toLowerCase().includes(searchTerm) ||
          (r.person || '').toLowerCase().includes(searchTerm)
        );
      }
      
      countEl.textContent = `Showing ${filteredResources.length} of ${resources.length} resources`;
      renderResourcesGrid();
    }

    // Render resources grid
    function renderResourcesGrid() {
      const grid = document.getElementById('resourcesGrid');
      grid.innerHTML = '';
      
      if (filteredResources.length === 0) {
        grid.innerHTML = '<div class="empty-state"><p>No matching resources found.</p></div>';
        return;
      }
      
      filteredResources.forEach(resource => {
        const card = document.createElement('div');
        card.className = 'resource-card';
        
        const logoHtml = resource.logo 
          ? `<img src="${resource.logo}" alt="${resource.name}" class="resource-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
             <div class="resource-logo-placeholder" style="display:none;">üè¢</div>`
          : `<div class="resource-logo-placeholder">üè¢</div>`;
        
        const island = resource.island || 'Statewide';
        const phone = resource.phone || '';
        const email = resource.email || '';
        
        card.innerHTML = `
          ${logoHtml}
          <div class="resource-info">
            <div class="resource-type-badge">${resource.type || 'Specialized Resources'}</div>
            <h4>${resource.name || 'Unnamed Resource'}</h4>
            <div class="resource-meta">
              <span>üìç ${island}</span>
              ${phone ? `<span>üìû ${phone}</span>` : ''}
              ${email ? `<span>‚úâÔ∏è ${email}</span>` : ''}
            </div>
          </div>
          <div class="resource-actions">
            <button class="btn-edit" onclick="editResource('${resource.id}')">‚úèÔ∏è Edit</button>
            <button class="btn-delete" onclick="deleteResource('${resource.id}', '${(resource.name || '').replace(/'/g, "\\'")}')">üóëÔ∏è</button>
          </div>
        `;
        
        grid.appendChild(card);
      });
    }

    // Open resource modal for add/edit
    function openResourceModal(resource = null) {
      document.getElementById('resourceModal').classList.add('active');
      
      // Reset file input and preview
      document.getElementById('resourceLogoFileInput').value = '';
      const preview = document.getElementById('resourceLogoPreview');
      const placeholder = document.getElementById('resourceLogoPlaceholder');
      document.getElementById('resourceLogoUploadProgress').style.display = 'none';
      
      if (resource) {
        document.getElementById('resourceModalTitle').textContent = 'Edit Resource';
        document.getElementById('resourceId').value = resource.id;
        document.getElementById('resourceName').value = resource.name || '';
        document.getElementById('resourceType').value = resource.type || 'Specialized Resources';
        document.getElementById('resourcePerson').value = resource.person || '';
        document.getElementById('resourcePhone').value = resource.phone || '';
        document.getElementById('resourceFax').value = resource.fax || '';
        document.getElementById('resourceEmail').value = resource.email || '';
        document.getElementById('resourceWebsite').value = resource.website || '';
        document.getElementById('resourceAddress').value = resource.address || '';
        document.getElementById('resourceCity').value = resource.city || '';
        document.getElementById('resourceState').value = resource.state || 'HI';
        document.getElementById('resourceZip').value = resource.zip || '';
        document.getElementById('resourceIsland').value = resource.island || '';
        document.getElementById('resourceServices').value = resource.services || '';
        document.getElementById('resourceNotes').value = resource.notes || '';
        document.getElementById('resourceLogoInput').value = resource.logo || '';
        document.getElementById('resourceLogoUrl').value = resource.logo || '';
        
        // Show existing logo preview
        if (resource.logo) {
          preview.src = resource.logo;
          preview.style.display = 'block';
          placeholder.style.display = 'none';
        } else {
          preview.style.display = 'none';
          placeholder.style.display = 'flex';
        }
      } else {
        document.getElementById('resourceModalTitle').textContent = 'Add Resource';
        document.getElementById('resourceId').value = '';
        document.getElementById('resourceName').value = '';
        document.getElementById('resourceType').value = 'Specialized Resources';
        document.getElementById('resourcePerson').value = '';
        document.getElementById('resourcePhone').value = '';
        document.getElementById('resourceFax').value = '';
        document.getElementById('resourceEmail').value = '';
        document.getElementById('resourceWebsite').value = '';
        document.getElementById('resourceAddress').value = '';
        document.getElementById('resourceCity').value = '';
        document.getElementById('resourceState').value = 'HI';
        document.getElementById('resourceZip').value = '';
        document.getElementById('resourceIsland').value = '';
        document.getElementById('resourceServices').value = '';
        document.getElementById('resourceNotes').value = '';
        document.getElementById('resourceLogoInput').value = '';
        document.getElementById('resourceLogoUrl').value = '';
        
        // Reset preview
        preview.style.display = 'none';
        placeholder.style.display = 'flex';
      }
    }

    function closeResourceModal() {
      document.getElementById('resourceModal').classList.remove('active');
    }

    function editResource(id) {
      const resource = resources.find(r => r.id === id);
      if (resource) {
        openResourceModal(resource);
      }
    }

    // Save resource
    async function saveResource() {
      const name = document.getElementById('resourceName').value.trim();
      const type = document.getElementById('resourceType').value;
      const existingId = document.getElementById('resourceId').value;
      
      if (!name) {
        alert('Please enter an organization name.');
        return;
      }
      
      const saveBtn = document.getElementById('saveResourceBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      
      try {
        // Handle logo upload if file selected
        let finalLogoUrl = document.getElementById('resourceLogoInput').value.trim() || document.getElementById('resourceLogoUrl').value.trim();
        const fileInput = document.getElementById('resourceLogoFileInput');
        const file = fileInput.files[0];
        
        if (file) {
          const progressBar = document.getElementById('resourceLogoUploadProgress');
          const progressBarInner = document.getElementById('resourceLogoUploadProgressBar');
          progressBar.style.display = 'block';
          
          const timestamp = Date.now();
          const safeName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
          const storageRef = storage.ref(`resources/${timestamp}_${safeName}`);
          
          const uploadTask = storageRef.put(file);
          
          await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
              (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progressBarInner.style.width = progress + '%';
              },
              reject,
              async () => {
                finalLogoUrl = await uploadTask.snapshot.ref.getDownloadURL();
                resolve();
              }
            );
          });
          
          progressBar.style.display = 'none';
        }
        
        const resourceData = {
          name,
          type,
          person: document.getElementById('resourcePerson').value.trim(),
          phone: document.getElementById('resourcePhone').value.trim(),
          fax: document.getElementById('resourceFax').value.trim(),
          email: document.getElementById('resourceEmail').value.trim(),
          website: document.getElementById('resourceWebsite').value.trim(),
          address: document.getElementById('resourceAddress').value.trim(),
          city: document.getElementById('resourceCity').value.trim(),
          state: document.getElementById('resourceState').value.trim() || 'HI',
          zip: document.getElementById('resourceZip').value.trim(),
          island: document.getElementById('resourceIsland').value,
          services: document.getElementById('resourceServices').value.trim(),
          notes: document.getElementById('resourceNotes').value.trim(),
          logo: finalLogoUrl,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (existingId) {
          await db.collection('resources').doc(existingId).update(resourceData);
        } else {
          resourceData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          resourceData.order = resources.length;
          await db.collection('resources').add(resourceData);
        }
        
        closeResourceModal();
        await loadResources();
        showSuccess('resources');
        
      } catch (error) {
        console.error('Error saving resource:', error);
        alert('Failed to save resource. Please try again.');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Resource';
      }
    }

    // Delete resource
    function deleteResource(id, name) {
      document.getElementById('deleteResourceId').value = id;
      document.getElementById('deleteResourceName').textContent = name;
      document.getElementById('deleteResourceModal').classList.add('active');
    }

    function closeDeleteResourceModal() {
      document.getElementById('deleteResourceModal').classList.remove('active');
    }

    async function confirmDeleteResource() {
      const id = document.getElementById('deleteResourceId').value;
      
      try {
        await db.collection('resources').doc(id).delete();
        closeDeleteResourceModal();
        await loadResources();
        showSuccess('resources');
      } catch (error) {
        console.error('Error deleting resource:', error);
        alert('Failed to delete resource. Please try again.');
      }
    }
    
    // Handle resource logo file selection
    function handleResourceLogoSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Check file size (2MB max)
      if (file.size > 2 * 1024 * 1024) {
        alert('Logo file must be less than 2MB');
        event.target.value = '';
        return;
      }
      
      // Check file type
      if (!file.type.match(/^image\/(jpeg|png|webp|gif)$/)) {
        alert('Please select a JPG, PNG, WebP, or GIF image');
        event.target.value = '';
        return;
      }
      
      // Show preview
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('resourceLogoPreview');
        const placeholder = document.getElementById('resourceLogoPlaceholder');
        preview.src = e.target.result;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
        
        // Clear URL input since we're using file upload
        document.getElementById('resourceLogoInput').value = '';
      };
      reader.readAsDataURL(file);
    }
    
    // Preview resource logo from URL input
    function previewResourceLogoUrl() {
      const url = document.getElementById('resourceLogoInput').value.trim();
      const preview = document.getElementById('resourceLogoPreview');
      const placeholder = document.getElementById('resourceLogoPlaceholder');
      
      if (url) {
        preview.src = url;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
        
        // Clear file input since we're using URL
        document.getElementById('resourceLogoFileInput').value = '';
        
        // Store the URL in hidden field
        document.getElementById('resourceLogoUrl').value = url;
      } else {
        preview.style.display = 'none';
        placeholder.style.display = 'flex';
      }
    }

    // ===== Gallery Functions =====
    async function loadGallery() {
      const loading = document.getElementById('galleryLoading');
      const empty = document.getElementById('galleryEmpty');
      const grid = document.getElementById('galleryGrid');
      const countEl = document.getElementById('galleryCount');
      
      loading.style.display = 'block';
      empty.style.display = 'none';
      grid.innerHTML = '';
      
      try {
        let snapshot;
        try {
          snapshot = await db.collection('gallery').orderBy('order').get();
        } catch (indexError) {
          console.log('Index not available, falling back to client-side sort');
          snapshot = await db.collection('gallery').get();
        }
        
        galleryPhotos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        galleryPhotos.sort((a, b) => (a.order || 0) - (b.order || 0));
        
        loading.style.display = 'none';
        
        if (galleryPhotos.length === 0) {
          empty.style.display = 'block';
          countEl.textContent = '';
        } else {
          countEl.textContent = `${galleryPhotos.length} photos in gallery`;
          renderGalleryGrid();
        }
      } catch (error) {
        console.error('Error loading gallery:', error);
        loading.style.display = 'none';
        empty.style.display = 'block';
        empty.innerHTML = `
          <p>Error loading gallery. Make sure Firestore rules are deployed.</p>
          <button class="btn-add-person" onclick="openGalleryModal()" style="background: linear-gradient(135deg, #10b981, #059669); margin-top: 1rem;">+ Add Your First Photo</button>
        `;
      }
    }
    
    function renderGalleryGrid() {
      const grid = document.getElementById('galleryGrid');
      grid.innerHTML = '';
      
      galleryPhotos.forEach((photo, index) => {
        const card = document.createElement('div');
        card.className = 'gallery-card';
        card.draggable = true;
        card.dataset.id = photo.id;
        card.dataset.index = index;
        
        // Drag events
        card.addEventListener('dragstart', handleGalleryDragStart);
        card.addEventListener('dragend', handleGalleryDragEnd);
        card.addEventListener('dragover', handleGalleryDragOver);
        card.addEventListener('dragleave', handleGalleryDragLeave);
        card.addEventListener('drop', handleGalleryDrop);
        
        card.innerHTML = `
          <div class="gallery-order-badge">${index + 1}</div>
          <div class="gallery-drag-handle">‚ãÆ‚ãÆ</div>
          ${photo.imageUrl 
            ? `<img src="${photo.imageUrl}" alt="${photo.caption || 'Gallery photo'}" class="gallery-card-image" onerror="this.onerror=null; this.parentElement.innerHTML = this.parentElement.innerHTML.replace(/<img[^>]*>/, '<div class=\\'gallery-card-placeholder\\'>üì∑</div>');">`
            : '<div class="gallery-card-placeholder">üì∑</div>'
          }
          <div class="gallery-card-info">
            <h4>${photo.caption || 'Untitled'}</h4>
          </div>
          <div class="gallery-card-actions">
            <button class="btn-edit" onclick="editGalleryPhoto('${photo.id}')">‚úèÔ∏è Edit</button>
            <button class="btn-delete" onclick="deleteGalleryPhoto('${photo.id}', '${(photo.caption || '').replace(/'/g, "\\'")}', '${photo.imageUrl || ''}')">üóëÔ∏è</button>
          </div>
        `;
        
        grid.appendChild(card);
      });
    }
    
    // Gallery Drag and Drop
    function handleGalleryDragStart(e) {
      draggedGalleryItem = e.target.closest('.gallery-card');
      draggedGalleryItem.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleGalleryDragEnd(e) {
      if (draggedGalleryItem) {
        draggedGalleryItem.classList.remove('dragging');
      }
      document.querySelectorAll('.gallery-card').forEach(card => {
        card.classList.remove('drag-over');
      });
      draggedGalleryItem = null;
    }
    
    function handleGalleryDragOver(e) {
      e.preventDefault();
      const card = e.target.closest('.gallery-card');
      if (card && card !== draggedGalleryItem) {
        card.classList.add('drag-over');
      }
    }
    
    function handleGalleryDragLeave(e) {
      const card = e.target.closest('.gallery-card');
      if (card) {
        card.classList.remove('drag-over');
      }
    }
    
    async function handleGalleryDrop(e) {
      e.preventDefault();
      const targetCard = e.target.closest('.gallery-card');
      
      if (!targetCard || !draggedGalleryItem || targetCard === draggedGalleryItem) return;
      
      targetCard.classList.remove('drag-over');
      
      const draggedId = draggedGalleryItem.dataset.id;
      const targetId = targetCard.dataset.id;
      
      const draggedIndex = galleryPhotos.findIndex(p => p.id === draggedId);
      const targetIndex = galleryPhotos.findIndex(p => p.id === targetId);
      
      // Reorder array
      const [removed] = galleryPhotos.splice(draggedIndex, 1);
      galleryPhotos.splice(targetIndex, 0, removed);
      
      // Update order in Firebase
      const batch = db.batch();
      galleryPhotos.forEach((photo, index) => {
        const ref = db.collection('gallery').doc(photo.id);
        batch.update(ref, { order: index });
      });
      
      try {
        await batch.commit();
        renderGalleryGrid();
        showSuccess('gallery');
      } catch (error) {
        console.error('Error reordering gallery:', error);
        loadGallery(); // Reload on error
      }
    }
    
    // Gallery Modal Functions
    function openGalleryModal(photo = null) {
      document.getElementById('galleryModal').classList.add('active');
      selectedGalleryFile = null;
      
      // Reset preview
      document.getElementById('galleryPreviewContainer').innerHTML = 
        '<div class="photo-preview-placeholder" id="galleryPlaceholder" style="width: 200px; height: 150px; border-radius: 8px; font-size: 3rem;">üì∑</div>';
      document.getElementById('galleryUploadProgress').style.display = 'none';
      
      if (photo) {
        document.getElementById('galleryModalTitle').textContent = 'Edit Photo';
        document.getElementById('galleryPhotoId').value = photo.id;
        document.getElementById('galleryPhotoUrl').value = photo.imageUrl || '';
        document.getElementById('galleryCaption').value = photo.caption || '';
        document.getElementById('galleryImageUrl').value = photo.imageUrl || '';
        
        if (photo.imageUrl) {
          document.getElementById('galleryPreviewContainer').innerHTML = 
            `<img src="${photo.imageUrl}" style="width: 200px; height: 150px; object-fit: cover; border-radius: 8px;">`;
        }
      } else {
        document.getElementById('galleryModalTitle').textContent = 'Add Photo';
        document.getElementById('galleryPhotoId').value = '';
        document.getElementById('galleryPhotoUrl').value = '';
        document.getElementById('galleryCaption').value = '';
        document.getElementById('galleryImageUrl').value = '';
      }
    }
    
    function closeGalleryModal() {
      document.getElementById('galleryModal').classList.remove('active');
      selectedGalleryFile = null;
    }
    
    function editGalleryPhoto(id) {
      const photo = galleryPhotos.find(p => p.id === id);
      if (photo) {
        openGalleryModal(photo);
      }
    }
    
    function handleGalleryPhotoSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > MAX_GALLERY_FILE_SIZE) {
        alert('Photo must be smaller than 5MB.');
        return;
      }
      
      if (!file.type.match(/^image\/(jpeg|png|webp)$/)) {
        alert('Please select a JPG, PNG, or WebP image.');
        return;
      }
      
      selectedGalleryFile = file;
      
      // Preview
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('galleryPreviewContainer').innerHTML = 
          `<img src="${e.target.result}" style="width: 200px; height: 150px; object-fit: cover; border-radius: 8px;">`;
        document.getElementById('galleryImageUrl').value = ''; // Clear URL input
      };
      reader.readAsDataURL(file);
    }
    
    function previewGalleryUrl() {
      const url = document.getElementById('galleryImageUrl').value.trim();
      if (url) {
        document.getElementById('galleryPreviewContainer').innerHTML = 
          `<img src="${url}" style="width: 200px; height: 150px; object-fit: cover; border-radius: 8px;" onerror="this.parentElement.innerHTML = '<div class=\\'photo-preview-placeholder\\' style=\\'width: 200px; height: 150px; border-radius: 8px; font-size: 3rem;\\'>‚ùå</div>';">`;
        selectedGalleryFile = null; // Clear file selection
      }
    }
    
    async function saveGalleryPhoto() {
      const caption = document.getElementById('galleryCaption').value.trim();
      const urlInput = document.getElementById('galleryImageUrl').value.trim();
      const existingId = document.getElementById('galleryPhotoId').value;
      const existingUrl = document.getElementById('galleryPhotoUrl').value;
      
      if (!caption) {
        alert('Please enter a caption for the photo.');
        return;
      }
      
      if (!selectedGalleryFile && !urlInput && !existingUrl) {
        alert('Please select a photo or enter an image URL.');
        return;
      }
      
      const saveBtn = document.getElementById('saveGalleryBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      
      try {
        let imageUrl = urlInput || existingUrl;
        
        // Upload new file if selected
        if (selectedGalleryFile) {
          const progressBar = document.getElementById('galleryUploadProgress');
          const progressFill = document.getElementById('galleryUploadProgressBar');
          progressBar.style.display = 'block';
          
          const fileName = `gallery/${Date.now()}_${selectedGalleryFile.name}`;
          const storageRef = storage.ref(fileName);
          const uploadTask = storageRef.put(selectedGalleryFile);
          
          imageUrl = await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
              (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progressFill.style.width = progress + '%';
              },
              reject,
              async () => {
                const url = await uploadTask.snapshot.ref.getDownloadURL();
                resolve(url);
              }
            );
          });
          
          progressBar.style.display = 'none';
        }
        
        const photoData = {
          caption,
          imageUrl,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (existingId) {
          await db.collection('gallery').doc(existingId).update(photoData);
        } else {
          photoData.order = galleryPhotos.length;
          photoData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('gallery').add(photoData);
        }
        
        closeGalleryModal();
        await loadGallery();
        showSuccess('gallery');
        
      } catch (error) {
        console.error('Error saving photo:', error);
        alert('Failed to save photo. Please try again.');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Photo';
      }
    }
    
    function deleteGalleryPhoto(id, caption, imageUrl) {
      document.getElementById('deleteGalleryId').value = id;
      document.getElementById('deleteGalleryPhotoUrl').value = imageUrl;
      document.getElementById('deleteGalleryPreview').src = imageUrl;
      document.getElementById('deleteGalleryModal').classList.add('active');
    }
    
    function closeDeleteGalleryModal() {
      document.getElementById('deleteGalleryModal').classList.remove('active');
    }
    
    async function confirmDeleteGallery() {
      const id = document.getElementById('deleteGalleryId').value;
      const photoUrl = document.getElementById('deleteGalleryPhotoUrl').value;
      
      try {
        // Delete from Firestore
        await db.collection('gallery').doc(id).delete();
        
        // Try to delete from Storage if it's a Firebase Storage URL
        if (photoUrl && photoUrl.includes('firebasestorage.googleapis.com')) {
          try {
            const storageRef = storage.refFromURL(photoUrl);
            await storageRef.delete();
          } catch (e) {
            console.log('Could not delete from storage:', e);
          }
        }
        
        closeDeleteGalleryModal();
        await loadGallery();
        showSuccess('gallery');
      } catch (error) {
        console.error('Error deleting photo:', error);
        alert('Failed to delete photo. Please try again.');
      }
    }

    // ===== Gallery 2 Functions =====
    let gallery2Photos = [];
    let draggedGallery2Card = null;

    async function loadGallery2() {
      const loading = document.getElementById('gallery2Loading');
      const empty = document.getElementById('gallery2Empty');
      const grid = document.getElementById('gallery2Grid');
      const count = document.getElementById('gallery2Count');
      
      if (!loading) return;
      loading.style.display = 'block';
      empty.style.display = 'none';
      grid.innerHTML = '';
      
      try {
        const snapshot = await db.collection('gallery2').orderBy('order').get();
        gallery2Photos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        loading.style.display = 'none';
        
        if (gallery2Photos.length === 0) {
          empty.style.display = 'block';
          count.textContent = '';
        } else {
          count.textContent = `${gallery2Photos.length} photo${gallery2Photos.length === 1 ? '' : 's'}`;
          renderGallery2Grid();
        }
      } catch (error) {
        console.error('Error loading gallery2:', error);
        loading.style.display = 'none';
        empty.style.display = 'block';
      }
    }

    function renderGallery2Grid() {
      const grid = document.getElementById('gallery2Grid');
      grid.innerHTML = gallery2Photos.map((photo, index) => `
        <div class="gallery-card" draggable="true" data-id="${photo.id}" data-index="${index}"
             ondragstart="handleGallery2DragStart(event)" ondragend="handleGallery2DragEnd(event)"
             ondragover="handleGallery2DragOver(event)" ondragleave="handleGallery2DragLeave(event)"
             ondrop="handleGallery2Drop(event)">
          <div class="gallery-drag-handle">‚ãÆ‚ãÆ</div>
          <div class="gallery-order-badge">${index + 1}</div>
          ${photo.imageUrl 
            ? `<img src="${photo.imageUrl}" alt="${photo.caption || ''}" class="gallery-card-image">`
            : `<div class="gallery-card-placeholder">üì∑</div>`
          }
          <div class="gallery-card-info">
            <h4>${photo.caption || 'Untitled'}</h4>
          </div>
          <div class="gallery-card-actions">
            <button class="btn-edit" onclick="editGallery2Photo('${photo.id}')">‚úèÔ∏è Edit</button>
            <button class="btn-delete" onclick="deleteGallery2Photo('${photo.id}', '${(photo.caption || '').replace(/'/g, "\\'")}', '${photo.imageUrl || ''}')">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function handleGallery2DragStart(e) {
      draggedGallery2Card = e.target.closest('.gallery-card');
      draggedGallery2Card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleGallery2DragEnd(e) {
      if (draggedGallery2Card) {
        draggedGallery2Card.classList.remove('dragging');
      }
      document.querySelectorAll('#gallery2Grid .gallery-card').forEach(card => {
        card.classList.remove('drag-over');
      });
      draggedGallery2Card = null;
    }

    function handleGallery2DragOver(e) {
      e.preventDefault();
      const card = e.target.closest('.gallery-card');
      if (card && card !== draggedGallery2Card) {
        card.classList.add('drag-over');
      }
    }

    function handleGallery2DragLeave(e) {
      const card = e.target.closest('.gallery-card');
      if (card) {
        card.classList.remove('drag-over');
      }
    }

    async function handleGallery2Drop(e) {
      e.preventDefault();
      const targetCard = e.target.closest('.gallery-card');
      if (!targetCard || !draggedGallery2Card || targetCard === draggedGallery2Card) return;

      const draggedId = draggedGallery2Card.dataset.id;
      const targetId = targetCard.dataset.id;
      
      const draggedIndex = gallery2Photos.findIndex(p => p.id === draggedId);
      const targetIndex = gallery2Photos.findIndex(p => p.id === targetId);
      
      const [movedPhoto] = gallery2Photos.splice(draggedIndex, 1);
      gallery2Photos.splice(targetIndex, 0, movedPhoto);
      
      renderGallery2Grid();
      
      const batch = db.batch();
      gallery2Photos.forEach((photo, index) => {
        batch.update(db.collection('gallery2').doc(photo.id), { order: index });
      });
      
      try {
        await batch.commit();
        showSuccess('gallery2');
      } catch (error) {
        console.error('Error updating gallery2 order:', error);
        await loadGallery2();
      }
    }

    function openGallery2Modal(photo = null) {
      const modal = document.getElementById('gallery2Modal');
      const title = document.getElementById('gallery2ModalTitle');
      const photoId = document.getElementById('gallery2PhotoId');
      const photoUrl = document.getElementById('gallery2PhotoUrl');
      const caption = document.getElementById('gallery2Caption');
      const imageUrl = document.getElementById('gallery2ImageUrl');
      const placeholder = document.getElementById('gallery2Placeholder');
      const container = document.getElementById('gallery2PreviewContainer');
      
      if (photo) {
        title.textContent = 'Edit Photo';
        photoId.value = photo.id;
        photoUrl.value = photo.imageUrl || '';
        caption.value = photo.caption || '';
        imageUrl.value = photo.imageUrl || '';
        
        if (photo.imageUrl) {
          container.innerHTML = `<img src="${photo.imageUrl}" alt="Preview" style="max-width: 200px; max-height: 150px; border-radius: 8px; object-fit: cover;">`;
        }
      } else {
        title.textContent = 'Add Photo';
        photoId.value = '';
        photoUrl.value = '';
        caption.value = '';
        imageUrl.value = '';
        container.innerHTML = '<div class="photo-preview-placeholder" id="gallery2Placeholder" style="width: 200px; height: 150px; border-radius: 8px; font-size: 3rem;">üì∑</div>';
      }
      
      document.getElementById('gallery2UploadProgress').style.display = 'none';
      modal.classList.add('active');
    }

    function closeGallery2Modal() {
      document.getElementById('gallery2Modal').classList.remove('active');
      document.getElementById('gallery2PhotoInput').value = '';
    }

    function editGallery2Photo(id) {
      const photo = gallery2Photos.find(p => p.id === id);
      if (photo) {
        openGallery2Modal(photo);
      }
    }

    function handleGallery2PhotoSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        alert('Photo must be less than 5MB');
        return;
      }
      
      const container = document.getElementById('gallery2PreviewContainer');
      const reader = new FileReader();
      reader.onload = (e) => {
        container.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 200px; max-height: 150px; border-radius: 8px; object-fit: cover;">`;
      };
      reader.readAsDataURL(file);
      
      document.getElementById('gallery2ImageUrl').value = '';
    }

    function previewGallery2Url() {
      const url = document.getElementById('gallery2ImageUrl').value.trim();
      const container = document.getElementById('gallery2PreviewContainer');
      
      if (url) {
        container.innerHTML = `<img src="${url}" alt="Preview" style="max-width: 200px; max-height: 150px; border-radius: 8px; object-fit: cover;" onerror="this.parentElement.innerHTML='<div class=\\'photo-preview-placeholder\\' style=\\'width: 200px; height: 150px; border-radius: 8px; font-size: 3rem;\\'>‚ùå</div>'">`;
        document.getElementById('gallery2PhotoInput').value = '';
      }
    }

    async function saveGallery2Photo() {
      const photoId = document.getElementById('gallery2PhotoId').value;
      const caption = document.getElementById('gallery2Caption').value.trim();
      const imageUrlInput = document.getElementById('gallery2ImageUrl').value.trim();
      const fileInput = document.getElementById('gallery2PhotoInput');
      const file = fileInput.files[0];
      
      if (!caption) {
        alert('Please enter a caption');
        return;
      }
      
      if (!file && !imageUrlInput && !document.getElementById('gallery2PhotoUrl').value) {
        alert('Please select a photo or enter an image URL');
        return;
      }
      
      const saveBtn = document.getElementById('saveGallery2Btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      
      try {
        let finalImageUrl = imageUrlInput || document.getElementById('gallery2PhotoUrl').value;
        
        if (file) {
          const progressBar = document.getElementById('gallery2UploadProgress');
          const progressBarInner = document.getElementById('gallery2UploadProgressBar');
          progressBar.style.display = 'block';
          
          const timestamp = Date.now();
          const safeName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
          const storageRef = storage.ref(`gallery2/${timestamp}_${safeName}`);
          
          const uploadTask = storageRef.put(file);
          
          await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
              (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progressBarInner.style.width = progress + '%';
              },
              reject,
              async () => {
                finalImageUrl = await uploadTask.snapshot.ref.getDownloadURL();
                resolve();
              }
            );
          });
        }
        
        const photoData = {
          caption,
          imageUrl: finalImageUrl,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (photoId) {
          await db.collection('gallery2').doc(photoId).update(photoData);
        } else {
          photoData.order = gallery2Photos.length;
          photoData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('gallery2').add(photoData);
        }
        
        closeGallery2Modal();
        await loadGallery2();
        showSuccess('gallery2');
      } catch (error) {
        console.error('Error saving photo:', error);
        alert('Failed to save photo. Please try again.');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Photo';
      }
    }

    function deleteGallery2Photo(id, caption, imageUrl) {
      document.getElementById('deleteGallery2Id').value = id;
      document.getElementById('deleteGallery2PhotoUrl').value = imageUrl;
      document.getElementById('deleteGallery2Preview').src = imageUrl;
      document.getElementById('deleteGallery2Modal').classList.add('active');
    }
    
    function closeDeleteGallery2Modal() {
      document.getElementById('deleteGallery2Modal').classList.remove('active');
    }
    
    async function confirmDeleteGallery2() {
      const id = document.getElementById('deleteGallery2Id').value;
      const photoUrl = document.getElementById('deleteGallery2PhotoUrl').value;
      
      try {
        await db.collection('gallery2').doc(id).delete();
        
        if (photoUrl && photoUrl.includes('firebasestorage.googleapis.com')) {
          try {
            const storageRef = storage.refFromURL(photoUrl);
            await storageRef.delete();
          } catch (e) {
            console.log('Could not delete from storage:', e);
          }
        }
        
        closeDeleteGallery2Modal();
        await loadGallery2();
        showSuccess('gallery2');
      } catch (error) {
        console.error('Error deleting photo:', error);
        alert('Failed to delete photo. Please try again.');
      }
    }

    // ===== FAQ Functions =====
    let categories = [];
    let faqs = [];
    let currentFaqSteps = [];
    let draggedCategoryItem = null;
    let draggedFaqItem = null;
    
    function switchFaqSubTab(subtab) {
      document.querySelectorAll('#faq-tab .sub-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`#faq-tab .sub-tab[data-subtab="${subtab}"]`).classList.add('active');
      document.getElementById('categories-subtab').style.display = subtab === 'categories' ? 'block' : 'none';
      document.getElementById('faqs-subtab').style.display = subtab === 'faqs' ? 'block' : 'none';
    }
    
    async function loadCategories() {
      const loading = document.getElementById('categoriesLoading');
      const empty = document.getElementById('categoriesEmpty');
      const list = document.getElementById('categoriesList');
      
      if (!loading) return;
      loading.style.display = 'block';
      empty.style.display = 'none';
      list.innerHTML = '';
      
      try {
        const snapshot = await db.collection('categories').orderBy('order').get();
        categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        loading.style.display = 'none';
        
        // Update filter dropdown
        const filter = document.getElementById('faqCategoryFilter');
        if (filter) {
          filter.innerHTML = '<option value="all">All Categories</option>' +
            categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        
        // Update modal dropdown
        const modalSelect = document.getElementById('faqCategoryId');
        if (modalSelect) {
          modalSelect.innerHTML = categories.length === 0 
            ? '<option value="">No categories - create one first</option>'
            : categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        
        if (categories.length === 0) {
          empty.style.display = 'block';
        } else {
          renderCategories();
        }
      } catch (error) {
        console.error('Error loading categories:', error);
        loading.style.display = 'none';
      }
    }
    
    function renderCategories() {
      const list = document.getElementById('categoriesList');
      if (!list) return;
      list.innerHTML = categories.map((cat, index) => `
        <div class="category-card" draggable="true" data-id="${cat.id}" data-index="${index}"
             ondragstart="handleCategoryDragStart(event)" ondragover="handleCategoryDragOver(event)" 
             ondrop="handleCategoryDrop(event)" ondragend="handleCategoryDragEnd(event)">
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            <span style="cursor: grab; color: var(--text-light);">‚ò∞</span>
            <div>
              <strong style="color: var(--primary-blue);">${cat.name}</strong>
              <span style="color: var(--text-light); font-size: 0.8rem; margin-left: 0.5rem;">
                (${faqs.filter(f => f.categoryId === cat.id).length} FAQs)
              </span>
            </div>
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn-edit" onclick="editCategory('${cat.id}')">‚úèÔ∏è</button>
            <button class="btn-delete" onclick="deleteCategory('${cat.id}', '${cat.name.replace(/'/g, "\\'")}')">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }
    
    // Category drag and drop
    function handleCategoryDragStart(e) {
      draggedCategoryItem = e.target.closest('.category-card');
      draggedCategoryItem.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleCategoryDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const target = e.target.closest('.category-card');
      if (target && target !== draggedCategoryItem) {
        target.style.borderTop = '3px solid var(--primary-blue)';
      }
    }
    
    function handleCategoryDrop(e) {
      e.preventDefault();
      const target = e.target.closest('.category-card');
      if (target && target !== draggedCategoryItem) {
        const fromIndex = parseInt(draggedCategoryItem.dataset.index);
        const toIndex = parseInt(target.dataset.index);
        reorderCategories(fromIndex, toIndex);
      }
      document.querySelectorAll('.category-card').forEach(c => c.style.borderTop = '');
    }
    
    function handleCategoryDragEnd(e) {
      if (draggedCategoryItem) draggedCategoryItem.style.opacity = '1';
      draggedCategoryItem = null;
      document.querySelectorAll('.category-card').forEach(c => c.style.borderTop = '');
    }
    
    async function reorderCategories(fromIndex, toIndex) {
      const item = categories.splice(fromIndex, 1)[0];
      categories.splice(toIndex, 0, item);
      
      const batch = db.batch();
      categories.forEach((cat, i) => {
        batch.update(db.collection('categories').doc(cat.id), { order: i });
      });
      
      try {
        await batch.commit();
        renderCategories();
      } catch (err) {
        console.error('Error reordering:', err);
        await loadCategories();
      }
    }
    
    async function loadFaqs() {
      const loading = document.getElementById('faqsLoading');
      const empty = document.getElementById('faqsEmpty');
      const list = document.getElementById('faqsList');
      
      if (!loading) return;
      loading.style.display = 'block';
      empty.style.display = 'none';
      list.innerHTML = '';
      
      try {
        const snapshot = await db.collection('faqs').get();
        faqs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        faqs.sort((a, b) => (a.order || 0) - (b.order || 0));
        loading.style.display = 'none';
        
        if (faqs.length === 0) {
          empty.style.display = 'block';
        } else {
          renderFaqs();
        }
        renderCategories();
      } catch (error) {
        console.error('Error loading FAQs:', error);
        loading.style.display = 'none';
      }
    }
    
    function filterFaqsByCategory() { renderFaqs(); }
    
    function renderFaqs() {
      const list = document.getElementById('faqsList');
      const filterEl = document.getElementById('faqCategoryFilter');
      if (!list) return;
      const filter = filterEl ? filterEl.value : 'all';
      const filtered = filter === 'all' ? faqs : faqs.filter(f => f.categoryId === filter);
      
      if (filtered.length === 0) {
        list.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">No FAQs found.</p>';
        return;
      }
      
      list.innerHTML = filtered.map((faq, index) => {
        const cat = categories.find(c => c.id === faq.categoryId);
        return `
          <div class="faq-card" draggable="true" data-id="${faq.id}" data-index="${index}"
               ondragstart="handleFaqDragStart(event)" ondragover="handleFaqDragOver(event)" 
               ondrop="handleFaqDrop(event)" ondragend="handleFaqDragEnd(event)">
            <div class="faq-card-header" style="cursor: pointer;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="cursor: grab; color: var(--text-light);" onclick="event.stopPropagation()">‚ò∞</span>
                <span class="faq-category-badge">${cat?.name || 'Uncategorized'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-start;" onclick="toggleDataExpand('faq-${faq.id}')">
                <strong style="color: var(--text-dark); flex: 1;">${faq.question}</strong>
                <span id="faq-${faq.id}-arrow" style="margin-left: 0.5rem;">‚ñ∂</span>
              </div>
            </div>
            <div id="faq-${faq.id}-body" class="data-card-body" style="display: none;">
              ${faq.summary ? `<p style="margin-bottom: 1rem; color: var(--text-light);">${faq.summary}</p>` : ''}
              ${faq.steps && faq.steps.length > 0 ? `
                <div style="margin-bottom: 1rem;">
                  <strong>Action Steps:</strong>
                  <ol style="margin-left: 1.5rem; margin-top: 0.5rem;">
                    ${faq.steps.map(s => `<li style="margin-bottom: 0.25rem;">${s}</li>`).join('')}
                  </ol>
                </div>
              ` : ''}
              ${faq.contact ? `<p style="margin-bottom: 1rem;"><strong>Contact:</strong> ${faq.contact}</p>` : ''}
              <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <button class="btn-edit" onclick="editFaq('${faq.id}')">‚úèÔ∏è Edit</button>
                <button class="btn-delete" onclick="deleteFaq('${faq.id}')">üóëÔ∏è Delete</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // FAQ drag and drop
    function handleFaqDragStart(e) {
      draggedFaqItem = e.target.closest('.faq-card');
      draggedFaqItem.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleFaqDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const target = e.target.closest('.faq-card');
      if (target && target !== draggedFaqItem) {
        target.style.borderTop = '3px solid var(--primary-blue)';
      }
    }
    
    function handleFaqDrop(e) {
      e.preventDefault();
      const target = e.target.closest('.faq-card');
      if (target && target !== draggedFaqItem) {
        const fromId = draggedFaqItem.dataset.id;
        const toId = target.dataset.id;
        reorderFaqs(fromId, toId);
      }
      document.querySelectorAll('.faq-card').forEach(c => c.style.borderTop = '');
    }
    
    function handleFaqDragEnd(e) {
      if (draggedFaqItem) draggedFaqItem.style.opacity = '1';
      draggedFaqItem = null;
      document.querySelectorAll('.faq-card').forEach(c => c.style.borderTop = '');
    }
    
    async function reorderFaqs(fromId, toId) {
      const fromIndex = faqs.findIndex(f => f.id === fromId);
      const toIndex = faqs.findIndex(f => f.id === toId);
      
      const item = faqs.splice(fromIndex, 1)[0];
      faqs.splice(toIndex, 0, item);
      
      const batch = db.batch();
      faqs.forEach((faq, i) => {
        batch.update(db.collection('faqs').doc(faq.id), { order: i });
      });
      
      try {
        await batch.commit();
        renderFaqs();
      } catch (err) {
        console.error('Error reordering:', err);
        await loadFaqs();
      }
    }
    
    // Category Modal
    function openCategoryModal(category = null) {
      document.getElementById('categoryId').value = category?.id || '';
      document.getElementById('categoryName').value = category?.name || '';
      document.getElementById('categoryModalTitle').textContent = category ? 'Edit Category' : 'Add Category';
      document.getElementById('categoryModal').classList.add('active');
    }
    
    function closeCategoryModal() {
      document.getElementById('categoryModal').classList.remove('active');
    }
    
    function editCategory(id) {
      const cat = categories.find(c => c.id === id);
      if (cat) openCategoryModal(cat);
    }
    
    async function saveCategory() {
      const id = document.getElementById('categoryId').value;
      const name = document.getElementById('categoryName').value.trim();
      
      if (!name) {
        alert('Category name is required');
        return;
      }
      
      try {
        if (id) {
          await db.collection('categories').doc(id).update({ 
            name, 
            updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
          });
        } else {
          await db.collection('categories').add({ 
            name, 
            order: categories.length, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp() 
          });
        }
        closeCategoryModal();
        await loadCategories();
        showSuccess('faq');
      } catch (error) {
        console.error('Error saving category:', error);
        alert('Failed to save category.');
      }
    }
    
    async function deleteCategory(id, name) {
      const faqCount = faqs.filter(f => f.categoryId === id).length;
      if (faqCount > 0) {
        alert(`Cannot delete "${name}" - it has ${faqCount} FAQ(s). Delete or reassign them first.`);
        return;
      }
      if (!confirm(`Delete category "${name}"?`)) return;
      try {
        await db.collection('categories').doc(id).delete();
        await loadCategories();
        showSuccess('faq');
      } catch (error) {
        console.error('Error deleting category:', error);
      }
    }
    
    // FAQ Modal
    function openFaqModal(faq = null) {
      currentFaqSteps = faq?.steps ? [...faq.steps] : [];
      
      document.getElementById('faqId').value = faq?.id || '';
      document.getElementById('faqQuestion').value = faq?.question || '';
      document.getElementById('faqSummary').value = faq?.summary || '';
      document.getElementById('faqContact').value = faq?.contact || '(808) 532-5364';
      
      // Update category dropdown
      const select = document.getElementById('faqCategoryId');
      select.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      if (faq?.categoryId) select.value = faq.categoryId;
      
      document.getElementById('faqModalTitle').textContent = faq ? 'Edit FAQ' : 'Add FAQ';
      
      renderFaqSteps();
      document.getElementById('faqModal').classList.add('active');
    }
    
    function closeFaqModal() {
      document.getElementById('faqModal').classList.remove('active');
    }
    
    function editFaq(id) {
      const faq = faqs.find(f => f.id === id);
      if (faq) openFaqModal(faq);
    }
    
    function addFaqStep() {
      const input = document.getElementById('newFaqStep');
      if (input.value.trim()) {
        currentFaqSteps.push(input.value.trim());
        input.value = '';
        renderFaqSteps();
      }
    }
    
    function removeFaqStep(index) {
      currentFaqSteps.splice(index, 1);
      renderFaqSteps();
    }
    
    function editFaqStep(index) {
      const newText = prompt('Edit step:', currentFaqSteps[index]);
      if (newText !== null && newText.trim()) {
        currentFaqSteps[index] = newText.trim();
        renderFaqSteps();
      }
    }
    
    function renderFaqSteps() {
      const list = document.getElementById('faqStepsList');
      list.innerHTML = currentFaqSteps.map((step, i) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background: #f9fafb; border-radius: 6px; border-left: 3px solid var(--primary-blue);">
          <span style="flex: 1;"><strong>${i + 1}.</strong> ${step}</span>
          <div style="display: flex; gap: 0.25rem;">
            <button type="button" onclick="editFaqStep(${i})" style="background: none; border: none; cursor: pointer; color: var(--primary-blue);">‚úèÔ∏è</button>
            <button type="button" onclick="removeFaqStep(${i})" style="background: none; border: none; cursor: pointer; color: var(--danger);">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }
    
    async function saveFaq() {
      const id = document.getElementById('faqId').value;
      const data = {
        categoryId: document.getElementById('faqCategoryId').value,
        question: document.getElementById('faqQuestion').value.trim(),
        summary: document.getElementById('faqSummary').value.trim(),
        steps: currentFaqSteps,
        contact: document.getElementById('faqContact').value.trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      if (!data.question) {
        alert('Question is required');
        return;
      }
      if (!data.categoryId) {
        alert('Please select a category');
        return;
      }
      
      try {
        if (id) {
          await db.collection('faqs').doc(id).update(data);
        } else {
          data.order = faqs.length;
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('faqs').add(data);
        }
        closeFaqModal();
        await loadFaqs();
        showSuccess('faq');
      } catch (error) {
        console.error('Error saving FAQ:', error);
        alert('Failed to save FAQ.');
      }
    }
    
    async function deleteFaq(id) {
      if (!confirm('Delete this FAQ?')) return;
      try {
        await db.collection('faqs').doc(id).delete();
        await loadFaqs();
        showSuccess('faq');
      } catch (error) {
        console.error('Error deleting FAQ:', error);
      }
    }

    // ===== Events Functions =====
    let events = [];
    let eventSignups = {};
    let currentEventSignupDates = [];
    let currentEventCustomQuestions = [];
    
    async function loadEvents() {
      const loading = document.getElementById('eventsLoading');
      const empty = document.getElementById('eventsEmpty');
      const list = document.getElementById('eventsList');
      const countEl = document.getElementById('eventsCount');
      
      if (!loading) return;
      loading.style.display = 'block';
      empty.style.display = 'none';
      list.innerHTML = '';
      
      try {
        const snapshot = await db.collection('events').get();
        events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        events.sort((a, b) => new Date(b.startDate || b.eventDate || 0) - new Date(a.startDate || a.eventDate || 0));
        
        for (const event of events) {
          const signupsSnap = await db.collection('events').doc(event.id).collection('signups').get();
          eventSignups[event.id] = signupsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        }
        
        loading.style.display = 'none';
        
        // Calculate total new signups across all events (pending = new for signups)
        let totalNewSignups = 0;
        for (const eventId in eventSignups) {
          totalNewSignups += eventSignups[eventId].filter(s => !s.status || s.status === 'new' || s.status === 'pending').length;
        }
        const eventsBadge = document.getElementById('eventsTabBadge');
        if (eventsBadge) {
          eventsBadge.textContent = totalNewSignups;
          eventsBadge.style.display = totalNewSignups > 0 ? 'inline' : 'none';
        }
        
        if (events.length === 0) {
          empty.style.display = 'block';
          if (countEl) countEl.textContent = '';
        } else {
          if (countEl) countEl.textContent = `${events.length} events`;
          renderEvents();
        }
        
        // Refresh dashboard now that event signups are loaded
        scheduleDashboardRefresh();
      } catch (error) {
        console.error('Error loading events:', error);
        loading.style.display = 'none';
      }
    }
    
    function renderEvents() {
      const list = document.getElementById('eventsList');
      if (!list) return;
      const now = new Date();
      
      list.innerHTML = events.map(event => {
        const moveToPast = event.moveToPastDate ? new Date(event.moveToPastDate) : null;
        const isPast = moveToPast && moveToPast < now;
        const signups = eventSignups[event.id] || [];
        const totalVolunteers = signups.reduce((sum, s) => sum + (parseInt(s.numVolunteers) || 1), 0);
        const newSignups = signups.filter(s => !s.status || s.status === 'new' || s.status === 'pending').length;
        
        return `
          <div class="event-card" style="${isPast ? 'opacity: 0.7;' : ''}">
            <div class="event-card-header">
              ${event.imageUrl 
                ? `<img src="${event.imageUrl}" alt="${event.title}" class="event-poster">`
                : '<div class="event-poster-placeholder">üìÖ</div>'
              }
              <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 0.5rem;">
                  <div>
                    <h3 style="color: var(--primary-blue); margin-bottom: 0.25rem;">${event.title}</h3>
                    <span class="status-badge ${isPast ? 'status-archived' : 'status-approved'}">${isPast ? 'Past' : 'Upcoming'}</span>
                  </div>
                </div>
                <p style="color: var(--text-light); font-size: 0.9rem; margin-top: 0.5rem;">
                  üìÖ ${event.eventDate || 'No date'} ${event.time ? `‚Ä¢ ‚è∞ ${event.time}` : ''}
                </p>
                ${event.location ? `<p style="color: var(--text-light); font-size: 0.9rem;">üìç ${event.location}</p>` : ''}
                <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem;">
                  ${signups.length} signups ‚Ä¢ ${totalVolunteers} participants
                </p>
              </div>
            </div>
            <div style="padding: 0 1rem 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button class="btn-edit" onclick="openSignupsModal('${event.id}')" style="background: #10b981; position: relative;">
                üìÅ Signups (${signups.length})
                ${newSignups > 0 ? `<span class="badge" style="position: absolute; top: -8px; right: -8px;">${newSignups}</span>` : ''}
              </button>
              <button class="btn-edit" onclick="editEvent('${event.id}')">‚úèÔ∏è Edit</button>
              <button class="btn-delete" onclick="deleteEvent('${event.id}', '${event.title.replace(/'/g, "\\'")}')">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function openEventModal(event = null) {
      currentEventSignupDates = event?.signupDates ? [...event.signupDates] : [];
      currentEventCustomQuestions = event?.customQuestions ? [...event.customQuestions] : [];
      
      document.getElementById('eventId').value = event?.id || '';
      document.getElementById('eventTitle').value = event?.title || '';
      document.getElementById('eventDescription').value = event?.description || '';
      document.getElementById('eventImageUrl').value = event?.imageUrl || '';
      document.getElementById('eventEventDate').value = event?.eventDate || '';
      document.getElementById('eventTime').value = event?.time || '';
      document.getElementById('eventLocation').value = event?.location || '';
      document.getElementById('eventStartDate').value = event?.startDate || '';
      document.getElementById('eventMoveToPastDate').value = event?.moveToPastDate || '';
      document.getElementById('eventRemoveDate').value = event?.removeDate || '';
      
      document.getElementById('eventModalTitle').textContent = event ? 'Edit Event' : 'Add Event';
      
      // Image preview
      const preview = document.getElementById('eventImagePreview');
      if (event?.imageUrl) {
        preview.innerHTML = `<img src="${event.imageUrl}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;"><button type="button" class="btn-delete" style="margin-left: 0.5rem;" onclick="clearEventImage()">Remove</button>`;
      } else {
        preview.innerHTML = '';
      }
      
      renderEventSignupDates();
      renderEventCustomQuestions();
      
      document.getElementById('eventModal').classList.add('active');
    }
    
    function closeEventModal() {
      document.getElementById('eventModal').classList.remove('active');
    }
    
    function editEvent(id) {
      const event = events.find(e => e.id === id);
      if (event) openEventModal(event);
    }
    
    function clearEventImage() {
      document.getElementById('eventImageUrl').value = '';
      document.getElementById('eventImagePreview').innerHTML = '';
    }
    
    async function handleEventImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (file.size > 10 * 1024 * 1024) {
        alert('File must be less than 10MB');
        return;
      }
      
      const progress = document.getElementById('eventUploadProgress');
      const progressBar = document.getElementById('eventUploadProgressBar');
      progress.style.display = 'block';
      
      try {
        const filename = `event-images/${Date.now()}_${file.name}`;
        const ref = storage.ref(filename);
        const task = ref.put(file);
        
        task.on('state_changed', 
          (snap) => { progressBar.style.width = (snap.bytesTransferred / snap.totalBytes * 100) + '%'; },
          (err) => { alert('Upload failed'); progress.style.display = 'none'; },
          async () => {
            const url = await task.snapshot.ref.getDownloadURL();
            document.getElementById('eventImageUrl').value = url;
            document.getElementById('eventImagePreview').innerHTML = `<img src="${url}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;"><button type="button" class="btn-delete" style="margin-left: 0.5rem;" onclick="clearEventImage()">Remove</button>`;
            progress.style.display = 'none';
          }
        );
      } catch (err) {
        console.error(err);
        progress.style.display = 'none';
      }
    }
    
    function addEventSignupDate() {
      const input = document.getElementById('newSignupDate');
      if (input.value.trim()) {
        currentEventSignupDates.push(input.value.trim());
        input.value = '';
        renderEventSignupDates();
      }
    }
    
    function removeEventSignupDate(index) {
      currentEventSignupDates.splice(index, 1);
      renderEventSignupDates();
    }
    
    function renderEventSignupDates() {
      const list = document.getElementById('signupDatesList');
      list.innerHTML = currentEventSignupDates.map((d, i) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f3f4f6; border-radius: 6px;">
          <span>${d}</span>
          <button type="button" class="btn-delete" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="removeEventSignupDate(${i})">Remove</button>
        </div>
      `).join('');
    }
    
    function addEventCustomQuestion() {
      const input = document.getElementById('newCustomQuestion');
      if (input.value.trim()) {
        currentEventCustomQuestions.push(input.value.trim());
        input.value = '';
        renderEventCustomQuestions();
      }
    }
    
    function removeEventCustomQuestion(index) {
      currentEventCustomQuestions.splice(index, 1);
      renderEventCustomQuestions();
    }
    
    function renderEventCustomQuestions() {
      const list = document.getElementById('customQuestionsList');
      list.innerHTML = currentEventCustomQuestions.map((q, i) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f0fdf4; border-radius: 6px;">
          <span>${q}</span>
          <button type="button" class="btn-delete" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="removeEventCustomQuestion(${i})">Remove</button>
        </div>
      `).join('');
    }
    
    async function saveEvent() {
      const id = document.getElementById('eventId').value;
      const data = {
        title: document.getElementById('eventTitle').value.trim(),
        description: document.getElementById('eventDescription').value.trim(),
        imageUrl: document.getElementById('eventImageUrl').value.trim(),
        eventDate: document.getElementById('eventEventDate').value.trim(),
        time: document.getElementById('eventTime').value.trim(),
        location: document.getElementById('eventLocation').value.trim(),
        startDate: document.getElementById('eventStartDate').value,
        moveToPastDate: document.getElementById('eventMoveToPastDate').value,
        removeDate: document.getElementById('eventRemoveDate').value,
        signupDates: currentEventSignupDates,
        customQuestions: currentEventCustomQuestions,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      if (!data.title) { alert('Title is required'); return; }
      if (!data.startDate || !data.moveToPastDate || !data.removeDate) { alert('All dates are required'); return; }
      
      try {
        if (id) {
          await db.collection('events').doc(id).update(data);
        } else {
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('events').add(data);
        }
        closeEventModal();
        await loadEvents();
        showSuccess('events');
      } catch (err) {
        console.error(err);
        alert('Error saving event');
      }
    }
    
    async function deleteEvent(id, title) {
      if (!confirm(`Delete event "${title}"? This will also delete all signups.`)) return;
      try {
        const signupsSnap = await db.collection('events').doc(id).collection('signups').get();
        const batch = db.batch();
        signupsSnap.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        await db.collection('events').doc(id).delete();
        await loadEvents();
        showSuccess('events');
      } catch (error) {
        console.error('Error:', error);
      }
    }
    
    // Event Signups Modal
    function openSignupsModal(eventId) {
      const event = events.find(e => e.id === eventId);
      const signups = eventSignups[eventId] || [];
      
      document.getElementById('signupsModalTitle').textContent = `Signups: ${event.title}`;
      document.getElementById('signupsEventId').value = eventId;
      document.getElementById('signupsCount').textContent = `${signups.length} signups`;
      
      const list = document.getElementById('signupsList');
      if (signups.length === 0) {
        list.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">No signups yet.</p>';
      } else {
        // Group signups by selectedDate if available
        const groupedByDate = {};
        signups.forEach(s => {
          // Handle both selectedDate (string) and selectedDates (array)
          const dates = s.selectedDates || (s.selectedDate ? [s.selectedDate] : ['No date specified']);
          dates.forEach(date => {
            if (!groupedByDate[date]) groupedByDate[date] = [];
            groupedByDate[date].push(s);
          });
        });
        
        list.innerHTML = Object.entries(groupedByDate).map(([dateStr, dateSignups]) => {
          const totalVolunteers = dateSignups.reduce((sum, s) => sum + (parseInt(s.groupSize) || parseInt(s.numVolunteers) || 1), 0);
          
          return `
            <div style="margin-bottom: 1.5rem;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #004E7C, #0066a1); border-radius: 8px;">
                <span style="font-size: 1.25rem;">üìÖ</span>
                <h4 style="color: white; margin: 0; flex: 1;">${dateStr}</h4>
                <span style="background: #4DD0E1; color: #004E7C; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">${totalVolunteers} volunteer${totalVolunteers !== 1 ? 's' : ''}</span>
              </div>
              ${dateSignups.map(s => {
                const submitDate = s.timestamp?.seconds ? new Date(s.timestamp.seconds * 1000) : null;
                const submitDateStr = submitDate ? submitDate.toLocaleString() : 'Unknown';
                const status = s.status || 'pending';
                const isGroup = s.participationType === 'Group' || s.groupName;
                const volunteerCount = parseInt(s.groupSize) || parseInt(s.numVolunteers) || 1;
                
                return `
                  <div class="data-card ${status}" style="margin-bottom: 0.75rem; border-left: 4px solid ${status === 'confirmed' ? '#22c55e' : status === 'cancelled' ? '#ef4444' : '#f59e0b'};">
                    <div class="data-card-header" onclick="toggleDataExpand('signup-${s.id}')">
                      <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                          <strong>${s.name || (s.firstName ? s.firstName + ' ' + s.lastName : 'Unknown')}</strong>
                          <select onchange="updateSignupStatus('${eventId}', '${s.id}', this.value)" style="padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; border: none; cursor: pointer; font-weight: 600; ${status === 'confirmed' ? 'background: #dcfce7; color: #166534;' : status === 'cancelled' ? 'background: #fee2e2; color: #991b1b;' : 'background: #fef3c7; color: #92400e;'}">
                            <option value="pending" ${status === 'pending' ? 'selected' : ''}>‚è≥ Pending</option>
                            <option value="confirmed" ${status === 'confirmed' ? 'selected' : ''}>‚úÖ Confirmed</option>
                            <option value="cancelled" ${status === 'cancelled' ? 'selected' : ''}>‚ùå Cancelled</option>
                          </select>
                        </div>
                        <p style="color: var(--text-light); font-size: 0.85rem; margin-top: 0.25rem;">
                          üìß ${s.email} ${s.phone ? '‚Ä¢ üì± ' + s.phone : ''}
                        </p>
                        ${isGroup ? `<p style="color: var(--text-light); font-size: 0.85rem;">üë• ${s.groupName || 'Group'} (${volunteerCount} volunteers)</p>` : `<p style="color: var(--text-light); font-size: 0.85rem;">üë§ Individual</p>`}
                        ${s.adminNotes ? '<span style="background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">üìù Notes</span>' : ''}
                      </div>
                      <span id="signup-${s.id}-arrow">‚ñ∂</span>
                    </div>
                    <div id="signup-${s.id}-body" class="data-card-body" style="display: none;">
                      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                          <p><strong>Preferred Contact:</strong> ${s.preferredContact || 'Not specified'}</p>
                          <p><strong>Type:</strong> ${s.participationType || (isGroup ? 'Group' : 'Individual')}</p>
                          ${isGroup ? `<p><strong>Group Name:</strong> ${s.groupName || 'N/A'}</p><p><strong>Group Size:</strong> ${volunteerCount}</p>` : ''}
                        </div>
                        <div>
                          <p><strong>Submitted:</strong> ${submitDateStr}</p>
                          ${s.selectedDates && s.selectedDates.length > 1 ? `<p><strong>All Selected Dates:</strong> ${s.selectedDates.join(', ')}</p>` : ''}
                        </div>
                      </div>
                      
                      ${s.customAnswers && Object.keys(s.customAnswers).length > 0 ? `
                        <div style="margin-bottom: 1rem;">
                          <strong>Custom Responses:</strong>
                          <div style="background: #f9fafb; padding: 0.75rem; border-radius: 8px; margin-top: 0.5rem;">
                            ${Object.entries(s.customAnswers).map(([key, value]) => `
                              <p style="margin-bottom: 0.5rem;"><strong>${key}:</strong> ${value}</p>
                            `).join('')}
                          </div>
                        </div>
                      ` : ''}
                      
                      ${s.customResponses ? `
                        <div style="margin-bottom: 1rem;">
                          <strong>Custom Responses:</strong>
                          <pre style="background: #f9fafb; padding: 0.5rem; border-radius: 4px; font-size: 0.8rem; overflow-x: auto;">${JSON.stringify(s.customResponses, null, 2)}</pre>
                        </div>
                      ` : ''}
                      
                      ${s.message || s.additionalInfo || s.additionalComments ? `
                        <div style="margin-bottom: 1rem;">
                          <strong>Message/Comments:</strong>
                          <p style="background: #f9fafb; padding: 0.75rem; border-radius: 8px; margin-top: 0.5rem;">${s.message || s.additionalInfo || s.additionalComments}</p>
                        </div>
                      ` : ''}
                      
                      <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">üìù Admin Notes (Private):</label>
                        <textarea id="signup-notes-${s.id}" rows="2" style="width: 100%; padding: 0.5rem; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; resize: vertical; background: #fffbeb;" placeholder="Add internal notes here...">${s.adminNotes || ''}</textarea>
                        <button onclick="saveSignupNotes('${eventId}', '${s.id}')" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: var(--primary-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üíæ Save Notes</button>
                      </div>
                      
                      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; padding-top: 1rem; border-top: 1px solid #eee;">
                        <a href="mailto:${s.email}" class="btn-edit">üìß Email</a>
                        ${s.phone ? `<a href="tel:${s.phone}" class="btn-edit" style="background: #22c55e;">üìû Call</a>` : ''}
                        ${s.phone ? `<a href="sms:${s.phone}" class="btn-edit" style="background: #10b981;">üí¨ Text</a>` : ''}
                        <button class="btn-delete" onclick="deleteEventSignup('${eventId}', '${s.id}')">üóëÔ∏è Delete</button>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }).join('');
      }
      
      document.getElementById('signupsModal').classList.add('active');
    }
    
    async function updateSignupStatus(eventId, signupId, status) {
      try {
        await db.collection('events').doc(eventId).collection('signups').doc(signupId).update({ status });
        const signup = eventSignups[eventId]?.find(s => s.id === signupId);
        if (signup) signup.status = status;
        // Refresh the modal
        openSignupsModal(eventId);
        // Update badges
        renderEvents();
        updateEventsTabBadge();
      } catch (error) {
        console.error('Error updating status:', error);
        alert('Error updating status. Please try again.');
      }
    }
    
    async function saveSignupNotes(eventId, signupId) {
      const textarea = document.getElementById(`signup-notes-${signupId}`);
      if (!textarea) return;
      
      const adminNotes = textarea.value.trim();
      const btn = textarea.nextElementSibling;
      const originalText = btn.textContent;
      
      try {
        btn.disabled = true;
        btn.textContent = 'Saving...';
        
        await db.collection('events').doc(eventId).collection('signups').doc(signupId).update({ 
          adminNotes: adminNotes,
          notesUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update local data
        const signup = eventSignups[eventId]?.find(s => s.id === signupId);
        if (signup) signup.adminNotes = adminNotes;
        
        btn.textContent = '‚úì Saved!';
        btn.style.background = 'var(--success)';
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = 'var(--primary-blue)';
          btn.disabled = false;
        }, 1500);
        
      } catch (error) {
        console.error('Error saving notes:', error);
        btn.textContent = '‚úó Error';
        btn.style.background = 'var(--danger)';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = 'var(--primary-blue)';
          btn.disabled = false;
        }, 2000);
      }
    }
    
    function closeSignupsModal() {
      document.getElementById('signupsModal').classList.remove('active');
    }
    
    async function deleteEventSignup(eventId, signupId) {
      if (!confirm('Delete this signup?')) return;
      try {
        await db.collection('events').doc(eventId).collection('signups').doc(signupId).delete();
        eventSignups[eventId] = eventSignups[eventId].filter(s => s.id !== signupId);
        openSignupsModal(eventId); // Refresh
        renderEvents();
        updateEventsTabBadge();
      } catch (err) {
        console.error(err);
      }
    }
    
    function exportEventSignupsToCSV() {
      const eventId = document.getElementById('signupsEventId').value;
      const event = events.find(e => e.id === eventId);
      const signups = eventSignups[eventId] || [];
      
      const headers = ['Name', 'Email', 'Phone', 'Preferred Contact', 'Type', 'Group Name', 'Group Size', 'Selected Dates', 'Status', 'Custom Answers', 'Message', 'Admin Notes', 'Submitted'];
      const rows = signups.map(s => {
        const date = s.timestamp?.seconds ? new Date(s.timestamp.seconds * 1000).toLocaleString() : '';
        const selectedDates = s.selectedDates ? s.selectedDates.join('; ') : (s.selectedDate || '');
        const customAnswers = s.customAnswers ? Object.entries(s.customAnswers).map(([k, v]) => `${k}: ${v}`).join('; ') : '';
        const volunteerCount = s.groupSize || s.numVolunteers || 1;
        return [
          s.name || `${s.firstName || ''} ${s.lastName || ''}`.trim(), 
          s.email || '', 
          s.phone || '', 
          s.preferredContact || '',
          s.participationType || (s.groupName ? 'Group' : 'Individual'),
          s.groupName || '',
          volunteerCount,
          selectedDates,
          s.status || 'pending',
          customAnswers.replace(/"/g, '""'),
          (s.message || s.additionalInfo || s.additionalComments || '').replace(/"/g, '""'), 
          (s.adminNotes || '').replace(/"/g, '""'),
          date
        ];
      });
      downloadCSV(`${event.title.replace(/[^a-z0-9]/gi, '_')}_signups.csv`, headers, rows);
    }

    // ===== Volunteers Functions =====
    let opportunities = [];
    let applications = [];
    
    function switchVolunteerSubTab(subtab) {
      document.querySelectorAll('#volunteers-tab .sub-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`#volunteers-tab .sub-tab[data-subtab="${subtab}"]`).classList.add('active');
      document.getElementById('opportunities-subtab').style.display = subtab === 'opportunities' ? 'block' : 'none';
      document.getElementById('applications-subtab').style.display = subtab === 'applications' ? 'block' : 'none';
    }
    
    async function loadOpportunities() {
      const loading = document.getElementById('opportunitiesLoading');
      const empty = document.getElementById('opportunitiesEmpty');
      const list = document.getElementById('opportunitiesList');
      
      if (!loading) return;
      loading.style.display = 'block';
      empty.style.display = 'none';
      list.innerHTML = '';
      
      try {
        const snapshot = await db.collection('volunteerOpportunities').get();
        opportunities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        opportunities.sort((a, b) => (a.order || 0) - (b.order || 0));
        loading.style.display = 'none';
        
        if (opportunities.length === 0) {
          empty.style.display = 'block';
        } else {
          renderOpportunities();
        }
        
        // Refresh dashboard
        scheduleDashboardRefresh();
      } catch (error) {
        console.error('Error:', error);
        loading.style.display = 'none';
      }
    }
    
    function renderOpportunities() {
      const list = document.getElementById('opportunitiesList');
      if (!list) return;
      const now = new Date();
      
      list.innerHTML = opportunities.map(opp => {
        let status = 'active', statusLabel = 'Active';
        if (opp.alwaysPost) { status = 'always'; statusLabel = 'Always Posted'; }
        else if (opp.startDate && new Date(opp.startDate) > now) { status = 'scheduled'; statusLabel = 'Scheduled'; }
        else if (opp.endDate && new Date(opp.endDate) < now) { status = 'expired'; statusLabel = 'Expired'; }
        
        const oppApps = applications.filter(a => a.opportunityId === opp.id);
        const newApps = oppApps.filter(a => !a.status || a.status === 'new').length;
        
        return `
          <div class="opportunity-card">
            <div style="display: flex; gap: 1rem; padding: 1rem;">
              ${opp.imageUrl ? `<img src="${opp.imageUrl}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; flex-shrink: 0;">` : ''}
              <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 0.5rem;">
                  <div>
                    <h3 style="color: var(--primary-blue);">${opp.title}</h3>
                    <span class="opportunity-status ${status}">${statusLabel}</span>
                  </div>
                </div>
                <p style="color: var(--text-light); font-size: 0.9rem; margin-top: 0.5rem;">${opp.description || ''}</p>
                ${opp.requirements ? `<p style="color: var(--text-light); font-size: 0.8rem; margin-top: 0.25rem;"><strong>Requirements:</strong> ${opp.requirements}</p>` : ''}
                <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap;">
                  <button class="btn-edit" onclick="openOpportunityAppsModal('${opp.id}')" style="background: #10b981; position: relative;">
                    üìÅ Applications (${oppApps.length})
                    ${newApps > 0 ? `<span class="badge" style="position: absolute; top: -8px; right: -8px;">${newApps}</span>` : ''}
                  </button>
                  <button class="btn-edit" onclick="editOpportunity('${opp.id}')">‚úèÔ∏è Edit</button>
                  <button class="btn-delete" onclick="deleteOpportunity('${opp.id}')">üóëÔ∏è</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function openOpportunityModal(opp = null) {
      document.getElementById('opportunityId').value = opp?.id || '';
      document.getElementById('opportunityTitle').value = opp?.title || '';
      document.getElementById('opportunityDescription').value = opp?.description || '';
      document.getElementById('opportunityRequirements').value = opp?.requirements || '';
      document.getElementById('opportunityImageUrl').value = opp?.imageUrl || '';
      document.getElementById('opportunityAlwaysPost').checked = opp?.alwaysPost || false;
      document.getElementById('opportunityStartDate').value = opp?.startDate || '';
      document.getElementById('opportunityEndDate').value = opp?.endDate || '';
      
      document.getElementById('opportunityModalTitle').textContent = opp ? 'Edit Volunteer Opportunity' : 'Add Volunteer Opportunity';
      
      const preview = document.getElementById('opportunityImagePreview');
      if (opp?.imageUrl) {
        preview.innerHTML = `<img src="${opp.imageUrl}" style="width: 100%; max-width: 200px; height: 100px; object-fit: cover; border-radius: 8px;"><button type="button" class="btn-delete" style="margin-left: 0.5rem;" onclick="clearOpportunityImage()">Remove</button>`;
      } else {
        preview.innerHTML = '';
      }
      
      toggleOpportunityDates();
      document.getElementById('opportunityModal').classList.add('active');
    }
    
    function closeOpportunityModal() {
      document.getElementById('opportunityModal').classList.remove('active');
    }
    
    function editOpportunity(id) {
      const opp = opportunities.find(o => o.id === id);
      if (opp) openOpportunityModal(opp);
    }
    
    function clearOpportunityImage() {
      document.getElementById('opportunityImageUrl').value = '';
      document.getElementById('opportunityImagePreview').innerHTML = '';
    }
    
    function toggleOpportunityDates() {
      const alwaysPost = document.getElementById('opportunityAlwaysPost').checked;
      document.getElementById('opportunityDatesSection').style.opacity = alwaysPost ? '0.5' : '1';
    }
    
    async function handleOpportunityImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        alert('File must be less than 5MB');
        return;
      }
      
      const progress = document.getElementById('opportunityUploadProgress');
      const progressBar = document.getElementById('opportunityUploadProgressBar');
      progress.style.display = 'block';
      
      try {
        const filename = `volunteer-opportunities/${Date.now()}_${file.name}`;
        const ref = storage.ref(filename);
        const task = ref.put(file);
        
        task.on('state_changed',
          (snap) => { progressBar.style.width = (snap.bytesTransferred / snap.totalBytes * 100) + '%'; },
          (err) => { alert('Upload failed'); progress.style.display = 'none'; },
          async () => {
            const url = await task.snapshot.ref.getDownloadURL();
            document.getElementById('opportunityImageUrl').value = url;
            document.getElementById('opportunityImagePreview').innerHTML = `<img src="${url}" style="width: 100%; max-width: 200px; height: 100px; object-fit: cover; border-radius: 8px;"><button type="button" class="btn-delete" style="margin-left: 0.5rem;" onclick="clearOpportunityImage()">Remove</button>`;
            progress.style.display = 'none';
          }
        );
      } catch (err) {
        console.error(err);
        progress.style.display = 'none';
      }
    }
    
    async function saveOpportunity() {
      const id = document.getElementById('opportunityId').value;
      const data = {
        title: document.getElementById('opportunityTitle').value.trim(),
        description: document.getElementById('opportunityDescription').value.trim(),
        requirements: document.getElementById('opportunityRequirements').value.trim(),
        imageUrl: document.getElementById('opportunityImageUrl').value.trim(),
        alwaysPost: document.getElementById('opportunityAlwaysPost').checked,
        startDate: document.getElementById('opportunityStartDate').value,
        endDate: document.getElementById('opportunityEndDate').value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      if (!data.title || !data.description) {
        alert('Title and description are required');
        return;
      }
      
      if (!data.alwaysPost && !data.startDate && !data.endDate) {
        alert('Either set "Always Post" or provide at least a start or end date');
        return;
      }
      
      try {
        if (id) {
          await db.collection('volunteerOpportunities').doc(id).update(data);
        } else {
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          data.order = opportunities.length;
          await db.collection('volunteerOpportunities').add(data);
        }
        closeOpportunityModal();
        await loadOpportunities();
        showSuccess('volunteers');
      } catch (err) {
        console.error(err);
        alert('Error saving opportunity');
      }
    }
    
    async function deleteOpportunity(id) {
      if (!confirm('Delete this volunteer opportunity?')) return;
      try {
        await db.collection('volunteerOpportunities').doc(id).delete();
        await loadOpportunities();
        showSuccess('volunteers');
      } catch (error) { console.error('Error:', error); }
    }
    
    // Opportunity Applications Modal
    function openOpportunityAppsModal(oppId) {
      const opp = opportunities.find(o => o.id === oppId);
      const apps = applications.filter(a => a.opportunityId === oppId);
      
      document.getElementById('opportunityAppsModalTitle').textContent = `Applications: ${opp.title}`;
      document.getElementById('opportunityAppsId').value = oppId;
      document.getElementById('opportunityAppsCount').textContent = `${apps.length} applications`;
      
      const list = document.getElementById('opportunityAppsList');
      if (apps.length === 0) {
        list.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">No applications yet.</p>';
      } else {
        list.innerHTML = apps.map(app => {
          const date = app.timestamp?.seconds ? new Date(app.timestamp.seconds * 1000).toLocaleDateString() : '';
          const status = app.status || 'new';
          return `
            <div class="data-card ${status}" style="margin-bottom: 0.75rem;">
              <div class="data-card-header" onclick="toggleDataExpand('oppapp-${app.id}')">
                <div style="flex: 1;">
                  <strong>${app.firstName} ${app.lastName}</strong>
                  <span class="status-badge status-${status}">${status}</span>
                  ${app.adminNotes ? '<span style="background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; margin-left: 4px;">üìù Notes</span>' : ''}
                  <p style="color: var(--text-light); font-size: 0.85rem;">üìß ${app.email} ‚Ä¢ ${date}</p>
                </div>
                <span id="oppapp-${app.id}-arrow">‚ñ∂</span>
              </div>
              <div id="oppapp-${app.id}-body" class="data-card-body" style="display: none;">
                <p><strong>Phone:</strong> ${app.phone || 'N/A'}</p>
                <p><strong>Message:</strong> ${app.message || 'N/A'}</p>
                <div style="margin-top: 1rem;">
                  <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">üìù Admin Notes:</label>
                  <textarea id="oppapp-notes-${app.id}" rows="2" style="width: 100%; padding: 0.5rem; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; resize: vertical;" placeholder="Add private notes about this applicant...">${app.adminNotes || ''}</textarea>
                  <button onclick="saveApplicationNotes('${app.id}', 'oppapp-notes-${app.id}', '${oppId}')" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: var(--primary-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üíæ Save Notes</button>
                </div>
                <div class="status-buttons">
                  ${['new', 'contacted', 'interviewing', 'accepted', 'declined'].map(s => `
                    <button class="status-btn ${status === s ? 'active' : ''}" onclick="updateApplicationStatus('${app.id}', '${s}'); openOpportunityAppsModal('${oppId}');">${s}</button>
                  `).join('')}
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                  <a href="mailto:${app.email}" class="btn-edit">üìß Email</a>
                  <button class="btn-delete" onclick="deleteApplicationFromModal('${app.id}', '${oppId}')">üóëÔ∏è</button>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      document.getElementById('opportunityAppsModal').classList.add('active');
    }
    
    function closeOpportunityAppsModal() {
      document.getElementById('opportunityAppsModal').classList.remove('active');
    }
    
    async function deleteApplicationFromModal(appId, oppId) {
      if (!confirm('Delete this application?')) return;
      try {
        await db.collection('volunteers').doc(appId).delete();
        applications = applications.filter(a => a.id !== appId);
        openOpportunityAppsModal(oppId);
        renderOpportunities();
      } catch (err) {
        console.error(err);
      }
    }
    
    async function loadApplications() {
      const loading = document.getElementById('applicationsLoading');
      const empty = document.getElementById('applicationsEmpty');
      const list = document.getElementById('applicationsList');
      const countEl = document.getElementById('applicationsCount');
      
      if (!loading) return;
      loading.style.display = 'block';
      empty.style.display = 'none';
      list.innerHTML = '';
      
      try {
        const snapshot = await db.collection('volunteers').get();
        applications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        applications.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        loading.style.display = 'none';
        
        const newCount = applications.filter(a => a.status === 'new' || !a.status).length;
        const badge = document.getElementById('newApplicationsBadge');
        if (badge) {
          badge.textContent = newCount;
          badge.style.display = newCount > 0 ? 'inline' : 'none';
        }
        updateVolunteersTabBadge();
        
        if (applications.length === 0) {
          empty.style.display = 'block';
        } else {
          if (countEl) countEl.textContent = `${applications.length} applications`;
          renderApplications();
        }
        
        // Re-render opportunities to update application counts and badges
        renderOpportunities();
        
        // Refresh dashboard
        scheduleDashboardRefresh();
        
      } catch (error) {
        console.error('Error:', error);
        loading.style.display = 'none';
      }
    }
    
    function filterApplications() { renderApplications(); }
    
    function renderApplications() {
      const list = document.getElementById('applicationsList');
      const filterEl = document.getElementById('applicationStatusFilter');
      if (!list) return;
      const filter = filterEl ? filterEl.value : 'all';
      let filtered = filter === 'all' ? applications : applications.filter(a => (a.status || 'new') === filter);
      
      if (filtered.length === 0) {
        list.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">No applications found.</p>';
        return;
      }
      
      list.innerHTML = filtered.map(app => {
        const opp = opportunities.find(o => o.id === app.opportunityId);
        const date = app.timestamp?.seconds ? new Date(app.timestamp.seconds * 1000).toLocaleDateString() : 'Unknown';
        const status = app.status || 'new';
        
        return `
          <div class="data-card ${status}">
            <div class="data-card-header" onclick="toggleDataExpand('app-${app.id}')">
              <div style="flex: 1;">
                <strong>${app.firstName} ${app.lastName}</strong>
                <span class="status-badge status-${status}">${status}</span>
                ${app.adminNotes ? '<span style="background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; margin-left: 4px;">üìù Notes</span>' : ''}
                <p style="color: var(--text-light); font-size: 0.85rem;">${opp?.title || 'Unknown opportunity'}</p>
                <p style="color: var(--text-light); font-size: 0.85rem;">üìß ${app.email} ‚Ä¢ ${date}</p>
              </div>
              <span id="app-${app.id}-arrow">‚ñ∂</span>
            </div>
            <div id="app-${app.id}-body" class="data-card-body" style="display: none;">
              <p><strong>Phone:</strong> ${app.phone || 'N/A'}</p>
              <p><strong>Message:</strong> ${app.message || 'N/A'}</p>
              <div style="margin-top: 1rem;">
                <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">üìù Admin Notes:</label>
                <textarea id="app-notes-${app.id}" rows="2" style="width: 100%; padding: 0.5rem; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; resize: vertical;" placeholder="Add private notes about this applicant...">${app.adminNotes || ''}</textarea>
                <button onclick="saveApplicationNotes('${app.id}', 'app-notes-${app.id}')" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: var(--primary-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üíæ Save Notes</button>
              </div>
              <div class="status-buttons">
                ${['new', 'contacted', 'interviewing', 'accepted', 'declined'].map(s => `
                  <button class="status-btn ${status === s ? 'active' : ''}" onclick="updateApplicationStatus('${app.id}', '${s}')">${s}</button>
                `).join('')}
              </div>
              <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <a href="mailto:${app.email}" class="btn-edit">üìß Email</a>
                <button class="btn-delete" onclick="deleteApplication('${app.id}')">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function updateApplicationStatus(id, status) {
      try {
        await db.collection('volunteers').doc(id).update({ status });
        const app = applications.find(a => a.id === id);
        if (app) app.status = status;
        renderApplications();
        renderOpportunities();
        const newCount = applications.filter(a => !a.status || a.status === 'new').length;
        const badge = document.getElementById('newApplicationsBadge');
        if (badge) { badge.textContent = newCount; badge.style.display = newCount > 0 ? 'inline' : 'none'; }
      } catch (error) { console.error('Error:', error); }
    }
    
    async function saveApplicationNotes(appId, textareaId, oppId = null) {
      const textarea = document.getElementById(textareaId);
      if (!textarea) return;
      
      const adminNotes = textarea.value.trim();
      const btn = textarea.nextElementSibling;
      const originalText = btn.textContent;
      
      try {
        btn.disabled = true;
        btn.textContent = 'Saving...';
        
        await db.collection('volunteers').doc(appId).update({ 
          adminNotes: adminNotes,
          notesUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update local data
        const app = applications.find(a => a.id === appId);
        if (app) app.adminNotes = adminNotes;
        
        btn.textContent = '‚úì Saved!';
        btn.style.background = 'var(--success)';
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = 'var(--primary-blue)';
          btn.disabled = false;
          // Refresh the view to show/hide the notes indicator
          if (oppId) {
            openOpportunityAppsModal(oppId);
          } else {
            renderApplications();
          }
          renderOpportunities();
        }, 1500);
        
      } catch (error) {
        console.error('Error saving notes:', error);
        btn.textContent = '‚úó Error';
        btn.style.background = 'var(--danger)';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = 'var(--primary-blue)';
          btn.disabled = false;
        }, 2000);
      }
    }
    
    async function deleteApplication(id) {
      if (!confirm('Delete this application?')) return;
      try {
        await db.collection('volunteers').doc(id).delete();
        applications = applications.filter(a => a.id !== id);
        renderApplications();
        renderOpportunities();
        showSuccess('volunteers');
      } catch (error) { console.error('Error:', error); }
    }
    
    function exportApplicationsToCSV() {
      const headers = ['Name', 'Email', 'Phone', 'Opportunity', 'Status', 'Message', 'Admin Notes', 'Date'];
      const rows = applications.map(a => {
        const opp = opportunities.find(o => o.id === a.opportunityId);
        const date = a.timestamp?.seconds ? new Date(a.timestamp.seconds * 1000).toLocaleDateString() : '';
        return [`${a.firstName} ${a.lastName}`, a.email, a.phone || '', opp?.title || '', a.status || 'new', (a.message || '').replace(/"/g, '""'), (a.adminNotes || '').replace(/"/g, '""'), date];
      });
      downloadCSV('volunteer_applications.csv', headers, rows);
    }

    // ===== Data Tab Functions =====
    let providers = [];
    let pledges = [];
    let eventRequests = [];
    let contacts = [];
    
    function switchDataSubTab(subtab) {
      document.querySelectorAll('#data-tab .sub-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`#data-tab .sub-tab[data-subtab="${subtab}"]`).classList.add('active');
      ['providers', 'pledges', 'eventRequests', 'contacts'].forEach(tab => {
        const el = document.getElementById(`${tab}-subtab`);
        if (el) el.style.display = tab === subtab ? 'block' : 'none';
      });
    }
    
    async function loadProviders() {
      const loading = document.getElementById('providersLoading');
      const empty = document.getElementById('providersEmpty');
      const list = document.getElementById('providersList');
      const countEl = document.getElementById('providersCount');
      
      if (!loading) return;
      loading.style.display = 'block';
      empty.style.display = 'none';
      list.innerHTML = '';
      
      try {
        const snapshot = await db.collection('providers').get();
        providers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        providers.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        loading.style.display = 'none';
        
        const newCount = providers.filter(p => !p.status || p.status === 'new').length;
        const badge = document.getElementById('newProvidersBadge');
        if (badge) { badge.textContent = newCount; badge.style.display = newCount > 0 ? 'inline' : 'none'; }
        updateDataTabBadge();
        
        if (providers.length === 0) {
          empty.style.display = 'block';
        } else {
          if (countEl) countEl.textContent = `${providers.length} requests`;
          renderProviders();
        }
        
        // Refresh dashboard
        scheduleDashboardRefresh();
      } catch (error) {
        console.error('Error:', error);
        loading.style.display = 'none';
      }
    }
    
    function filterProviders() { renderProviders(); }
    
    function renderProviders() {
      const list = document.getElementById('providersList');
      const filterEl = document.getElementById('providerStatusFilter');
      if (!list) return;
      const filter = filterEl ? filterEl.value : 'all';
      let filtered = filter === 'all' ? providers : providers.filter(p => (p.status || 'new') === filter);
      
      if (filtered.length === 0) {
        list.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">No requests found.</p>';
        return;
      }
      
      list.innerHTML = filtered.map(p => {
        const date = p.timestamp?.seconds ? new Date(p.timestamp.seconds * 1000).toLocaleDateString() : 'Unknown';
        const status = p.status || 'new';
        return `
          <div class="data-card ${status}">
            <div class="data-card-header" onclick="toggleDataExpand('prov-${p.id}')">
              <div style="flex: 1;">
                <strong>${p.name || p.orgName || 'Unknown'}</strong>
                <span class="status-badge status-${status}">${status}</span>
                <p style="color: var(--text-light); font-size: 0.85rem;">üìß ${p.email} ‚Ä¢ ${date}</p>
              </div>
              <span id="prov-${p.id}-arrow">‚ñ∂</span>
            </div>
            <div id="prov-${p.id}-body" class="data-card-body" style="display: none;">
              <p><strong>Phone:</strong> ${p.phone || 'N/A'}</p>
              <p><strong>Service Type:</strong> ${p.serviceType || 'N/A'}</p>
              <p><strong>Details:</strong> ${p.details || p.message || 'N/A'}</p>
              <div class="status-buttons">
                ${['new', 'contacted', 'in-progress', 'completed', 'archived'].map(s => `
                  <button class="status-btn ${status === s ? 'active' : ''}" onclick="updateProviderStatus('${p.id}', '${s}')">${s}</button>
                `).join('')}
              </div>
              <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <a href="mailto:${p.email}" class="btn-edit">üìß Email</a>
                <button class="btn-delete" onclick="deleteProvider('${p.id}')">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function updateProviderStatus(id, status) {
      try {
        await db.collection('providers').doc(id).update({ status });
        const p = providers.find(x => x.id === id);
        if (p) p.status = status;
        renderProviders();
        const newCount = providers.filter(p => !p.status || p.status === 'new').length;
        const badge = document.getElementById('newProvidersBadge');
        if (badge) { badge.textContent = newCount; badge.style.display = newCount > 0 ? 'inline' : 'none'; }
        updateDataTabBadge();
      } catch (error) { console.error('Error:', error); }
    }
    
    async function deleteProvider(id) {
      if (!confirm('Delete this request?')) return;
      try {
        await db.collection('providers').doc(id).delete();
        providers = providers.filter(p => p.id !== id);
        renderProviders();
        showSuccess('data');
      } catch (error) { console.error('Error:', error); }
    }
    
    function exportProvidersToCSV() {
      const headers = ['Name', 'Email', 'Phone', 'Service Type', 'Status', 'Details', 'Date'];
      const rows = providers.map(p => {
        const date = p.timestamp?.seconds ? new Date(p.timestamp.seconds * 1000).toLocaleDateString() : '';
        return [p.name || p.orgName || '', p.email || '', p.phone || '', p.serviceType || '', p.status || 'new', (p.details || '').replace(/"/g, '""'), date];
      });
      downloadCSV('provider_requests.csv', headers, rows);
    }
    
    async function loadPledges() {
      const loading = document.getElementById('pledgesLoading');
      const empty = document.getElementById('pledgesEmpty');
      const list = document.getElementById('pledgesList');
      const countEl = document.getElementById('pledgesCount');
      
      if (!loading) return;
      loading.style.display = 'block';
      empty.style.display = 'none';
      list.innerHTML = '';
      
      try {
        const snapshot = await db.collection('pledges').get();
        pledges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        pledges.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        loading.style.display = 'none';
        
        const newCount = pledges.filter(p => !p.status || p.status === 'new').length;
        const badge = document.getElementById('newPledgesBadge');
        if (badge) { badge.textContent = newCount; badge.style.display = newCount > 0 ? 'inline' : 'none'; }
        updateDataTabBadge();
        
        if (pledges.length === 0) {
          empty.style.display = 'block';
        } else {
          if (countEl) countEl.textContent = `${pledges.length} pledges`;
          renderPledges();
        }
      } catch (error) {
        console.error('Error:', error);
        loading.style.display = 'none';
      }
    }
    
    function renderPledges() {
      const list = document.getElementById('pledgesList');
      const filterEl = document.getElementById('pledgeStatusFilter');
      if (!list) return;
      const filter = filterEl ? filterEl.value : 'all';
      let filtered = filter === 'all' ? pledges : pledges.filter(p => (p.status || 'new') === filter);
      
      if (filtered.length === 0) {
        list.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">No pledges found.</p>';
        return;
      }
      
      list.innerHTML = filtered.map(p => {
        const date = p.timestamp?.seconds ? new Date(p.timestamp.seconds * 1000).toLocaleDateString() : 'Unknown';
        const status = p.status || 'new';
        return `
          <div class="data-card ${status}">
            <div class="data-card-header" onclick="toggleDataExpand('pledge-${p.id}')">
              <div style="flex: 1;">
                <strong>‚úä ${p.name || 'Anonymous'}</strong>
                <span class="status-badge status-${status}">${status}</span>
                ${p.location ? `<span style="color: var(--text-light); margin-left: 0.5rem;">from ${p.location}</span>` : ''}
                <p style="color: var(--text-light); font-size: 0.85rem;">Pledged on ${date}</p>
              </div>
              <span id="pledge-${p.id}-arrow">‚ñ∂</span>
            </div>
            <div id="pledge-${p.id}-body" class="data-card-body" style="display: none;">
              ${p.email ? `<p><strong>Email:</strong> ${p.email}</p>` : ''}
              ${p.message ? `<p><strong>Message:</strong> ${p.message}</p>` : ''}
              <div class="status-buttons">
                ${['new', 'viewed', 'acknowledged'].map(s => `
                  <button class="status-btn ${status === s ? 'active' : ''}" onclick="updatePledgeStatus('${p.id}', '${s}')">${s}</button>
                `).join('')}
              </div>
              <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                ${p.email ? `<a href="mailto:${p.email}" class="btn-edit">üìß Email</a>` : ''}
                <button class="btn-delete" onclick="deletePledge('${p.id}')">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function filterPledges() { renderPledges(); }
    
    async function updatePledgeStatus(id, status) {
      try {
        await db.collection('pledges').doc(id).update({ status });
        const p = pledges.find(x => x.id === id);
        if (p) p.status = status;
        renderPledges();
        const newCount = pledges.filter(p => !p.status || p.status === 'new').length;
        const badge = document.getElementById('newPledgesBadge');
        if (badge) { badge.textContent = newCount; badge.style.display = newCount > 0 ? 'inline' : 'none'; }
        updateDataTabBadge();
      } catch (error) { console.error('Error:', error); }
    }
    
    async function markAllPledgesViewed() {
      try {
        const newPledges = pledges.filter(p => !p.status || p.status === 'new');
        for (const p of newPledges) {
          await db.collection('pledges').doc(p.id).update({ status: 'viewed' });
          p.status = 'viewed';
        }
        renderPledges();
        const badge = document.getElementById('newPledgesBadge');
        if (badge) { badge.textContent = 0; badge.style.display = 'none'; }
        updateDataTabBadge();
      } catch (error) { console.error('Error:', error); }
    }
    
    async function deletePledge(id) {
      if (!confirm('Delete this pledge?')) return;
      try {
        await db.collection('pledges').doc(id).delete();
        pledges = pledges.filter(p => p.id !== id);
        renderPledges();
        showSuccess('data');
      } catch (error) { console.error('Error:', error); }
    }
    
    function exportPledgesToCSV() {
      const headers = ['Name', 'Location', 'Date'];
      const rows = pledges.map(p => {
        const date = p.timestamp?.seconds ? new Date(p.timestamp.seconds * 1000).toLocaleDateString() : '';
        return [p.name || 'Anonymous', p.location || '', date];
      });
      downloadCSV('anti_bullying_pledges.csv', headers, rows);
    }
    
    async function loadEventRequests() {
      const loading = document.getElementById('eventRequestsLoading');
      const empty = document.getElementById('eventRequestsEmpty');
      const list = document.getElementById('eventRequestsList');
      const countEl = document.getElementById('eventRequestsCount');
      
      if (!loading) return;
      loading.style.display = 'block';
      empty.style.display = 'none';
      list.innerHTML = '';
      
      try {
        const snapshot = await db.collection('eventRequests').get();
        eventRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        eventRequests.sort((a, b) => (b.timestamp?.seconds || b.timestamp || 0) - (a.timestamp?.seconds || a.timestamp || 0));
        loading.style.display = 'none';
        
        const newCount = eventRequests.filter(r => !r.status || r.status === 'pending').length;
        const badge = document.getElementById('newEventRequestsBadge');
        if (badge) { badge.textContent = newCount; badge.style.display = newCount > 0 ? 'inline' : 'none'; }
        updateDataTabBadge();
        
        if (eventRequests.length === 0) {
          empty.style.display = 'block';
        } else {
          if (countEl) countEl.textContent = `${eventRequests.length} requests`;
          renderEventRequests();
        }
      } catch (error) {
        console.error('Error:', error);
        loading.style.display = 'none';
      }
    }
    
    function filterEventRequests() { renderEventRequests(); }
    
    function renderEventRequests() {
      const list = document.getElementById('eventRequestsList');
      const filterEl = document.getElementById('eventRequestStatusFilter');
      if (!list) return;
      const filter = filterEl ? filterEl.value : 'all';
      let filtered = filter === 'all' ? eventRequests : eventRequests.filter(r => (r.status || 'pending') === filter);
      
      if (filtered.length === 0) {
        list.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">No event requests found.</p>';
        return;
      }
      
      list.innerHTML = filtered.map(r => {
        const timestamp = r.timestamp?.seconds ? r.timestamp.seconds * 1000 : r.timestamp;
        const date = timestamp ? new Date(timestamp).toLocaleDateString() : 'Unknown';
        const status = r.status || 'pending';
        
        return `
          <div class="data-card ${status}">
            <div class="data-card-header" onclick="toggleDataExpand('er-${r.id}')">
              <div style="flex: 1;">
                <strong>üìÖ ${r.name}</strong>
                <span class="status-badge status-${status}">${status}</span>
                <p style="color: var(--text-light); font-size: 0.85rem;">Preferred: ${r.preferredDate || 'Not specified'}</p>
                <p style="color: var(--text-light); font-size: 0.85rem;">üìß ${r.email} ‚Ä¢ ${date}</p>
              </div>
              <span id="er-${r.id}-arrow">‚ñ∂</span>
            </div>
            <div id="er-${r.id}-body" class="data-card-body" style="display: none;">
              <p><strong>Phone:</strong> ${r.phone || 'N/A'}</p>
              <p><strong>Sponsor:</strong> ${r.sponsor || 'N/A'}</p>
              <p><strong>Event Info:</strong></p>
              <p style="background: #f0fdfa; padding: 0.75rem; border-radius: 8px; margin: 0.5rem 0;">${r.eventInfo || 'N/A'}</p>
              <div class="status-buttons">
                ${['pending', 'reviewed', 'approved', 'scheduled', 'declined', 'completed'].map(s => `
                  <button class="status-btn ${status === s ? 'active' : ''}" onclick="updateEventRequestStatus('${r.id}', '${s}')">${s}</button>
                `).join('')}
              </div>
              <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <a href="mailto:${r.email}" class="btn-edit">üìß Email</a>
                <button class="btn-delete" onclick="deleteEventRequest('${r.id}')">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function updateEventRequestStatus(id, status) {
      try {
        await db.collection('eventRequests').doc(id).update({ status });
        const r = eventRequests.find(x => x.id === id);
        if (r) r.status = status;
        renderEventRequests();
        const newCount = eventRequests.filter(r => !r.status || r.status === 'pending').length;
        const badge = document.getElementById('newEventRequestsBadge');
        if (badge) { badge.textContent = newCount; badge.style.display = newCount > 0 ? 'inline' : 'none'; }
        updateDataTabBadge();
      } catch (error) { console.error('Error:', error); }
    }
    
    async function deleteEventRequest(id) {
      if (!confirm('Delete this event request?')) return;
      try {
        await db.collection('eventRequests').doc(id).delete();
        eventRequests = eventRequests.filter(r => r.id !== id);
        renderEventRequests();
        showSuccess('data');
      } catch (error) { console.error('Error:', error); }
    }
    
    function exportEventRequestsToCSV() {
      const headers = ['Name', 'Email', 'Phone', 'Preferred Date', 'Sponsor', 'Status', 'Event Info', 'Submitted'];
      const rows = eventRequests.map(r => {
        const timestamp = r.timestamp?.seconds ? r.timestamp.seconds * 1000 : r.timestamp;
        const date = timestamp ? new Date(timestamp).toLocaleDateString() : '';
        return [r.name || '', r.email || '', r.phone || '', r.preferredDate || '', r.sponsor || '', r.status || 'pending', (r.eventInfo || '').replace(/"/g, '""'), date];
      });
      downloadCSV('event_requests.csv', headers, rows);
    }
    
    async function loadContacts() {
      const loading = document.getElementById('contactsLoading');
      const empty = document.getElementById('contactsEmpty');
      const list = document.getElementById('contactsList');
      const countEl = document.getElementById('contactsCount');
      
      if (!loading) return;
      loading.style.display = 'block';
      empty.style.display = 'none';
      list.innerHTML = '';
      
      try {
        const snapshot = await db.collection('contactSubmissions').get();
        contacts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        contacts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        loading.style.display = 'none';
        
        const newCount = contacts.filter(c => !c.status || c.status === 'new').length;
        const badge = document.getElementById('newContactsBadge');
        if (badge) { badge.textContent = newCount; badge.style.display = newCount > 0 ? 'inline' : 'none'; }
        updateDataTabBadge();
        
        if (contacts.length === 0) {
          empty.style.display = 'block';
        } else {
          if (countEl) countEl.textContent = `${contacts.length} messages`;
          renderContacts();
        }
        
        // Refresh dashboard
        scheduleDashboardRefresh();
      } catch (error) {
        console.error('Error:', error);
        loading.style.display = 'none';
      }
    }
    
    function filterContacts() { renderContacts(); }
    
    function renderContacts() {
      const list = document.getElementById('contactsList');
      const filterEl = document.getElementById('contactStatusFilter');
      if (!list) return;
      const filter = filterEl ? filterEl.value : 'all';
      let filtered = filter === 'all' ? contacts : contacts.filter(c => (c.status || 'new') === filter);
      
      if (filtered.length === 0) {
        list.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">No messages found.</p>';
        return;
      }
      
      list.innerHTML = filtered.map(c => {
        const date = c.timestamp?.seconds ? new Date(c.timestamp.seconds * 1000).toLocaleDateString() : 'Unknown';
        const status = c.status || 'new';
        return `
          <div class="data-card ${status}">
            <div class="data-card-header" onclick="toggleDataExpand('contact-${c.id}')">
              <div style="flex: 1;">
                <strong>${c.name || 'Unknown'}</strong>
                <span class="status-badge status-${status}">${status}</span>
                <p style="color: var(--text-light); font-size: 0.85rem;">üìß ${c.email} ‚Ä¢ ${date}</p>
              </div>
              <span id="contact-${c.id}-arrow">‚ñ∂</span>
            </div>
            <div id="contact-${c.id}-body" class="data-card-body" style="display: none;">
              <p><strong>Phone:</strong> ${c.phone || 'N/A'}</p>
              <p><strong>Message:</strong></p>
              <p style="background: #f9fafb; padding: 0.75rem; border-radius: 8px; white-space: pre-wrap;">${c.message || 'N/A'}</p>
              <div class="status-buttons">
                ${['new', 'read', 'replied'].map(s => `
                  <button class="status-btn ${status === s ? 'active' : ''}" onclick="updateContactStatus('${c.id}', '${s}')">${s}</button>
                `).join('')}
              </div>
              <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <a href="mailto:${c.email}" class="btn-edit">üìß Reply</a>
                <button class="btn-delete" onclick="deleteContact('${c.id}')">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function updateContactStatus(id, status) {
      try {
        await db.collection('contactSubmissions').doc(id).update({ status });
        const c = contacts.find(x => x.id === id);
        if (c) c.status = status;
        renderContacts();
        const newCount = contacts.filter(c => !c.status || c.status === 'new').length;
        const badge = document.getElementById('newContactsBadge');
        if (badge) { badge.textContent = newCount; badge.style.display = newCount > 0 ? 'inline' : 'none'; }
        updateDataTabBadge();
      } catch (error) { console.error('Error:', error); }
    }
    
    async function deleteContact(id) {
      if (!confirm('Delete this message?')) return;
      try {
        await db.collection('contactSubmissions').doc(id).delete();
        contacts = contacts.filter(c => c.id !== id);
        renderContacts();
        showSuccess('data');
      } catch (error) { console.error('Error:', error); }
    }
    
    function exportContactsToCSV() {
      const headers = ['Name', 'Email', 'Phone', 'Status', 'Message', 'Date'];
      const rows = contacts.map(c => {
        const date = c.timestamp?.seconds ? new Date(c.timestamp.seconds * 1000).toLocaleDateString() : '';
        return [c.name || '', c.email || '', c.phone || '', c.status || 'new', (c.message || '').replace(/"/g, '""'), date];
      });
      downloadCSV('contact_messages.csv', headers, rows);
    }
    
    function toggleDataExpand(id) {
      const body = document.getElementById(`${id}-body`);
      const arrow = document.getElementById(`${id}-arrow`);
      if (!body || !arrow) return;
      const isHidden = body.style.display === 'none';
      body.style.display = isHidden ? 'block' : 'none';
      arrow.textContent = isHidden ? '‚ñº' : '‚ñ∂';
    }
    
    function downloadCSV(filename, headers, rows) {
      const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${v}"`).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ===== Analytics Functions =====
    let allEventSignups = [];
    
    function updateAnalyticsDateRange() {
      const range = document.getElementById('analyticsDateRange').value;
      const custom = document.getElementById('customDateRange');
      if (custom) custom.style.display = range === 'custom' ? 'flex' : 'none';
    }
    
    // Refresh dashboard using already-loaded data (no extra Firebase reads)
    function refreshDashboard() {
      const loading = document.getElementById('analyticsLoading');
      if (loading) loading.style.display = 'none';
      
      // Build allEventSignups from already-loaded eventSignups object
      allEventSignups = [];
      for (const eventId in eventSignups) {
        const event = events.find(e => e.id === eventId);
        const eventTitle = event?.title || 'Unknown Event';
        eventSignups[eventId].forEach(signup => {
          allEventSignups.push({ ...signup, eventId, eventTitle });
        });
      }
      
      calculateAnalytics();
    }
    
    // Manual refresh button - only re-fetch if user explicitly asks
    async function loadAnalytics() {
      const loading = document.getElementById('analyticsLoading');
      if (loading) loading.style.display = 'block';
      
      try {
        // Re-fetch event signups fresh from Firebase (only on manual refresh)
        allEventSignups = [];
        for (const event of events) {
          const signupsSnap = await db.collection('events').doc(event.id).collection('signups').get();
          signupsSnap.docs.forEach(doc => {
            allEventSignups.push({ ...doc.data(), eventId: event.id, eventTitle: event.title });
          });
          // Update the cached eventSignups too
          eventSignups[event.id] = signupsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        }
        
        if (loading) loading.style.display = 'none';
        calculateAnalytics();
      } catch (error) {
        console.error('Error refreshing analytics:', error);
        if (loading) loading.style.display = 'none';
      }
    }
    
    function getDateRange() {
      const range = document.getElementById('analyticsDateRange')?.value || 'year';
      const now = new Date();
      let start, end;
      
      switch (range) {
        case 'month':
          start = new Date(now.getFullYear(), now.getMonth(), 1);
          end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          break;
        case 'quarter':
          const quarter = Math.floor(now.getMonth() / 3);
          start = new Date(now.getFullYear(), quarter * 3, 1);
          end = new Date(now.getFullYear(), quarter * 3 + 3, 0);
          break;
        case 'custom':
          start = document.getElementById('analyticsStartDate')?.value ? new Date(document.getElementById('analyticsStartDate').value) : new Date(now.getFullYear(), 0, 1);
          end = document.getElementById('analyticsEndDate')?.value ? new Date(document.getElementById('analyticsEndDate').value) : now;
          break;
        default:
          start = new Date(now.getFullYear(), 0, 1);
          end = new Date(now.getFullYear(), 11, 31);
      }
      return { start, end };
    }
    
    function filterByDate(items, dateField = 'timestamp') {
      const { start, end } = getDateRange();
      return items.filter(item => {
        let date;
        if (item[dateField]?.seconds) date = new Date(item[dateField].seconds * 1000);
        else if (item[dateField]) date = new Date(item[dateField]);
        else return true; // Include items without timestamps
        return date >= start && date <= end;
      });
    }
    
    function calculateAnalytics() {
      // Build allEventSignups from cached data
      allEventSignups = [];
      for (const eventId in eventSignups) {
        const event = events.find(e => e.id === eventId);
        const eventTitle = event?.title || 'Unknown Event';
        (eventSignups[eventId] || []).forEach(signup => {
          allEventSignups.push({ ...signup, eventId, eventTitle });
        });
      }
      
      // Calculate "needs attention" counts (items with new/pending status) - ALL TIME
      let newSignupsCount = 0;
      for (const eventId in eventSignups) {
        newSignupsCount += (eventSignups[eventId] || []).filter(s => !s.status || s.status === 'new' || s.status === 'pending').length;
      }
      const newVolunteersCount = applications.filter(a => !a.status || a.status === 'new').length;
      const newContactsCount = contacts.filter(c => !c.status || c.status === 'new').length;
      const newProvidersCount = providers.filter(p => !p.status || p.status === 'new').length;
      
      // Calculate totals - ALL TIME (not filtered by date for main KPIs)
      const totalSignups = allEventSignups.length;
      const totalVolunteers = applications.length;
      const totalContacts = contacts.length;
      const totalProviders = providers.length;
      
      // Update main KPI cards with ALL-TIME totals
      document.getElementById('statEventSignups').textContent = totalSignups.toLocaleString();
      document.getElementById('statVolunteerApps').textContent = totalVolunteers.toLocaleString();
      document.getElementById('statContacts').textContent = totalContacts.toLocaleString();
      document.getElementById('statProviders').textContent = totalProviders.toLocaleString();
      
      // Update attention badges
      updateAttentionBadge('eventSignupsAttention', newSignupsCount, 'need review');
      updateAttentionBadge('volunteerAppsAttention', newVolunteersCount, 'new');
      updateAttentionBadge('contactsAttention', newContactsCount, 'unread');
      updateAttentionBadge('providersAttention', newProvidersCount, 'new');
      
      // Update KPI subtexts
      document.getElementById('eventSignupsSubtext').textContent = `Total all-time signups`;
      document.getElementById('volunteerAppsSubtext').textContent = `Total applications received`;
      document.getElementById('contactsSubtext').textContent = `Total messages received`;
      document.getElementById('providersSubtext').textContent = `Total provider requests`;
      
      // Update content overview counts
      document.getElementById('contentTeamCount').textContent = teamMembers.length;
      document.getElementById('contentBoardCount').textContent = boardMembers.length;
      document.getElementById('contentResourcesCount').textContent = resources.length;
      document.getElementById('contentEventsCount').textContent = events.filter(e => {
        if (!e.date && !e.startDate && !e.eventDate) return true;
        const eventDate = new Date(e.startDate || e.eventDate || e.date);
        return eventDate >= new Date();
      }).length;
      document.getElementById('contentOpportunitiesCount').textContent = opportunities.length;
      document.getElementById('contentFaqCount').textContent = faqs.length;
      
      // Update action items banner
      updateActionItemsBanner();
      
      // Event breakdown - show ALL events with signup counts
      updateEventPerformance();
      
      // Volunteer opportunities breakdown
      updateVolunteerPerformance();
      
      // Recent activity feed
      updateRecentActivityFeed();
      
      // Pledge stats
      document.getElementById('totalPledgesCount').textContent = pledges.length.toLocaleString();
      const pledgesByMonthEl = document.getElementById('pledgesByMonth');
      if (pledgesByMonthEl) {
        const now = new Date();
        const thisMonth = pledges.filter(p => {
          const ts = p.timestamp?.seconds ? new Date(p.timestamp.seconds * 1000) : (p.timestamp ? new Date(p.timestamp) : null);
          if (!ts) return false;
          return ts.getMonth() === now.getMonth() && ts.getFullYear() === now.getFullYear();
        }).length;
        pledgesByMonthEl.innerHTML = `<strong>${thisMonth}</strong> new pledges this month`;
      }
    }
    
    // Event Performance breakdown
    function updateEventPerformance() {
      const breakdownEl = document.getElementById('eventBreakdown');
      if (!breakdownEl) return;
      
      if (events.length === 0) {
        breakdownEl.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 1rem;">No events yet.</p>';
        return;
      }
      
      // Build event data with signup counts
      const eventData = events.map(event => {
        const signups = eventSignups[event.id] || [];
        const totalParticipants = signups.reduce((sum, s) => sum + (parseInt(s.numVolunteers) || 1), 0);
        const pendingCount = signups.filter(s => !s.status || s.status === 'new' || s.status === 'pending').length;
        return {
          id: event.id,
          title: event.title || 'Untitled Event',
          signupCount: signups.length,
          participantCount: totalParticipants,
          pendingCount,
          date: event.startDate || event.eventDate || event.date
        };
      });
      
      // Sort by signup count descending
      eventData.sort((a, b) => b.signupCount - a.signupCount);
      
      breakdownEl.innerHTML = eventData.slice(0, 8).map(e => `
        <div class="breakdown-item" style="cursor: pointer;" onclick="document.querySelector('[data-tab=events]').click();">
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${e.title}</div>
            <div style="font-size: 0.75rem; color: var(--text-light);">${e.date ? new Date(e.date).toLocaleDateString() : 'No date'}</div>
          </div>
          <div style="text-align: right;">
            <div style="font-weight: 700; color: var(--primary-blue);">${e.signupCount} signups</div>
            ${e.pendingCount > 0 ? `<div style="font-size: 0.75rem; color: #dc2626;">‚ö†Ô∏è ${e.pendingCount} pending</div>` : ''}
          </div>
        </div>
      `).join('') || '<p style="color: var(--text-light); text-align: center; padding: 1rem;">No events yet.</p>';
    }
    
    // Volunteer Opportunities Performance breakdown
    function updateVolunteerPerformance() {
      const breakdownEl = document.getElementById('volunteerBreakdown');
      if (!breakdownEl) return;
      
      if (opportunities.length === 0) {
        breakdownEl.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 1rem;">No volunteer opportunities yet.</p>';
        return;
      }
      
      // Count applications per opportunity
      const oppData = opportunities.map(opp => {
        const oppApplications = applications.filter(a => a.opportunity === opp.title || a.opportunityId === opp.id);
        const newCount = oppApplications.filter(a => !a.status || a.status === 'new').length;
        return {
          id: opp.id,
          title: opp.title || 'Untitled Opportunity',
          applicationCount: oppApplications.length,
          newCount,
          commitment: opp.commitment || ''
        };
      });
      
      // Sort by application count descending
      oppData.sort((a, b) => b.applicationCount - a.applicationCount);
      
      breakdownEl.innerHTML = oppData.slice(0, 8).map(o => `
        <div class="breakdown-item" style="cursor: pointer;" onclick="document.querySelector('[data-tab=volunteers]').click();">
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${o.title}</div>
            <div style="font-size: 0.75rem; color: var(--text-light);">${o.commitment || 'Flexible'}</div>
          </div>
          <div style="text-align: right;">
            <div style="font-weight: 700; color: #10b981;">${o.applicationCount} applications</div>
            ${o.newCount > 0 ? `<div style="font-size: 0.75rem; color: #dc2626;">‚ö†Ô∏è ${o.newCount} new</div>` : ''}
          </div>
        </div>
      `).join('') || '<p style="color: var(--text-light); text-align: center; padding: 1rem;">No opportunities yet.</p>';
    }
    
    // Helper function to update attention badges on KPI cards
    function updateAttentionBadge(elementId, count, label) {
      const badge = document.getElementById(elementId);
      if (!badge) return;
      
      if (count > 0) {
        badge.textContent = `${count} ${label}`;
        badge.classList.add('has-items');
      } else {
        badge.textContent = '';
        badge.classList.remove('has-items');
      }
    }
    
    function updateActionItemsBanner() {
      const banner = document.getElementById('actionItemsBanner');
      const list = document.getElementById('actionItemsList');
      if (!banner || !list) return;
      
      const items = [];
      
      // Check for new volunteer applications
      const newVolunteers = applications.filter(a => !a.status || a.status === 'new').length;
      if (newVolunteers > 0) {
        items.push({
          icon: 'ü§ù',
          text: `${newVolunteers} new volunteer application${newVolunteers > 1 ? 's' : ''}`,
          count: newVolunteers,
          action: () => document.querySelector('[data-tab="volunteers"]').click()
        });
      }
      
      // Check for new contact messages
      const newContacts = contacts.filter(c => !c.status || c.status === 'new').length;
      if (newContacts > 0) {
        items.push({
          icon: '‚úâÔ∏è',
          text: `${newContacts} new contact message${newContacts > 1 ? 's' : ''}`,
          count: newContacts,
          action: () => { document.querySelector('[data-tab="data"]').click(); setTimeout(() => switchDataSubTab('contacts'), 100); }
        });
      }
      
      // Check for new provider requests
      const newProviders = providers.filter(p => !p.status || p.status === 'new').length;
      if (newProviders > 0) {
        items.push({
          icon: 'üìã',
          text: `${newProviders} new provider request${newProviders > 1 ? 's' : ''}`,
          count: newProviders,
          action: () => { document.querySelector('[data-tab="data"]').click(); setTimeout(() => switchDataSubTab('providers'), 100); }
        });
      }
      
      // Check for pending event requests
      const pendingEvents = eventRequests.filter(r => !r.status || r.status === 'pending').length;
      if (pendingEvents > 0) {
        items.push({
          icon: 'üìÖ',
          text: `${pendingEvents} pending event request${pendingEvents > 1 ? 's' : ''}`,
          count: pendingEvents,
          action: () => { document.querySelector('[data-tab="data"]').click(); setTimeout(() => switchDataSubTab('eventRequests'), 100); }
        });
      }
      
      // Check for new event signups
      let newSignups = 0;
      for (const eventId in eventSignups) {
        newSignups += eventSignups[eventId].filter(s => !s.status || s.status === 'new' || s.status === 'pending').length;
      }
      if (newSignups > 0) {
        items.push({
          icon: 'üìù',
          text: `${newSignups} new event signup${newSignups > 1 ? 's' : ''} to review`,
          count: newSignups,
          action: () => document.querySelector('[data-tab="events"]').click()
        });
      }
      
      if (items.length === 0) {
        banner.style.display = 'none';
      } else {
        banner.style.display = 'block';
        list.innerHTML = items.map(item => `
          <div class="action-item" onclick="(${item.action.toString()})()">
            <span>${item.icon}</span>
            <span style="flex: 1;">${item.text}</span>
            <span class="action-item-badge">${item.count}</span>
          </div>
        `).join('');
      }
    }
    
    function updateRecentActivityFeed() {
      const feed = document.getElementById('recentActivityFeed');
      if (!feed) return;
      
      const activities = [];
      
      // Add recent signups with more details
      allEventSignups.forEach(s => {
        const ts = s.timestamp?.seconds ? s.timestamp.seconds * 1000 : (s.createdAt?.seconds ? s.createdAt.seconds * 1000 : null);
        if (!ts) return;
        const numPeople = parseInt(s.numVolunteers) || 1;
        const peopleText = numPeople > 1 ? ` (${numPeople} people)` : '';
        activities.push({
          type: 'event',
          icon: 'üìÖ',
          title: s.contactName || s.name || 'Someone',
          subtitle: `signed up for ${s.eventTitle || 'an event'}${peopleText}`,
          detail: s.email || s.phone || '',
          status: s.status || 'new',
          time: ts,
          action: () => document.querySelector('[data-tab="events"]').click()
        });
      });
      
      // Add recent volunteer apps with more details
      applications.forEach(a => {
        const ts = a.timestamp?.seconds ? a.timestamp.seconds * 1000 : (a.createdAt?.seconds ? a.createdAt.seconds * 1000 : null);
        if (!ts) return;
        activities.push({
          type: 'volunteer',
          icon: 'ü§ù',
          title: a.name || 'Someone',
          subtitle: `applied for ${a.opportunity || 'volunteer position'}`,
          detail: a.email || a.phone || '',
          status: a.status || 'new',
          time: ts,
          action: () => { document.querySelector('[data-tab="volunteers"]').click(); setTimeout(() => switchVolunteerSubTab('applications'), 100); }
        });
      });
      
      // Add recent contacts with more details
      contacts.forEach(c => {
        const ts = c.timestamp?.seconds ? c.timestamp.seconds * 1000 : (c.createdAt?.seconds ? c.createdAt.seconds * 1000 : null);
        if (!ts) return;
        const msgPreview = c.message ? (c.message.length > 50 ? c.message.substring(0, 50) + '...' : c.message) : '';
        activities.push({
          type: 'contact',
          icon: '‚úâÔ∏è',
          title: c.name || 'Someone',
          subtitle: 'sent a message',
          detail: msgPreview,
          status: c.status || 'new',
          time: ts,
          action: () => { document.querySelector('[data-tab="data"]').click(); setTimeout(() => switchDataSubTab('contacts'), 100); }
        });
      });
      
      // Add recent provider requests
      providers.forEach(p => {
        const ts = p.timestamp?.seconds ? p.timestamp.seconds * 1000 : (p.createdAt?.seconds ? p.createdAt.seconds * 1000 : null);
        if (!ts) return;
        activities.push({
          type: 'provider',
          icon: 'üìã',
          title: p.organizationName || p.name || 'Provider',
          subtitle: 'requested listing',
          detail: p.serviceType || p.category || '',
          status: p.status || 'new',
          time: ts,
          action: () => { document.querySelector('[data-tab="data"]').click(); setTimeout(() => switchDataSubTab('providers'), 100); }
        });
      });
      
      // Add recent pledges
      pledges.forEach(p => {
        const ts = p.timestamp?.seconds ? p.timestamp.seconds * 1000 : (p.createdAt?.seconds ? p.createdAt.seconds * 1000 : null);
        if (!ts) return;
        activities.push({
          type: 'pledge',
          icon: '‚úä',
          title: p.name || 'Anonymous',
          subtitle: 'took the anti-bullying pledge',
          detail: p.location || '',
          status: 'viewed',
          time: ts,
          action: () => { document.querySelector('[data-tab="data"]').click(); setTimeout(() => switchDataSubTab('pledges'), 100); }
        });
      });
      
      // Sort by time (newest first)
      activities.sort((a, b) => b.time - a.time);
      
      if (activities.length === 0) {
        feed.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 1rem;">No recent activity.</p>';
      } else {
        feed.innerHTML = activities.slice(0, 10).map(a => {
          const timeAgo = getTimeAgo(a.time);
          const isNew = a.status === 'new' || a.status === 'pending';
          return `
            <div class="activity-item${isNew ? ' activity-new' : ''}" onclick="(${a.action.toString()})()" style="cursor: pointer;">
              <div class="activity-icon ${a.type}">${a.icon}</div>
              <div class="activity-content">
                <div class="activity-text">
                  <strong>${a.title}</strong> ${a.subtitle}
                  ${isNew ? '<span class="activity-new-badge">NEW</span>' : ''}
                </div>
                ${a.detail ? `<div class="activity-detail">${a.detail}</div>` : ''}
                <div class="activity-time">${timeAgo}</div>
              </div>
            </div>
          `;
        }).join('');
      }
    }
    
    function getTimeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days === 1) return 'Yesterday';
      if (days < 7) return `${days} days ago`;
      if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
      return new Date(timestamp).toLocaleDateString();
    }
    
    function exportAnalyticsReport() {
      const { start, end } = getDateRange();
      let report = `LDAH Analytics Report\n`;
      report += `Period: ${start.toLocaleDateString()} - ${end.toLocaleDateString()}\n`;
      report += `Generated: ${new Date().toLocaleString()}\n\n`;
      report += `Note: Page views available in Firebase Analytics Console\n`;
      report += `Event Signups: ${document.getElementById('statEventSignups').textContent}\n`;
      report += `Volunteer Apps: ${document.getElementById('statVolunteerApps').textContent}\n`;
      report += `Contact Messages: ${document.getElementById('statContacts').textContent}\n`;
      
      const blob = new Blob([report], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ldah_analytics_report.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ===== Utility =====
    function showSuccess(type) {
      const successEl = document.getElementById(type + 'Success');
      successEl.style.display = 'block';
      setTimeout(() => {
        successEl.style.display = 'none';
      }, 3000);
    }
    
    // Update Data tab badge (sum of all data sub-tab badges)
    function updateDataTabBadge() {
      const providersNew = providers.filter(p => !p.status || p.status === 'new').length;
      const pledgesNew = pledges.filter(p => !p.status || p.status === 'new').length;
      const eventRequestsNew = eventRequests.filter(r => !r.status || r.status === 'pending').length;
      const contactsNew = contacts.filter(c => !c.status || c.status === 'new').length;
      const total = providersNew + pledgesNew + eventRequestsNew + contactsNew;
      
      const badge = document.getElementById('dataTabBadge');
      if (badge) {
        badge.textContent = total;
        badge.style.display = total > 0 ? 'inline' : 'none';
      }
    }
    
    // Update Volunteers tab badge
    function updateVolunteersTabBadge() {
      const newCount = applications.filter(a => !a.status || a.status === 'new').length;
      const badge = document.getElementById('volunteersTabBadge');
      if (badge) {
        badge.textContent = newCount;
        badge.style.display = newCount > 0 ? 'inline' : 'none';
      }
    }
    
    // Update Events tab badge
    function updateEventsTabBadge() {
      let totalNewSignups = 0;
      for (const eventId in eventSignups) {
        totalNewSignups += eventSignups[eventId].filter(s => !s.status || s.status === 'new' || s.status === 'pending').length;
      }
      const badge = document.getElementById('eventsTabBadge');
      if (badge) {
        badge.textContent = totalNewSignups;
        badge.style.display = totalNewSignups > 0 ? 'inline' : 'none';
      }
    }

    // ===== Init on Load =====
    window.addEventListener('load', () => {
      if (sessionStorage.getItem('cmsLoggedIn') === 'true') {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('cmsPanel').style.display = 'block';
        initializeCMS();
      }
    });
  </script>
</body>
</html>
