<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDAH Resources Import Tool</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, sans-serif; background: #f0f4f8; padding: 2rem; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #004E7C; margin-bottom: 1rem; }
        .info { background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; color: #1565c0; }
        button { background: linear-gradient(135deg, #004E7C, #0066a1); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-right: 1rem; margin-bottom: 1rem; }
        button:hover { transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.danger { background: #dc3545; }
        #log { background: #1a1a1a; color: #4ade80; padding: 1.5rem; border-radius: 8px; font-family: monospace; font-size: 0.85rem; max-height: 400px; overflow-y: auto; white-space: pre-wrap; margin-top: 1.5rem; }
        .error { color: #f87171; }
        .progress { background: #e2e8f0; border-radius: 8px; height: 24px; margin: 1rem 0; overflow: hidden; }
        .progress-bar { background: linear-gradient(135deg, #004E7C, #0066a1); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
        input[type="file"] { margin: 1rem 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö LDAH Resources Import Tool</h1>
        <div class="info">
            <strong>Instructions:</strong><br>
            1. First update your Firestore rules to include the <code>resources</code> collection<br>
            2. Select the CSV file exported from Airtable<br>
            3. Click "Import Resources" to upload all data to Firebase
        </div>
        
        <input type="file" id="csvFile" accept=".csv">
        <br><br>
        <button onclick="importResources()">üì§ Import Resources</button>
        <button onclick="clearResources()" class="danger">üóëÔ∏è Clear All Resources</button>
        <button onclick="testConnection()" style="background: #6b7280;">üîå Test Connection</button>
        
        <div class="progress">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        
        <div id="log">Ready. Select a CSV file to begin...\n</div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAU3CQ07bCVKlJ1qGak-150kaJEyPKldLk",
            authDomain: "ldah-932d5.firebaseapp.com",
            projectId: "ldah-932d5",
            storageBucket: "ldah-932d5.firebasestorage.app",
            messagingSenderId: "662130454003",
            appId: "1:662130454003:web:437576d5a5811ecd8df686"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const logEl = document.getElementById('log');
        const progressBar = document.getElementById('progressBar');

        function log(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `<span class="${isError ? 'error' : ''}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            progressBar.style.width = percent + '%';
            progressBar.textContent = `${percent}% (${current}/${total})`;
        }

        // Parse CSV
        function parseCSV(text) {
            const lines = [];
            let currentLine = '';
            let inQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                    currentLine += char;
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (currentLine.trim()) {
                        lines.push(currentLine);
                    }
                    currentLine = '';
                    if (char === '\r' && text[i + 1] === '\n') i++;
                } else {
                    currentLine += char;
                }
            }
            if (currentLine.trim()) lines.push(currentLine);
            
            // Parse each line
            const result = [];
            for (const line of lines) {
                const row = [];
                let cell = '';
                let inQuotes2 = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        if (inQuotes2 && line[i + 1] === '"') {
                            cell += '"';
                            i++;
                        } else {
                            inQuotes2 = !inQuotes2;
                        }
                    } else if (char === ',' && !inQuotes2) {
                        row.push(cell.trim());
                        cell = '';
                    } else {
                        cell += char;
                    }
                }
                row.push(cell.trim());
                result.push(row);
            }
            return result;
        }

        // Extract URL from Airtable format
        function extractUrl(field) {
            if (!field) return '';
            const match = field.match(/\((https?:\/\/[^)]+)\)/);
            return match ? match[1] : '';
        }

        // Parse city, state, zip
        function parseCityStateZip(field) {
            if (!field) return { city: '', state: '', zip: '' };
            const cleaned = field.replace(/[\n\r]/g, ' ').trim();
            const match = cleaned.match(/^([^,]+),?\s*([A-Z]{2})\s*(\d{5})?/i);
            if (match) {
                return { city: match[1].trim(), state: match[2].toUpperCase(), zip: match[3] || '' };
            }
            return { city: cleaned, state: 'HI', zip: '' };
        }

        // Clean website URL
        function cleanWebsite(url) {
            if (!url) return '';
            let cleaned = url.replace(/[\n\r]/g, '').trim();
            if (cleaned && !cleaned.startsWith('http')) {
                cleaned = 'https://' + cleaned;
            }
            return cleaned;
        }

        async function testConnection() {
            log('Testing Firebase connection...');
            try {
                await auth.signInAnonymously();
                log('‚úÖ Authentication successful');
                
                const testDoc = await db.collection('resources').limit(1).get();
                log(`‚úÖ Firestore connected. Current resources: ${testDoc.size > 0 ? 'has data' : 'empty'}`);
            } catch (error) {
                log('‚ùå Connection failed: ' + error.message, true);
            }
        }

        async function clearResources() {
            if (!confirm('Are you sure you want to delete ALL resources?')) return;
            
            log('Clearing all resources...');
            try {
                await auth.signInAnonymously();
                const snapshot = await db.collection('resources').get();
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                
                log(`‚úÖ Deleted ${snapshot.size} resources`);
            } catch (error) {
                log('‚ùå Error: ' + error.message, true);
            }
        }

        async function importResources() {
            const fileInput = document.getElementById('csvFile');
            if (!fileInput.files.length) {
                log('‚ùå Please select a CSV file first', true);
                return;
            }

            const file = fileInput.files[0];
            log(`Reading file: ${file.name}`);

            try {
                await auth.signInAnonymously();
                log('‚úÖ Authenticated');

                const text = await file.text();
                // Remove BOM if present
                const cleanText = text.replace(/^\uFEFF/, '');
                const rows = parseCSV(cleanText);
                
                if (rows.length < 2) {
                    log('‚ùå CSV file appears empty or invalid', true);
                    return;
                }

                const headers = rows[0];
                log(`Found ${rows.length - 1} resources to import`);
                log(`Headers: ${headers.join(', ')}`);

                // Map headers to indices
                const headerMap = {};
                headers.forEach((h, i) => headerMap[h.toLowerCase().trim()] = i);

                let imported = 0;
                let errors = 0;

                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row[0]) continue; // Skip empty rows

                    try {
                        const name = row[headerMap['name']] || '';
                        const logoField = row[headerMap['logo']] || '';
                        const typeField = row[headerMap['resource type']] || '';
                        const person = row[headerMap['person']] || '';
                        const address = row[headerMap['address']] || '';
                        const cityStateZip = row[headerMap['city, state, zip']] || '';
                        const phone = row[headerMap['phone']] || '';
                        const fax = row[headerMap['fax']] || '';
                        const email = row[headerMap['email']] || '';
                        const website = row[headerMap['website']] || '';
                        const services = row[headerMap['services']] || '';
                        const notes = row[headerMap['notes']] || '';
                        const island = row[headerMap['island']] || '';

                        const location = parseCityStateZip(cityStateZip);
                        const types = typeField ? typeField.split(',').map(t => t.trim()).filter(t => t) : [];

                        const resource = {
                            name: name.trim(),
                            logo: extractUrl(logoField),
                            types: types,
                            type: types[0] || 'Specialized Resources', // Primary type for filtering
                            person: person.replace(/[\n\r]/g, ' ').trim(),
                            address: address.replace(/[\n\r]/g, ' ').trim(),
                            city: location.city,
                            state: location.state,
                            zip: location.zip,
                            phone: phone.replace(/[\n\r]/g, ' ').trim(),
                            fax: fax.replace(/[\n\r]/g, ' ').trim(),
                            email: email.replace(/[\n\r]/g, ' ').trim(),
                            website: cleanWebsite(website),
                            services: services.replace(/[\n\r]+/g, ' ').trim(),
                            notes: notes.replace(/[\n\r]+/g, ' ').trim(),
                            island: island.trim(),
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            order: i
                        };

                        await db.collection('resources').add(resource);
                        imported++;
                        updateProgress(imported, rows.length - 1);
                        
                        if (imported % 10 === 0) {
                            log(`Imported ${imported} resources...`);
                        }
                    } catch (err) {
                        log(`‚ùå Error importing row ${i}: ${err.message}`, true);
                        errors++;
                    }
                }

                log(`\n‚úÖ Import complete!`);
                log(`   Imported: ${imported}`);
                log(`   Errors: ${errors}`);

            } catch (error) {
                log('‚ùå Import failed: ' + error.message, true);
            }
        }
    </script>
</body>
</html>
